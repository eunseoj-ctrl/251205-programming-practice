<!doctype html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SDGs × 초음파 센서 문제해결 설계 플랫폼</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src='https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js'></script>
  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: 'Pretendard', 'Noto Sans KR', system-ui, -apple-system, sans-serif;
      background: linear-gradient(135deg, #0f172a 0%, #1e1b4b 50%, #312e81 100%);
      color: #1e293b;
      min-height: 100vh;
      padding: 20px;
      display: flex;
      justify-content: center;
      align-items: center;
      position: relative;
    }
    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: 
        radial-gradient(circle at 20% 50%, rgba(139, 92, 246, 0.15) 0%, transparent 50%),
        radial-gradient(circle at 80% 80%, rgba(99, 102, 241, 0.15) 0%, transparent 50%),
        radial-gradient(circle at 40% 20%, rgba(79, 70, 229, 0.1) 0%, transparent 50%);
      pointer-events: none;
      z-index: 0;
    }

    /* 화면 전환 컨테이너 */
    .view-section {
      display: none;
      width: 100%;
      max-width: 1000px;
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      border-radius: 24px;
      box-shadow: 0 20px 40px rgba(79, 70, 229, 0.2), 0 8px 16px rgba(139, 92, 246, 0.15);
      border: 1px solid rgba(139, 92, 246, 0.2);
      overflow: hidden;
      animation: fadeIn 0.4s cubic-bezier(0.16, 1, 0.3, 1);
      position: relative;
      z-index: 1;
    }
    .view-section.active { 
      display: block; 
    }
    
    /* 인트로 화면 특별 스타일 */
    #view-intro {
      background: transparent;
      box-shadow: none;
      border: none;
      max-width: 100%;
      width: 100%;
      height: 100vh;
      position: fixed;
      top: 0;
      left: 0;
      padding: 0;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    @keyframes batHover {
      0%, 100% { transform: translateY(-50%) translateY(0px); }
      50% { transform: translateY(-50%) translateY(-15px); }
    }

    @keyframes bubbleFloat {
      0%, 100% { transform: translateY(0px); }
      50% { transform: translateY(-5px); }
    }

    /* --- 1. 인트로 & 로그인 스타일 --- */
    #intro-screen {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(135deg, #0f172a 0%, #1e1b4b 50%, #312e81 100%);
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 100;
    }
    
    /* 박쥐 애니메이션 컨테이너 */
    #bat-container {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 1;
    }
    
    .flying-bat {
      position: absolute;
      font-size: 2rem;
      opacity: 0.6;
      animation: flyAround linear infinite;
      will-change: transform;
    }
    
    @keyframes flyAround {
      0% { 
        transform: translate(-10vw, 0) rotate(0deg) scale(1); 
        opacity: 0;
      }
      10% { opacity: 0.8; }
      25% { 
        transform: translate(20vw, -10vh) rotate(10deg) scale(1.1); 
      }
      50% { 
        transform: translate(50vw, 5vh) rotate(0deg) scale(1); 
      }
      75% { 
        transform: translate(80vw, -5vh) rotate(-10deg) scale(0.9); 
      }
      90% { opacity: 0.8; }
      100% { 
        transform: translate(110vw, 0) rotate(0deg) scale(1); 
        opacity: 0;
      }
    }
    
    /* 글래스모피즘 컨텐츠 */
    .intro-content {
      position: relative;
      z-index: 10;
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      border: 1px solid rgba(255, 255, 255, 0.2);
      padding: 60px;
      border-radius: 32px;
      text-align: center;
      box-shadow: 0 25px 50px rgba(0,0,0,0.5);
      max-width: 800px;
      width: 90%;
      animation: popIn 0.8s cubic-bezier(0.34, 1.56, 0.64, 1);
    }
    
    @keyframes popIn {
      from { transform: scale(0.9) translateY(20px); opacity: 0; }
      to { transform: scale(1) translateY(0); opacity: 1; }
    }
    
    /* SweetAlert2 스타일 애니메이션 */
    @keyframes swal2-fade-in {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    
    @keyframes swal2-show {
      from {
        transform: scale(0.7);
        opacity: 0;
      }
      to {
        transform: scale(1);
        opacity: 1;
      }
    }
    
    @keyframes swal2-animate-success-icon {
      0% {
        transform: scale(0);
        opacity: 0;
      }
      50% {
        transform: scale(1.1);
      }
      100% {
        transform: scale(1);
        opacity: 1;
      }
    }
    
    .main-icon {
      font-size: 5rem;
      margin-bottom: 10px;
      display: inline-block;
      animation: float 3s infinite ease-in-out;
    }
    
    @keyframes float {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-10px); }
    }
    
    .intro-title {
      font-size: 3.5rem;
      font-weight: 900;
      color: #ffffff;
      margin-bottom: 10px;
      text-shadow: 0 4px 15px rgba(0,0,0,0.3);
      letter-spacing: -1px;
    }
    
    .intro-subtitle {
      font-size: 1.2rem;
      color: #bfdbfe;
      margin-bottom: 50px;
      font-weight: 300;
    }
    
    .role-cards {
      display: flex;
      gap: 25px;
      justify-content: center;
      flex-wrap: wrap;
    }
    
    .role-card {
      flex: 1;
      min-width: 200px;
      background: rgba(255, 255, 255, 0.85);
      padding: 30px 20px;
      border-radius: 24px;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
      text-align: center;
      border: 2px solid transparent;
      position: relative;
      overflow: hidden;
    }
    
    .role-card:hover {
      transform: translateY(-12px) scale(1.03);
      background: #ffffff;
      box-shadow: 0 20px 40px rgba(0,0,0,0.3);
      border-color: #fbbf24;
    }
    
    .role-card:active {
      transform: scale(0.98);
    }
    
    .role-icon {
      font-size: 48px;
      margin-bottom: 15px;
      display: block;
    }
    
    .role-name {
      font-size: 1.5rem;
      font-weight: 800;
      color: #1e293b;
      margin-bottom: 5px;
    }
    
    .role-desc {
      font-size: 0.95rem;
      color: #64748b;
      font-weight: 500;
    }
    
    /* 기존 intro-wrap (로그인 화면용) */
    .intro-wrap {
      padding: 60px 40px;
      text-align: center;
      max-width: 600px;
      margin: 0 auto;
    }
    .intro-icon { font-size: 60px; margin-bottom: 20px; display: inline-block; }
    .intro-title-alt { 
      font-size: 28px; 
      font-weight: 800; 
      background: linear-gradient(135deg, #8b5cf6, #6366f1);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      margin-bottom: 12px; 
    }
    .intro-desc { color: #cbd5e1; margin-bottom: 40px; font-size: 16px; line-height: 1.6; }
    
    .role-emoji { font-size: 48px; margin-bottom: 15px; display: block; }
    .role-name-alt { font-size: 18px; font-weight: 700; color: #8b5cf6; }
    .role-sub { font-size: 13px; color: #94a3b8; margin-top: 6px; }

    /* 로그인 폼 */
    .login-box { text-align: left; background: rgba(237, 233, 254, 0.5); backdrop-filter: blur(10px); padding: 30px; border-radius: 16px; margin-top: 20px; border: 1px solid rgba(139, 92, 246, 0.2); }
    .input-label { font-size: 14px; font-weight: 700; color: #7c3aed; margin-bottom: 8px; display: block; }
    .input-field {
      width: 100%; padding: 14px; border: 2px solid rgba(139, 92, 246, 0.3); border-radius: 12px; font-size: 16px; margin-bottom: 20px; transition: all 0.2s;
      background: rgba(255, 255, 255, 0.9);
    }
    .input-field:focus { outline: none; border-color: #8b5cf6; background: #fff; box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.1); }
    
    .btn-primary {
      width: 100%; padding: 16px; background: linear-gradient(135deg, #8b5cf6, #6366f1); color: white; border: none; border-radius: 12px;
      font-size: 16px; font-weight: 700; cursor: pointer; transition: all 0.2s;
      box-shadow: 0 4px 6px rgba(139, 92, 246, 0.3);
    }
    .btn-primary:hover { 
      background: linear-gradient(135deg, #7c3aed, #4f46e5); 
      transform: translateY(-1px);
      box-shadow: 0 6px 12px rgba(139, 92, 246, 0.4);
    }
    .btn-text { background: none; border: none; color: #8b5cf6; margin-top: 15px; cursor: pointer; text-decoration: underline; font-size: 14px; }

    /* --- 2. 교사 대시보드 & 설정 --- */
    .dash-header {
      padding: 20px 30px; background: #fff; border-bottom: 1px solid #e2e8f0;
      display: flex; justify-content: space-between; align-items: center;
    }
    .dash-title { font-size: 20px; font-weight: 800; background: linear-gradient(135deg, #8b5cf6, #6366f1); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; display: flex; align-items: center; gap: 8px; }
    .dash-controls { display: flex; gap: 10px; }
    .btn-sm { padding: 8px 16px; border-radius: 8px; font-size: 13px; font-weight: 600; cursor: pointer; border: 1px solid #e2e8f0; background: #fff; color: #475569; transition: all 0.2s; }
    .btn-sm:hover { background: #f1f5f9; transform: translateY(-1px); box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    .btn-sm.danger { color: #ef4444; border-color: #fee2e2; }
    .btn-sm.danger:hover { background: #fef2f2; }

    .dash-content { padding: 30px; background: rgba(237, 233, 254, 0.3); min-height: 500px; overflow-y: visible; }
    
    /* 학급/학생별 관리 스타일 */
    .teacher-tabs {
      display: flex; gap: 8px; padding: 0 30px; background: #fff; border-bottom: 1px solid #e2e8f0;
    }
    .teacher-tab {
      padding: 12px 20px; font-size: 14px; font-weight: 600; cursor: pointer;
      border: none; background: transparent; color: #64748b; border-bottom: 2px solid transparent;
      transition: all 0.2s;
    }
    .teacher-tab.active {
      color: #8b5cf6; border-bottom-color: #8b5cf6; background: rgba(139, 92, 246, 0.05);
    }
    .teacher-tab:hover {
      color: #8b5cf6; background: rgba(139, 92, 246, 0.05);
    }
    
    .management-layout {
      display: flex; min-height: calc(80vh - 100px); background: #fff;
    }
    
    .class-list-panel {
      width: 250px; border-right: 1px solid #e2e8f0; overflow-y: auto;
      background: #f8fafc;
    }
    .class-list-header {
      padding: 15px; border-bottom: 1px solid #e2e8f0; display: flex; justify-content: space-between; align-items: center;
      background: #fff;
    }
    .class-list-title {
      font-size: 14px; font-weight: 700; color: #1e293b;
    }
    .btn-add-class {
      width: 28px; height: 28px; border-radius: 6px; border: 1px solid #cbd5e1;
      background: #fff; color: #64748b; font-size: 18px; cursor: pointer;
      display: flex; align-items: center; justify-content: center;
      transition: all 0.2s;
    }
    .btn-add-class:hover {
      background: #3b82f6; color: white; border-color: #3b82f6;
    }
    
    .class-item {
      padding: 12px 15px; cursor: pointer; border-bottom: 1px solid #f1f5f9;
      transition: background 0.2s; font-size: 13px; font-weight: 600; color: #475569;
    }
    .class-item:hover {
      background: #ede9fe;
    }
    .class-item.active {
      background: #e9d5ff; color: #6d28d9; border-left: 3px solid #8b5cf6;
    }
    
    .student-list-panel {
      width: 280px; border-right: 1px solid #e2e8f0; overflow-y: auto;
      background: #f8fafc;
    }
    .student-list-header {
      padding: 15px; border-bottom: 1px solid #e2e8f0; background: #fff;
      font-size: 14px; font-weight: 700; color: #1e293b;
    }
    .student-item {
      padding: 12px 15px; cursor: pointer; border-bottom: 1px solid #f1f5f9;
      transition: background 0.2s; font-size: 13px; color: #475569;
      display: flex; justify-content: space-between; align-items: center;
    }
    .student-item:hover {
      background: #e0e7ff;
    }
    .student-item.active {
      background: #dbeafe; color: #1e40af; border-left: 3px solid #3b82f6;
    }
    .student-badge {
      font-size: 11px; padding: 2px 8px; border-radius: 10px;
      background: #fee2e2; color: #991b1b; font-weight: 600;
    }
    .student-actions {
      display: flex; gap: 5px; align-items: center;
    }
    .btn-delete-student {
      padding: 4px 8px; font-size: 11px; background: #fee2e2; color: #991b1b;
      border: none; border-radius: 6px; cursor: pointer; font-weight: 600;
      transition: all 0.2s;
    }
    .btn-delete-student:hover {
      background: #fecaca; transform: scale(1.05);
    }
    
    .student-content-panel {
      flex: 1; overflow-y: visible; background: #fff; padding: 30px;
    }
    .student-worksheet {
      background: white; border-radius: 16px; padding: 30px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05); max-width: 800px; margin: 0 auto;
    }
    .worksheet-header {
      border-bottom: 2px solid #e2e8f0; padding-bottom: 20px; margin-bottom: 30px;
      display: flex; justify-content: space-between; align-items: center;
    }
    .worksheet-title {
      font-size: 24px; font-weight: 800; color: #1e293b;
    }
    .worksheet-status {
      padding: 6px 16px; border-radius: 20px; font-size: 13px; font-weight: 600;
    }
    .worksheet-status.pending { background: #fffbeb; color: #b45309; }
    .worksheet-status.approved { background: #dcfce7; color: #15803d; }
    .worksheet-status.rejected { background: #fef2f2; color: #b91c1c; }
    
    .worksheet-section {
      margin-bottom: 30px;
    }
    .worksheet-label {
      font-size: 12px; font-weight: 700; color: #64748b; text-transform: uppercase;
      letter-spacing: 0.5px; margin-bottom: 8px;
    }
    .worksheet-value {
      font-size: 15px; color: #1e293b; line-height: 1.6;
      padding: 12px; background: #f8fafc; border-radius: 8px; border: 1px solid #e2e8f0;
    }
    
    .worksheet-feedback {
      margin-top: 30px; padding-top: 30px; border-top: 2px solid #e2e8f0;
    }
    .worksheet-feedback-input {
      width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 8px;
      font-size: 14px; margin-bottom: 15px; min-height: 80px; resize: vertical;
    }
    .worksheet-actions {
      display: flex; gap: 10px;
    }
    .worksheet-btn {
      flex: 1; padding: 12px; border-radius: 8px; border: none;
      font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.2s;
    }
    .worksheet-btn.approve {
      background: #dcfce7; color: #15803d;
    }
    .worksheet-btn.approve:hover {
      background: #bbf7d0;
    }
    .worksheet-btn.reject {
      background: #fee2e2; color: #991b1b;
    }
    .worksheet-btn.reject:hover {
      background: #fecaca;
    }
    
    .empty-state {
      text-align: center; padding: 60px 20px; color: #94a3b8;
    }
    .empty-state-icon {
      font-size: 48px; margin-bottom: 15px;
    }
    .teacher-config-box { background: #fff; padding: 25px; border-radius: 16px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
    .prompt-editor {
      width: 100%; height: 150px; padding: 15px; border: 2px solid #e2e8f0; border-radius: 12px;
      font-family: monospace; font-size: 14px; resize: vertical; line-height: 1.5;
      background: #f8fafc; color: #334155;
    }
    .prompt-editor:focus { border-color: #8b5cf6; background: #fff; outline: none; }

    /* 대시보드 카드 그리드 */
    .submission-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 20px; }
    .sub-card {
      background: white; border-radius: 16px; padding: 20px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.02); border: 1px solid #e2e8f0;
      display: flex; flex-direction: column; gap: 12px; position: relative;
      transition: transform 0.2s;
    }
    .sub-card:hover { transform: translateY(-2px); box-shadow: 0 8px 16px rgba(0,0,0,0.05); }
    .sub-card.approved { border-top: 4px solid #8b5cf6; background: rgba(237, 233, 254, 0.5); }
    .sub-card.rejected { border-top: 4px solid #ef4444; }
    .sub-card.pending { border-top: 4px solid #f59e0b; }

    .sub-meta { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #f1f5f9; padding-bottom: 10px; }
    .sub-user { font-weight: 700; font-size: 16px; color: #0f172a; }
    .sub-badge { font-size: 11px; font-weight: 700; padding: 4px 10px; border-radius: 99px; text-transform: uppercase; }
    .badge-pending { background: #fffbeb; color: #b45309; }
    .badge-approved { background: #dcfce7; color: #15803d; }
    .badge-rejected { background: #fef2f2; color: #b91c1c; }

    .sub-body { font-size: 13px; color: #475569; display: flex; flex-direction: column; gap: 8px; }
    .sub-row label { font-size: 11px; font-weight: 700; color: #94a3b8; display: block; margin-bottom: 2px; }
    .sub-row p { margin: 0; line-height: 1.4; }

    .feedback-area { margin-top: auto; padding-top: 10px; border-top: 1px solid #f1f5f9; }
    .feedback-input { width: 100%; padding: 8px 12px; border: 1px solid #cbd5e1; border-radius: 8px; font-size: 13px; margin-bottom: 8px; }
    .action-group { display: flex; gap: 8px; }
    .action-btn { flex: 1; padding: 8px; border-radius: 6px; border: none; font-weight: 700; cursor: pointer; font-size: 12px; }
    .btn-approve { background: #dcfce7; color: #15803d; }
    .btn-reject { background: #fee2e2; color: #991b1b; }
    .btn-approve:hover { background: #bbf7d0; }
    .btn-reject:hover { background: #fecaca; }

    /* --- 3. 학생 캔버스 UI --- */
    .app-inner { padding: 30px; position: relative; display: flex; flex-direction: column; height: 90vh; }
    
    /* 상단 배너 */
    .status-banner {
      background: linear-gradient(135deg, #0f172a, #1e293b); color: white; padding: 12px 20px;
      font-size: 14px; font-weight: 600; display: flex; justify-content: space-between; align-items: center;
      margin: -30px -30px 20px -30px; /* Full width */
    }
    .status-banner.approved { background: linear-gradient(135deg, #8b5cf6, #7c3aed); }
    .status-banner.rejected { background: linear-gradient(135deg, #ef4444, #dc2626); }
    .status-banner.pending { background: linear-gradient(135deg, #f59e0b, #eab308); }

    .header { display: flex; align-items: center; gap: 12px; margin-bottom: 20px; }
    .header-icon { width: 44px; height: 44px; background: linear-gradient(135deg, #8b5cf6, #6366f1); border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 24px; color: white; box-shadow: 0 4px 12px rgba(139, 92, 246, 0.3); }
    .header h1 { margin: 0; font-size: 20px; font-weight: 800; color: #1e293b; }
    .user-tag { margin-left: auto; background: rgba(139, 92, 246, 0.1); color: #7c3aed; padding: 6px 12px; border-radius: 20px; font-size: 13px; font-weight: 700; border: 1px solid rgba(139, 92, 246, 0.2); }

    .scroll-area { flex: 1; overflow-y: auto; padding-right: 5px; padding-bottom: 20px; }

    /* 스텝 UI */
    .progress-nav { display: flex; gap: 5px; margin-bottom: 20px; }
    .prog-step { flex: 1; height: 6px; background: #e2e8f0; border-radius: 3px; position: relative; }
    .prog-step.active { background: linear-gradient(90deg, #8b5cf6, #6366f1); }
    .prog-step.done { background: #8b5cf6; }

    .step-container { display: none; animation: fadeIn 0.3s; }
    .step-container.active { display: block; }
    .design-section { display: block; animation: fadeIn 0.3s; }
    .step-header { margin-bottom: 15px; }
    .step-title { font-size: 18px; font-weight: 700; color: #1e293b; margin-bottom: 5px; }
    .step-desc { font-size: 14px; color: #64748b; }

    /* 폼 요소 */
    .form-group { margin-bottom: 20px; }
    .label { font-size: 13px; font-weight: 700; color: #475569; margin-bottom: 6px; display: block; }
    .text-area { width: 100%; border: 2px solid #e2e8f0; border-radius: 12px; padding: 12px; font-size: 15px; resize: vertical; min-height: 100px; transition: border-color 0.2s; }
    .text-area:focus { outline: none; border-color: #8b5cf6; box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.1); }
    .select-box { width: 100%; border: 2px solid #e2e8f0; border-radius: 12px; padding: 12px; font-size: 15px; background: white; }
    .input-line { width: 100%; border: 2px solid #e2e8f0; border-radius: 12px; padding: 12px; font-size: 15px; }

    /* 예시 버튼 */
    .helper-btn { background: #fff7ed; color: #ea580c; border: 1px dashed #fdba74; padding: 8px 16px; border-radius: 20px; font-size: 13px; font-weight: 600; cursor: pointer; display: inline-flex; align-items: center; gap: 5px; margin-bottom: 15px; }
    .helper-btn:hover { background: #ffedd5; }

    /* 채팅 피드백 */
    .chat-box { background: linear-gradient(135deg, #0f172a 0%, #1e1b4b 50%, #312e81 100%); border: 2px solid rgba(139, 92, 246, 0.3); border-radius: 16px; padding: 20px; margin-top: 20px; max-height: 600px; overflow-y: auto; display: flex; flex-direction: column; gap: 12px; box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2); }
    .chat-bubble { max-width: 90%; padding: 10px 14px; border-radius: 12px; font-size: 14px; line-height: 1.5; }
    .chat-ai { align-self: flex-start; background: #fff; border: 1px solid #cbd5e1; color: #334155; border-bottom-left-radius: 2px; }
    
    /* AI 설계 코치 피드백 스타일 */
    .ai-coach-container {
      background: rgba(255, 255, 255, 0.95);
      border-radius: 16px;
      padding: 24px;
      margin-bottom: 16px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      width: 100%;
      box-sizing: border-box;
    }
    
    .ai-coach-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 8px;
      padding-bottom: 12px;
      border-bottom: 2px solid #e2e8f0;
    }
    
    .ai-coach-header h3 {
      font-size: 18px;
      font-weight: 800;
      color: #1e293b;
      margin: 0;
    }
    
    .ai-coach-description {
      font-size: 13px;
      color: #64748b;
      margin-bottom: 20px;
      line-height: 1.6;
    }
    
    .feedback-section {
      margin-bottom: 20px;
    }
    
    .feedback-section-title {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 15px;
      font-weight: 700;
      color: #475569;
      margin-bottom: 12px;
      padding: 8px 12px;
      background: rgba(248, 250, 252, 0.8);
      border-radius: 8px;
      border-left: 4px solid;
    }
    
    .feedback-section-title.improvements {
      border-left-color: #f59e0b;
      color: #92400e;
    }
    
    .feedback-section-title.questions {
      border-left-color: #6366f1;
      color: #4338ca;
    }
    
    .feedback-item {
      padding: 12px 16px;
      margin-bottom: 10px;
      background: #fff;
      border-radius: 8px;
      border-left: 3px solid #e2e8f0;
      font-size: 14px;
      line-height: 1.6;
      color: #334155;
      transition: all 0.2s;
    }
    
    .feedback-item:hover {
      border-left-color: #8b5cf6;
      box-shadow: 0 2px 8px rgba(139, 92, 246, 0.1);
    }
    
    .feedback-item.improvement {
      border-left-color: #fbbf24;
      background: rgba(254, 243, 199, 0.3);
    }
    
    .feedback-item.question {
      border-left-color: #818cf8;
      background: rgba(238, 242, 255, 0.5);
    }
    
    .general-feedback {
      padding: 12px 16px;
      margin-bottom: 16px;
      background: rgba(248, 250, 252, 0.8);
      border-radius: 8px;
      font-size: 14px;
      line-height: 1.6;
      color: #475569;
    }
    .chat-user { align-self: flex-end; background: linear-gradient(135deg, #8b5cf6, #6366f1); color: white; border-bottom-right-radius: 2px; }
    .chat-warn { background: #fef2f2; border: 1px solid #fecaca; color: #991b1b; align-self: flex-start; }
    .chat-success { background: #f0fdf4; border: 1px solid #bbf7d0; color: #166534; align-self: flex-start; }

    .bottom-nav { margin-top: auto; padding-top: 20px; border-top: 1px solid #f1f5f9; display: flex; justify-content: flex-end; gap: 10px; }
    .nav-btn { padding: 10px 24px; border-radius: 10px; font-weight: 700; border: none; cursor: pointer; font-size: 14px; transition: all 0.2s; }
    .btn-back { background: #f1f5f9; color: #64748b; }
    .btn-next { background: linear-gradient(135deg, #8b5cf6, #6366f1); color: white; box-shadow: 0 4px 6px rgba(139, 92, 246, 0.3); }
    .btn-check { background: linear-gradient(135deg, #6366f1, #4f46e5); color: white; box-shadow: 0 4px 6px rgba(99, 102, 241, 0.3); }
    .btn-submit { background: linear-gradient(135deg, #8b5cf6, #7c3aed); color: white; box-shadow: 0 4px 6px rgba(139, 92, 246, 0.2); }
    .nav-btn:disabled { opacity: 0.5; cursor: not-allowed; }
    
    /* 페이지 네비게이션 바 (이전/다음 페이지 이동) */
    .page-navigation {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px 30px;
      margin-top: 30px;
      border-top: 2px solid rgba(139, 92, 246, 0.2);
      background: rgba(248, 250, 252, 0.5);
      border-radius: 0 0 24px 24px;
    }
    
    .nav-prev-btn, .nav-next-btn {
      padding: 12px 28px;
      border-radius: 10px;
      font-weight: 700;
      border: none;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.2s;
    }
    
    .nav-prev-btn {
      background: #f1f5f9;
      color: #475569;
      border: 2px solid #e2e8f0;
    }
    
    .nav-prev-btn:hover:not(:disabled) {
      background: #e2e8f0;
      transform: translateX(-2px);
    }
    
    .nav-prev-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    .nav-next-btn {
      background: linear-gradient(135deg, #8b5cf6, #6366f1);
      color: white;
      box-shadow: 0 4px 12px rgba(139, 92, 246, 0.4);
    }
    
    .nav-next-btn:hover:not(:disabled) {
      transform: translateX(2px);
      box-shadow: 0 6px 16px rgba(139, 92, 246, 0.5);
    }
    
    .nav-next-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      background: #e2e8f0;
      color: #94a3b8;
      box-shadow: none;
    }

    /* 센서 가이드 & 카드 */
    .sensor-tip { background: rgba(237, 233, 254, 0.6); border-left: 4px solid #8b5cf6; padding: 12px 16px; border-radius: 8px; font-size: 13px; color: #6d28d9; margin-bottom: 20px; line-height: 1.5; }
    .dual-cols { display: flex; gap: 15px; }
    .col-card { flex: 1; background: #fff; border: 1px solid #e2e8f0; border-radius: 12px; padding: 15px; }
    .col-header { font-size: 12px; font-weight: 700; text-transform: uppercase; margin-bottom: 8px; color: #64748b; }
    .col-card.on { border-top: 3px solid #8b5cf6; }
    .col-card.off { border-top: 3px solid #f59e0b; }

    @media (max-width: 600px) { .dual-cols { flex-direction: column; } }
    
    /* --- SDGs 커스텀 드롭다운 스타일 --- */
    .sdg-container {
      display: flex;
      gap: 16px;
      align-items: stretch;
      background: #fff;
      padding: 16px;
      border: 2px solid #e2e8f0;
      border-radius: 12px;
      box-sizing: border-box;
      margin-top: 10px;
      max-width: 900px;
    }
    
    .sdg-image-box {
      flex: 0 0 340px;
      height: 200px;
      border-radius: 8px;
      overflow: hidden;
      border: 1px solid #e2e8f0;
      background-color: #fff;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .sdg-image-box img {
      width: 100%;
      height: 100%;
      object-fit: contain;
      padding: 5px;
      box-sizing: border-box;
    }
    
    .sdg-right-area {
      flex: 1;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      gap: 10px;
      min-width: 300px;
    }
    
    .select-wrapper {
      position: relative;
    }
    
    .select-trigger {
      display: flex;
      align-items: center;
      justify-content: space-between;
      width: 100%;
      padding: 10px 14px;
      background: #fff;
      border: 2px solid #e2e8f0;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      box-sizing: border-box;
      font-weight: 500;
      height: 42px;
      transition: all 0.2s;
    }
    
    .select-trigger:hover {
      border-color: #8b5cf6;
      background-color: #f8fafc;
    }
    
    .select-trigger::after {
      content: '';
      border-top: 5px solid #64748b;
      border-left: 4px solid transparent;
      border-right: 4px solid transparent;
      margin-left: 10px;
      transition: transform 0.2s;
    }
    
    .select-trigger.open::after {
      transform: rotate(180deg);
      border-top-color: #8b5cf6;
    }
    
    .select-options {
      display: none;
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      margin-top: 4px;
      background: #fff;
      border: 2px solid #e2e8f0;
      border-radius: 8px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
      z-index: 100;
      max-height: 250px;
      overflow-y: auto;
    }
    
    .select-options.open {
      display: block;
    }
    
    .select-options::-webkit-scrollbar {
      width: 8px;
    }
    
    .select-options::-webkit-scrollbar-thumb {
      background: #cbd5e1;
      border-radius: 4px;
    }
    
    .option-item {
      padding: 10px 14px;
      border-bottom: 1px solid #f1f5f9;
      cursor: pointer;
      transition: background 0.1s;
    }
    
    .option-item:hover {
      background-color: rgba(139, 92, 246, 0.08);
    }
    
    .opt-title {
      font-weight: 700;
      font-size: 13px;
      margin-bottom: 0;
      line-height: 1.4;
      color: #333;
    }
    
    .info-box {
      flex: 1;
      background-color: #f8fafc;
      border-radius: 8px;
      padding: 15px 20px;
      border: 1px solid #e2e8f0;
      display: flex;
      flex-direction: column;
      justify-content: center;
      transition: all 0.3s;
      min-height: 80px;
    }
    
    .info-box.active {
      background-color: #fff;
      border: 2px solid;
      border-left-width: 6px;
    }
    
    .info-text {
      font-size: 14px;
      line-height: 1.6;
      color: #333;
      word-break: keep-all;
      font-weight: 500;
      letter-spacing: -0.02em;
    }
    
    .placeholder-text {
      text-align: center;
      color: #64748b;
      font-size: 13px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
    }
    
    @media (max-width: 900px) {
      .sdg-container {
        flex-direction: column;
      }
      .sdg-image-box {
        flex: 0 0 auto;
        width: 100%;
        max-width: 100%;
        height: auto;
        min-height: 200px;
      }
    }
    
    /* --- 센서 & 반응 설계 통합 UI 스타일 --- */
    .threshold-row {
      display: flex;
      align-items: center;
      gap: 10px;
      background: rgba(237, 233, 254, 0.6);
      padding: 14px 16px;
      border-radius: 10px;
      margin-bottom: 20px;
      font-size: 15px;
      color: #6d28d9;
      border: 2px solid rgba(139, 92, 246, 0.3);
    }
    
    .threshold-input {
      width: 70px;
      padding: 8px;
      border: 2px solid #8b5cf6;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 700;
      text-align: center;
      color: #7c3aed;
      background: #fff;
    }
    
    .threshold-input:focus {
      outline: none;
      box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.1);
    }
    
    .sensor-design-cards {
      display: flex;
      gap: 16px;
      margin-bottom: 20px;
    }
    
    .sensor-card {
      flex: 1;
      border-radius: 12px;
      overflow: hidden;
      border: 2px solid;
      background: #fff;
    }
    
    .sensor-card.when-true {
      border-color: #22c55e;
    }
    
    .sensor-card.when-false {
      border-color: #f97316;
    }
    
    .sensor-card-header {
      padding: 12px 14px;
      font-weight: 700;
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .sensor-card.when-true .sensor-card-header {
      background: #dcfce7;
      color: #166534;
    }
    
    .sensor-card.when-false .sensor-card-header {
      background: #ffedd5;
      color: #9a3412;
    }
    
    .header-value {
      background: rgba(255, 255, 255, 0.7);
      padding: 2px 8px;
      border-radius: 6px;
      font-weight: 800;
    }
    
    .sensor-card-body {
      padding: 14px;
      background: #fff;
    }
    
    .situation-box {
      background: #fffbeb;
      border: 1px solid #fde68a;
      border-radius: 8px;
      padding: 12px;
      margin-bottom: 12px;
    }
    
    .situation-box.false {
      background: #fef2f2;
      border-color: #fecaca;
    }
    
    .situation-label {
      font-size: 12px;
      font-weight: 700;
      color: #b45309;
      margin-bottom: 6px;
      display: flex;
      align-items: center;
      gap: 4px;
    }
    
    .situation-box.false .situation-label {
      color: #b91c1c;
    }
    
    .situation-input {
      width: 100%;
      border: none;
      background: transparent;
      font-size: 14px;
      color: #78350f;
      outline: none;
      resize: none;
      min-height: 36px;
      font-family: inherit;
      line-height: 1.4;
    }
    
    .situation-box.false .situation-input {
      color: #7f1d1d;
    }
    
    .situation-input::placeholder {
      color: #d4a574;
    }
    
    .action-title {
      font-size: 12px;
      font-weight: 700;
      color: #64748b;
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 4px;
    }
    
    .action-list {
      margin-bottom: 8px;
    }
    
    .action-row {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 8px;
      flex-wrap: wrap;
    }
    
    .action-row select {
      padding: 8px 10px;
      border: 2px solid #e2e8f0;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      background: #fff;
      cursor: pointer;
      color: #333;
      transition: all 0.2s;
    }
    
    .action-row select:focus {
      outline: none;
      border-color: #8b5cf6;
      box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.1);
    }
    
    .custom-device-input {
      padding: 8px 10px;
      border: 2px solid #8b5cf6;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      color: #7c3aed;
      width: 120px;
      display: none;
    }
    
    .custom-device-input:focus {
      outline: none;
      box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.1);
    }
    
    .custom-device-input::placeholder {
      color: #a5b4fc;
      font-weight: 400;
    }
    
    .action-row input.action-detail {
      flex: 1;
      padding: 8px 10px;
      border: 2px solid #e2e8f0;
      border-radius: 8px;
      font-size: 14px;
      min-width: 80px;
      transition: all 0.2s;
    }
    
    .action-row input.action-detail:focus {
      outline: none;
      border-color: #8b5cf6;
      box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.1);
    }
    
    .action-row input::placeholder {
      color: #94a3b8;
    }
    
    .btn-remove-action {
      background: none;
      border: none;
      font-size: 18px;
      color: #cbd5e1;
      cursor: pointer;
      padding: 4px;
      transition: all 0.2s;
      width: 28px;
      height: 28px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 4px;
    }
    
    .btn-remove-action:hover {
      color: #ef4444;
      background: rgba(239, 68, 68, 0.1);
    }
    
    .btn-add-action {
      width: 100%;
      padding: 10px;
      border: 2px dashed #cbd5e1;
      border-radius: 8px;
      background: #f8fafc;
      color: #64748b;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      margin-top: 4px;
      transition: all 0.2s;
    }
    
    .btn-add-action:hover {
      border-color: #8b5cf6;
      color: #8b5cf6;
      background: rgba(139, 92, 246, 0.05);
    }
    
    .preview-box {
      margin-top: 24px;
      background: linear-gradient(135deg, #1e293b, #334155);
      border-radius: 12px;
      padding: 20px;
      color: #e2e8f0;
      font-family: 'Courier New', ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
      font-size: 13px;
      line-height: 1.8;
      border: 2px solid rgba(139, 92, 246, 0.2);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }
    
    .preview-box .kw {
      color: #fbbf24;
      font-weight: 700;
    }
    
    .preview-box .cond {
      color: #60a5fa;
    }
    
    .preview-box .situation {
      color: #fcd34d;
      font-style: italic;
    }
    
    .preview-box .act {
      color: #a5f3fc;
    }
    
    @media (max-width: 800px) {
      .sensor-design-cards {
        flex-direction: column;
      }
    }
    
    /* --- 아이디어 선정 페이지 스타일 --- */
    .idea-selection-container {
      max-width: 1000px;
      margin: 0 auto;
    }
    
    .member-setup {
      background: rgba(237, 233, 254, 0.6);
      border: 2px solid rgba(139, 92, 246, 0.3);
      border-radius: 12px;
      padding: 15px 20px;
      margin-bottom: 25px;
    }
    
    .member-setup-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
      flex-wrap: wrap;
      gap: 10px;
    }
    
    .member-setup-header h3 {
      font-size: 15px;
      font-weight: 700;
      color: #6d28d9;
    }
    
    .member-input-group {
      display: flex;
      gap: 10px;
    }
    
    .member-input-group input {
      padding: 8px 12px;
      border: 2px solid #e2e8f0;
      border-radius: 8px;
      font-size: 14px;
      width: 150px;
      transition: all 0.2s;
    }
    
    .member-input-group input:focus {
      outline: none;
      border-color: #8b5cf6;
      box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.1);
    }
    
    .member-input-group button {
      padding: 8px 15px;
      background: linear-gradient(135deg, #8b5cf6, #6366f1);
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 13px;
      font-weight: 600;
      transition: all 0.2s;
    }
    
    .member-input-group button:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 8px rgba(139, 92, 246, 0.3);
    }
    
    .member-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }
    
    .member-tag {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 6px 12px;
      background: rgba(139, 92, 246, 0.1);
      color: #7c3aed;
      border-radius: 20px;
      font-size: 13px;
      font-weight: 600;
      border: 1px solid rgba(139, 92, 246, 0.2);
    }
    
    .member-tag button {
      background: none;
      border: none;
      color: #7c3aed;
      cursor: pointer;
      font-size: 16px;
      opacity: 0.6;
      line-height: 1;
      transition: opacity 0.2s;
    }
    
    .member-tag button:hover {
      opacity: 1;
    }
    
    .tab-nav {
      display: flex;
      border: 2px solid #e2e8f0;
      border-radius: 12px;
      overflow: hidden;
      margin-bottom: 25px;
      background: #fff;
    }
    
    .tab-btn {
      flex: 1;
      padding: 14px 20px;
      border: none;
      background: white;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      color: #64748b;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      border-right: 1px solid #e2e8f0;
    }
    
    .tab-btn:last-child {
      border-right: none;
    }
    
    .tab-btn:hover {
      background: rgba(139, 92, 246, 0.05);
      color: #8b5cf6;
    }
    
    .tab-btn.active {
      background: linear-gradient(135deg, #8b5cf6, #6366f1);
      color: white;
    }
    
    .tab-content {
      display: none;
    }
    
    .tab-content.active {
      display: block;
    }
    
    .pmi-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 15px;
      margin-bottom: 20px;
    }
    
    @media (max-width: 768px) {
      .pmi-grid {
        grid-template-columns: 1fr;
      }
      .management-layout {
        flex-direction: column;
      }
    }
    
    /* --- 마이크로비트 닥터 페이지 스타일 --- */
    .step-section-doctor {
      background: #fff;
      border-radius: 16px;
      padding: 30px;
      margin-bottom: 30px;
      border: 2px solid rgba(139, 92, 246, 0.2);
      position: relative;
      transition: transform 0.2s;
      box-shadow: 0 2px 8px rgba(139, 92, 246, 0.1);
    }
    .step-section-doctor:hover {
      border-color: rgba(139, 92, 246, 0.4);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(139, 92, 246, 0.15);
    }
    .step-badge-doctor {
      position: absolute;
      top: -15px;
      left: 20px;
      background: linear-gradient(135deg, #8b5cf6, #6366f1);
      color: white;
      padding: 5px 15px;
      border-radius: 20px;
      font-weight: bold;
      font-size: 0.9rem;
      box-shadow: 0 4px 10px rgba(139, 92, 246, 0.4);
    }
    .step-section-doctor h2 {
      margin-top: 10px;
      font-size: 1.5rem;
      color: #1e293b;
    }
    .description-doctor {
      color: #64748b;
      font-size: 0.95rem;
      margin-bottom: 20px;
    }
    
    /* 이미지 업로드 영역 */
    .image-upload-area-doctor {
      border: 2px dashed rgba(139, 92, 246, 0.3);
      border-radius: 12px;
      padding: 30px;
      text-align: center;
      cursor: pointer;
      transition: 0.2s;
      margin-bottom: 15px;
      background: rgba(237, 233, 254, 0.3);
    }
    .image-upload-area-doctor:hover {
      border-color: #8b5cf6;
      background: rgba(237, 233, 254, 0.5);
    }
    .image-upload-area-doctor.dragover {
      border-color: #8b5cf6;
      background: rgba(139, 92, 246, 0.1);
    }
    .image-preview-doctor {
      max-width: 100%;
      max-height: 300px;
      border-radius: 8px;
      margin-top: 10px;
      border: 2px solid rgba(139, 92, 246, 0.2);
    }
    
    /* 핀 표시 */
    .pin-display-doctor {
      display: flex;
      gap: 15px;
      justify-content: center;
      margin-top: 20px;
      padding: 15px;
      background: rgba(237, 233, 254, 0.3);
      border-radius: 12px;
    }
    .pin-circle-doctor {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      background: #fff;
      border: 2px solid rgba(139, 92, 246, 0.3);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      color: #64748b;
      position: relative;
      transition: all 0.2s;
    }
    .pin-circle-doctor.active {
      border-color: #8b5cf6;
      color: #8b5cf6;
      background: rgba(139, 92, 246, 0.1);
      transform: scale(1.1);
      box-shadow: 0 4px 12px rgba(139, 92, 246, 0.3);
    }
    .pin-number-doctor {
      font-size: 1.2rem;
      line-height: 1;
      margin-bottom: 2px;
    }
    .pin-prefix-doctor {
      position: absolute;
      top: 5px;
      font-size: 0.7rem;
      line-height: 1;
    }
    .pin-label-doctor {
      font-size: 0.7rem;
      margin-top: 8px;
      line-height: 1;
    }
    
    /* OCR 결과 스타일 */
    .ocr-result-box {
      margin-top: 15px;
      padding: 15px;
      border-radius: 8px;
      font-size: 0.95rem;
      line-height: 1.6;
    }
    .ocr-error {
      background: rgba(239, 68, 68, 0.1);
      color: #dc2626;
      border-left: 4px solid #ef4444;
    }
    .ocr-warning {
      background: rgba(251, 191, 36, 0.1);
      color: #d97706;
      border-left: 4px solid #fbbf24;
    }
    .ocr-success {
      background: rgba(16, 185, 129, 0.1);
      color: #059669;
      border-left: 4px solid #10b981;
    }
    .ocr-info {
      background: rgba(139, 92, 246, 0.1);
      color: #7c3aed;
      border-left: 4px solid #8b5cf6;
    }
    .loader {
      border: 4px solid rgba(139, 92, 246, 0.2);
      border-top: 4px solid #8b5cf6;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      animation: spin 2s linear infinite;
      display: inline-block;
      vertical-align: middle;
      margin-right: 10px;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    /* 시뮬레이터 컨트롤 */
    .simulator-controls-doctor {
      margin-bottom: 15px;
      background: rgba(237, 233, 254, 0.3);
      padding: 15px 20px;
      border-radius: 12px;
      display: flex;
      gap: 15px;
      align-items: center;
      flex-wrap: wrap;
      justify-content: center;
    }
    #simulator-feedback-msg {
      font-size: 1rem;
      font-weight: bold;
      color: #1e293b;
      min-width: 250px;
      text-align: center;
    }
    .simulator-canvas-container-doctor {
      position: relative;
      box-shadow: 0 10px 20px rgba(0,0,0,0.15);
      border-radius: 12px;
      overflow: hidden;
      background: white;
      cursor: crosshair;
      margin: 0 auto;
      max-width: 950px;
      border: 2px solid rgba(139, 92, 246, 0.2);
    }
    #simCanvas {
      touch-action: none;
      display: block;
      width: 100%;
      height: auto;
    }
    
    /* 버튼 스타일 */
    .btn-primary-doctor {
      width: 100%;
      padding: 14px 24px;
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 1rem;
      font-weight: bold;
      cursor: pointer;
      transition: 0.2s;
      margin-top: 15px;
    }
    .btn-primary-doctor:hover {
      filter: brightness(1.1);
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(139, 92, 246, 0.4);
    }
    .btn-outline-doctor {
      background: transparent;
      border: 2px solid #8b5cf6;
      color: #8b5cf6;
      padding: 8px 16px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      transition: 0.2s;
    }
    .btn-outline-doctor:hover {
      background: #8b5cf6;
      color: white;
    }
    
    /* 상태 카드 */
    .status-grid-doctor {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
      margin-top: 20px;
    }
    .status-card-doctor {
      background: rgba(237, 233, 254, 0.3);
      padding: 20px;
      border-radius: 12px;
      text-align: center;
      border: 2px solid rgba(139, 92, 246, 0.2);
    }
    .status-icon-doctor {
      font-size: 2rem;
      margin-bottom: 10px;
      display: block;
    }
    .status-val-doctor {
      font-size: 1.5rem;
      font-weight: bold;
      color: #1e293b;
    }
    
    /* 그래프 영역 */
    .chart-container-doctor {
      background: rgba(237, 233, 254, 0.3);
      padding: 20px;
      border-radius: 12px;
      margin-top: 20px;
      border: 2px solid rgba(139, 92, 246, 0.2);
    }
    .chart-title-doctor {
      font-size: 1rem;
      color: #64748b;
      margin-bottom: 15px;
      text-align: center;
      font-weight: 700;
    }
    
    @media (max-width: 600px) {
      .status-grid-doctor {
        grid-template-columns: 1fr;
      }
      .simulator-controls-doctor {
        flex-direction: column;
        align-items: stretch;
      }
      #simulator-feedback-msg {
        min-width: auto;
      }
      #simCanvas {
        width: 100% !important;
        height: auto !important;
      }
    }
    
    .pmi-box {
      border-radius: 12px;
      overflow: hidden;
      border: 2px solid;
      background: #fff;
    }
    
    .pmi-box .pmi-header {
      padding: 12px 15px;
      font-weight: 700;
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    
    .pmi-box.plus .pmi-header {
      background: #ffebee;
      color: #c62828;
      border-color: #ffcdd2;
    }
    
    .pmi-box.minus .pmi-header {
      background: #fff8e1;
      color: #f57f17;
      border-color: #ffe082;
    }
    
    .pmi-box.interesting .pmi-header {
      background: #e8f5e9;
      color: #2e7d32;
      border-color: #c8e6c9;
    }
    
    .pmi-box textarea {
      width: 100%;
      min-height: 120px;
      padding: 15px;
      border: none;
      border-top: 2px solid;
      border-radius: 0;
      resize: vertical;
      font-size: 14px;
      font-family: inherit;
      transition: all 0.2s;
    }
    
    .pmi-box.plus textarea {
      border-top-color: #ffcdd2;
    }
    
    .pmi-box.minus textarea {
      border-top-color: #ffe082;
    }
    
    .pmi-box.interesting textarea {
      border-top-color: #c8e6c9;
    }
    
    .pmi-box textarea:focus {
      outline: none;
      box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.1);
    }
    
    .selection-save-btn {
      width: 100%;
      padding: 15px;
      background: linear-gradient(135deg, #8b5cf6, #6366f1);
      color: white;
      border: none;
      border-radius: 12px;
      font-size: 15px;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.3s;
      box-shadow: 0 4px 6px rgba(139, 92, 246, 0.3);
    }
    
    .selection-save-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 6px 12px rgba(139, 92, 246, 0.4);
    }
    
    .selection-alert {
      padding: 12px 20px;
      border-radius: 8px;
      margin-top: 15px;
      display: none;
      align-items: center;
      gap: 10px;
      font-size: 14px;
      background: rgba(237, 233, 254, 0.8);
      color: #6d28d9;
      border: 2px solid rgba(139, 92, 246, 0.3);
    }
    
    .selection-alert.show {
      display: flex;
    }
    
    .result-section {
      margin-top: 30px;
      border-top: 2px solid #e2e8f0;
      padding-top: 25px;
    }
    
    .result-section h3 {
      font-size: 16px;
      font-weight: 700;
      color: #475569;
      margin-bottom: 15px;
    }
    
    .result-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 14px;
      background: #fff;
      border-radius: 12px;
      overflow: hidden;
      border: 2px solid #e2e8f0;
      table-layout: fixed;
    }
    
    .result-table th,
    .result-table td {
      padding: 14px 12px;
      text-align: left;
      border-bottom: 1px solid #f1f5f9;
      vertical-align: top;
      word-wrap: break-word;
    }
    
    .result-table th {
      background: rgba(139, 92, 246, 0.1);
      font-weight: 700;
      color: #6d28d9;
      white-space: nowrap;
    }
    
    .result-table th:nth-child(1) {
      width: 50px;
      text-align: center;
    }
    
    .result-table th:nth-child(2) {
      width: 180px;
      min-width: 150px;
    }
    
    .result-table th:nth-child(3) {
      width: 110px;
      min-width: 90px;
      text-align: center;
    }
    
    .result-table th:nth-child(4) {
      width: auto;
      min-width: 420px;
    }
    
    .result-table th:nth-child(5) {
      width: 80px;
      text-align: center;
    }
    
    .result-table td:nth-child(1) {
      text-align: center;
      font-weight: 600;
      color: #64748b;
    }
    
    .result-table td:nth-child(3) {
      text-align: center;
    }
    
    .result-table td:nth-child(5) {
      text-align: center;
    }

    .result-table td.pmi-cell {
      width: 100%;
    }
    
    .result-table tbody tr:hover {
      background: rgba(139, 92, 246, 0.05);
    }
    
    .proposer-badge {
      display: inline-block;
      padding: 4px 10px;
      background: rgba(139, 92, 246, 0.1);
      color: #7c3aed;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
    }
    
    .pmi-tags {
      display: flex;
      flex-direction: column;
      gap: 6px;
      width: 100%;
    }
    
    .pmi-tag {
      display: block;
      padding: 6px 12px;
      border-radius: 8px;
      font-size: 12px;
      width: 100%;
      max-width: 100%;
      white-space: normal;
      word-break: break-word;
      line-height: 1.5;
      font-weight: 500;
    }
    
    .pmi-tag.plus {
      background: #ffebee;
      color: #c62828;
    }
    
    .pmi-tag.minus {
      background: #fff8e1;
      color: #f57f17;
    }
    
    .pmi-tag.interesting {
      background: #e8f5e9;
      color: #2e7d32;
    }
    
    .delete-btn {
      padding: 6px 12px;
      background: #fee2e2;
      color: #991b1b;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 12px;
      font-weight: 600;
      transition: all 0.2s;
    }
    
    .delete-btn:hover {
      background: #fecaca;
    }
    
    .criteria-section {
      background: rgba(237, 233, 254, 0.3);
      border: 2px solid rgba(139, 92, 246, 0.2);
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
    }
    
    .criteria-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
      flex-wrap: wrap;
      gap: 10px;
    }
    
    .criteria-header h4 {
      font-size: 15px;
      font-weight: 700;
      color: #6d28d9;
    }
    
    .criteria-input-group {
      display: flex;
      gap: 10px;
    }
    
    .criteria-input-group input {
      padding: 8px 12px;
      border: 2px solid #e2e8f0;
      border-radius: 8px;
      font-size: 14px;
      width: 150px;
      transition: all 0.2s;
    }
    
    .criteria-input-group input:focus {
      outline: none;
      border-color: #8b5cf6;
      box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.1);
    }
    
    .criteria-input-group button {
      padding: 8px 15px;
      background: linear-gradient(135deg, #8b5cf6, #6366f1);
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 13px;
      font-weight: 600;
      transition: all 0.2s;
    }
    
    .criteria-input-group button:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 8px rgba(139, 92, 246, 0.3);
    }
    
    .suggested-btns {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 12px;
    }
    
    .suggested-btn {
      padding: 5px 10px;
      background: white;
      border: 2px dashed #cbd5e1;
      border-radius: 12px;
      cursor: pointer;
      font-size: 12px;
      color: #64748b;
      transition: all 0.2s;
    }
    
    .suggested-btn:hover {
      border-color: #8b5cf6;
      color: #8b5cf6;
      background: rgba(139, 92, 246, 0.05);
    }
    
    .criteria-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }
    
    .criteria-tag {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 6px 12px;
      background: rgba(139, 92, 246, 0.1);
      color: #7c3aed;
      border-radius: 20px;
      font-size: 13px;
      font-weight: 600;
      border: 1px solid rgba(139, 92, 246, 0.2);
    }
    
    .criteria-tag button {
      background: none;
      border: none;
      color: #7c3aed;
      cursor: pointer;
      opacity: 0.6;
      font-size: 16px;
      line-height: 1;
    }
    
    .criteria-tag button:hover {
      opacity: 1;
    }
    
    .matrix-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 14px;
      margin-bottom: 20px;
      background: #fff;
      border-radius: 12px;
      overflow: hidden;
      border: 2px solid #e2e8f0;
    }
    
    .matrix-table th,
    .matrix-table td {
      padding: 12px;
      text-align: center;
      border: 1px solid #e2e8f0;
    }
    
    .matrix-table th {
      background: linear-gradient(135deg, #8b5cf6, #6366f1);
      color: white;
      font-weight: 600;
    }
    
    .matrix-table th:first-child {
      background: linear-gradient(135deg, #7c3aed, #6366f1);
      text-align: left;
    }
    
    .matrix-table tbody tr:nth-child(even) {
      background: rgba(139, 92, 246, 0.02);
    }
    
    .matrix-table input[type="number"] {
      width: 50px;
      padding: 8px;
      text-align: center;
      border: 2px solid #e2e8f0;
      border-radius: 6px;
      font-size: 14px;
      transition: all 0.2s;
    }
    
    .matrix-table input[type="number"]:focus {
      outline: none;
      border-color: #8b5cf6;
      box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.1);
    }
    
    .total-cell {
      font-weight: 700;
      background: rgba(139, 92, 246, 0.1) !important;
      color: #7c3aed;
    }
    
    .rank-cell {
      font-weight: 700;
      font-size: 16px;
    }
    
    .final-result {
      text-align: center;
      padding: 30px 20px;
    }
    
    .winner-card {
      background: linear-gradient(135deg, #8b5cf6, #6366f1);
      color: white;
      padding: 30px;
      border-radius: 16px;
      margin: 20px auto;
      max-width: 450px;
      box-shadow: 0 8px 24px rgba(139, 92, 246, 0.3);
    }
    
    .winner-card .trophy {
      font-size: 3em;
      margin-bottom: 10px;
    }
    
    .winner-card .winner-name {
      font-size: 1.6em;
      font-weight: 800;
      margin-bottom: 8px;
    }
    
    .winner-card .winner-proposer {
      font-size: 15px;
      opacity: 0.9;
      margin-bottom: 5px;
    }
    
    .winner-card .winner-score {
      font-size: 16px;
      opacity: 0.85;
      font-weight: 600;
    }
    
    .ranking-list {
      margin-top: 25px;
      text-align: left;
    }
    
    .ranking-item {
      display: flex;
      align-items: center;
      padding: 12px 15px;
      background: #fff;
      border: 2px solid #e2e8f0;
      border-radius: 10px;
      margin-bottom: 8px;
      transition: all 0.2s;
    }
    
    .ranking-item:hover {
      border-color: #8b5cf6;
      box-shadow: 0 2px 8px rgba(139, 92, 246, 0.1);
    }
    
    .ranking-item .rank {
      font-size: 1.3em;
      width: 40px;
    }
    
    .ranking-item .info {
      flex: 1;
    }
    
    .ranking-item .name {
      font-weight: 700;
      color: #1e293b;
      font-size: 15px;
    }
    
    .ranking-item .proposer {
      font-size: 12px;
      color: #64748b;
      margin-top: 2px;
    }
    
    .ranking-item .score {
      font-weight: 700;
      color: #8b5cf6;
      font-size: 16px;
    }
    
    .empty-state {
      text-align: center;
      padding: 40px;
      color: #94a3b8;
    }
    
    .empty-state .icon {
      font-size: 2.5em;
      margin-bottom: 10px;
      opacity: 0.5;
    }
    
    .selection-nav-buttons {
      display: flex;
      justify-content: space-between;
      margin-top: 30px;
      padding-top: 20px;
      border-top: 2px solid #e2e8f0;
    }
    
    .selection-nav-btn {
      padding: 12px 25px;
      border-radius: 10px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: all 0.2s;
      border: none;
    }
    
    .selection-prev-btn {
      background: #f1f5f9;
      color: #64748b;
      border: 2px solid #e2e8f0;
    }
    
    .selection-prev-btn:hover {
      background: #e2e8f0;
    }
    
    .selection-next-btn {
      background: linear-gradient(135deg, #8b5cf6, #6366f1);
      color: white;
      box-shadow: 0 4px 6px rgba(139, 92, 246, 0.3);
    }
    
    .selection-next-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 6px 12px rgba(139, 92, 246, 0.4);
    }
    
    /* --- 초음파 센서 학습 페이지 스타일 --- */
    .quiz-option-btn:hover { 
      background: rgba(248, 250, 252, 0.8) !important; 
      border-color: rgba(139, 92, 246, 0.3) !important; 
      transform: translateY(-2px);
    }
    .quiz-option-btn.correct { 
      background: rgba(236, 253, 245, 0.8) !important; 
      border-color: #8b5cf6 !important; 
      color: #7c3aed !important; 
    }
    .quiz-option-btn.wrong { 
      background: rgba(254, 242, 242, 0.8) !important; 
      border-color: #ef4444 !important; 
      color: #991b1b !important; 
    }

    /* --- 상단 고정 홈 버튼 네비게이션 --- */
    .top-nav {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      background: rgba(255, 255, 255, 0.9);
      backdrop-filter: blur(10px);
      border-bottom: 1px solid rgba(139, 92, 246, 0.2);
      padding: 12px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      z-index: 1000;
      box-shadow: 0 2px 8px rgba(16, 185, 129, 0.1);
    }
    .top-nav.hidden { display: none; }
    .home-btn {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 16px;
      background: linear-gradient(135deg, #8b5cf6, #6366f1);
      color: white;
      border: none;
      border-radius: 12px;
      font-size: 14px;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.2s;
      box-shadow: 0 2px 4px rgba(16, 185, 129, 0.3);
    }
    .home-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 8px rgba(16, 185, 129, 0.4);
      background: linear-gradient(135deg, #059669, #0284c7);
    }
    .top-nav-title {
      font-size: 14px;
      font-weight: 600;
      background: linear-gradient(135deg, #8b5cf6, #6366f1);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
  </style>
</head>
<body>

<!-- 상단 고정 홈 네비게이션 -->
<div id="top-nav" class="top-nav hidden">
  <div class="top-nav-title">SDGs × 초음파 센서 문제해결 설계 플랫폼</div>
  <button class="home-btn" onclick="showIntro()">
    🏠 홈으로
  </button>
</div>

<!-- VIEW 1: 인트로 (역할 선택) -->
<div id="view-intro" class="view-section active">
  <div id="intro-screen">
    <!-- 배경에 날아다니는 박쥐들이 생성될 컨테이너 -->
    <div id="bat-container"></div>
    
    <!-- 중앙 컨텐츠 박스 (유리 효과) -->
    <div class="intro-content">
      <div class="main-icon">🦇</div>
      <h1 class="intro-title">SDGs × 초음파 센서</h1>
      <p class="intro-subtitle">세상을 바꾸는 아이디어, AI와 함께 설계해보세요.</p>
    
    <div class="role-cards">
      <div class="role-card" onclick="goToStudentLogin()">
          <span class="role-icon">👨‍🎓</span>
        <div class="role-name">학생 (Student)</div>
          <div class="role-desc">아이디어 설계 및 제출</div>
      </div>
      <div class="role-card" onclick="goToTeacherLogin()">
          <span class="role-icon">👩‍🏫</span>
        <div class="role-name">교사 (Teacher)</div>
          <div class="role-desc">제출 현황 및 평가</div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- VIEW 2-S: 학생 로그인 -->
<div id="view-student-login" class="view-section">
  <div class="intro-wrap">
    <h2 class="intro-title">학생 로그인</h2>
    <div class="login-box">
      <label class="input-label">학번 (Class ID)</label>
      <input type="text" id="std-id" class="input-field" placeholder="예: 20125">
      <label class="input-label">이름 (Name)</label>
      <input type="text" id="std-name" class="input-field" placeholder="예: 김코딩">
      <button class="btn-primary" onclick="studentLogin()">시작하기</button>
      <div style="text-align:center;">
        <button class="btn-text" onclick="showIntro()">뒤로 가기</button>
      </div>
    </div>
  </div>
</div>

<!-- VIEW 2-T: 교사 로그인 -->
<div id="view-teacher-login" class="view-section">
  <div class="intro-wrap">
    <h2 class="intro-title">교사 로그인</h2>
    <div class="login-box">
      <label class="input-label">비밀번호 (Password)</label>
      <input type="password" id="tea-pw" class="input-field" placeholder="비밀번호를 입력하세요">
      <button class="btn-primary" onclick="teacherLogin()">로그인</button>
      <div style="text-align:center;">
        <button class="btn-text" onclick="showIntro()">뒤로 가기</button>
      </div>
    </div>
  </div>
</div>

<!-- VIEW 3-T: 교사 대시보드 -->
<div id="view-teacher-dashboard" class="view-section" style="max-width:1400px;">
  <div class="dash-header">
    <div class="dash-title">📊 교사 관리 대시보드</div>
    <div class="dash-controls">
      <button class="btn-sm" onclick="openGoogleFormResponses()" style="background: linear-gradient(135deg, #10b981, #059669); color: white; border: none; box-shadow: 0 2px 4px rgba(16, 185, 129, 0.3);">
        📋 Google Form 응답 확인
      </button>
      <button class="btn-sm" onclick="downloadStudentDataCSV()" style="background: linear-gradient(135deg, #3b82f6, #2563eb); color: white; border: none; box-shadow: 0 2px 4px rgba(59, 130, 246, 0.3);">
        📥 CSV 파일 다운로드
      </button>
      <button class="btn-sm" onclick="goToTeacherConfig()">⚙️ 평가 기준 설정</button>
      <button class="btn-sm danger" onclick="clearData()">🗑️ 데이터 초기화</button>
      <button class="btn-sm" onclick="showIntro()">🚪 로그아웃</button>
    </div>
  </div>
  
  <!-- 탭 메뉴 -->
  <div class="teacher-tabs">
    <button class="teacher-tab active" onclick="switchTeacherTab('class')">학급별 관리</button>
    <button class="teacher-tab" onclick="switchTeacherTab('student')">학생별 관리</button>
  </div>
  
  <!-- 학급별 관리 뷰 -->
  <div id="class-management-view" class="management-layout" style="display: flex;">
    <div class="class-list-panel">
      <div class="class-list-header">
        <span class="class-list-title">학급 목록</span>
        <button class="btn-add-class" onclick="showAddClassDialog()" title="학급 추가">+</button>
      </div>
      <div id="class-list-container">
        <!-- 학급 목록이 여기에 생성됩니다 -->
      </div>
    </div>
    <div class="student-list-panel">
      <div class="student-list-header">학생 목록</div>
      <div id="student-list-container">
        <!-- 선택된 학급의 학생 목록이 여기에 생성됩니다 -->
      </div>
    </div>
    <div class="student-content-panel">
      <div id="student-worksheet-container">
        <!-- 선택된 학생의 학습지가 여기에 생성됩니다 -->
      </div>
    </div>
  </div>
  
  <!-- 학생별 관리 뷰 -->
  <div id="student-management-view" class="management-layout" style="display: none;">
    <div class="student-list-panel" style="width: 320px;">
      <div class="student-list-header">전체 학생</div>
      <div id="all-student-list-container">
        <!-- 전체 학생 목록이 여기에 생성됩니다 -->
      </div>
    </div>
    <div class="student-content-panel">
      <div id="all-student-worksheet-container">
        <!-- 선택된 학생의 학습지가 여기에 생성됩니다 -->
      </div>
    </div>
  </div>
</div>

<!-- VIEW 4-T: 교사 설정 (프롬프트) -->
<div id="view-teacher-config" class="view-section">
  <div class="intro-wrap" style="max-width:800px;">
    <h2 class="intro-title">⚙️ AI 평가 기준 설정</h2>
    <p class="intro-desc">학생들이 [검사] 버튼을 누를 때, AI가 참고할 평가 기준입니다.</p>
    
    <div class="teacher-config-box" style="text-align:left;">
      <label class="input-label">🔑 OpenAI API 키 (선택사항 - 설정 시 AI 피드백 활성화)</label>
      <input type="password" id="api-key" class="input-field" placeholder="sk-..." style="margin-bottom:15px;">
      <small style="color:#64748b; font-size:12px;">※ API 키를 설정하지 않으면 기본 검증만 수행됩니다. OpenAI API 키는 백엔드 서버를 통해 안전하게 관리하는 것을 권장합니다.</small>
      
      <label class="input-label" style="margin-top:20px;">📝 AI 페르소나 및 평가 가이드</label>
      <textarea id="teacher-prompt" class="prompt-editor">
당신은 SDGs 교육 전문가이자 창의적 문제해결 코치입니다. 학생의 설계를 다음 기준으로 평가하고 친절하게 피드백해주세요.

[평가 기준 - 각 항목별로 구체적으로 평가]

1. **실현 가능성 (Feasibility)**
   - 초음파 센서의 기술적 한계를 정확히 이해했는가? (거리만 측정 가능, 물체 종류 구별 불가)
   - 제안한 해결책이 실제로 구현 가능한 수준인가?
   - 사용한 거리 기준이 합리적인가?
   - 예상되는 기술적 문제점은 무엇인가?

2. **SDGs 관련성 (Relevance)**
   - 선택한 SDGs 목표와 문제 해결 방법이 실제로 연관이 있는가?
   - 이 해결책이 목표 달성에 어떻게 기여하는지 명확한가?
   - 구체적인 영향력(예: 물 절약량, 에너지 절감률 등)을 고려했는가?

3. **구체성 및 명확성 (Specificity)**
   - IF-THEN 조건이 코딩 가능할 정도로 구체적인가?
   - 센서 배치 위치와 작동 조건이 명확한가?
   - 장치의 ON/OFF 동작이 논리적으로 연결되어 있는가?
   - 예외 상황(센서 오작동, 여러 사람 동시 사용 등)을 고려했는가?

4. **안전성 및 실용성 (Safety & Practicality)**
   - 장치 작동 시 안전 위험이 없는가?
   - 실제 사용 환경에서 실용적일 수 있는가?
   - 유지보수와 관리가 가능한가?

5. **창의성 및 개선점 (Creativity & Improvements)**
   - 문제에 대한 새로운 관점이나 창의적 접근이 있는가?
   - 더 효과적인 방법은 무엇이 있을까?
   - 추가로 고려하면 좋을 점은?

[피드백 작성 가이드]
- 학생 이름을 부르며 친절하고 격려하는 톤으로 작성
- 먼저 잘한 점을 2-3개 구체적으로 언급
- 각 평가 기준별로 개선할 점을 구체적으로 제시
- 정답을 알려주기보다 스스로 생각할 수 있는 질문 던지기
- SDGs 목표 달성에 대한 영향력을 구체적으로 설명
- 실현 가능성을 높이기 위한 실용적 제안
- 마무리는 긍정적인 격려와 함께 다음 단계 제시

[피드백 형식]
✅ 잘한 점: [구체적 내용]
💡 개선하면 좋을 점: [구체적 내용]
🎯 SDGs 관련성: [구체적 설명]
⚙️ 실현 가능성: [구체적 평가]
🚀 다음 단계: [구체적 제안]
      </textarea>
    </div>
    <br>
    <button class="btn-primary" onclick="saveTeacherConfig()">저장하고 돌아가기</button>
    <button class="btn-text" onclick="showDashboard()">취소</button>
  </div>
</div>

<!-- VIEW 5-S-L: 학생 초음파 센서 원리 학습 -->
<div id="view-student-learning" class="view-section">
  <div class="app-inner" style="max-height: 90vh; overflow-y: auto;">
    <div class="header" style="margin-bottom: 20px;">
      <div class="header-icon">🦇</div>
      <h1>초음파 센서 원리 이해</h1>
      <div class="user-tag" id="learning-user-display">학생</div>
    </div>
    
    <!-- 학습 완료 배지 -->
    <div id="learning-completed-badge" style="display: none; background: rgba(237, 233, 254, 0.8); border: 2px solid #8b5cf6; border-radius: 12px; padding: 15px; margin-bottom: 20px; text-align: center;">
      <div style="font-size: 18px; font-weight: 700; color: #7c3aed; margin-bottom: 5px;">✅ 학습 완료!</div>
      <div style="font-size: 14px; color: #6d28d9;">이미 학습을 완료하셨습니다. 내용을 다시 확인하거나 아이디어 설계 페이지로 이동할 수 있습니다.</div>
    </div>

    <div style="margin-bottom: 20px;">
      <div style="background: rgba(237, 233, 254, 0.6); border: 2px solid #8b5cf6; border-radius: 16px; padding: 20px; text-align: left; width: 100%;">
        <strong style="color: #6d28d9; font-size: 16px;">💡 기술적 원리 이해:</strong><br>
        <div style="margin-top: 10px; color: #6d28d9; line-height: 1.8;">
          1. 박쥐가 나방을 낚아채는 거리는 약 <strong>2~5m</strong>입니다.<br>
          2. <strong>HC-SR04 초음파 센서</strong>의 측정 범위는 <strong>2cm ~ 400cm(4m)</strong>이며, 이 범위 안에서 가장 정확하게 거리를 잴 수 있어요!
        </div>
      </div>
    </div>

    <!-- 시뮬레이션 영역 -->
    <div style="background: rgba(248, 250, 252, 0.8); border: 2px solid rgba(139, 92, 246, 0.2); border-radius: 20px; padding: 30px; margin-bottom: 30px;">
      <div id="sim-visual" style="width: 100%; height: 350px; background: white; border-radius: 16px; position: relative; overflow: hidden; border: 2px solid rgba(139, 92, 246, 0.3); margin-bottom: 20px; display: flex; align-items: center;">
        <!-- 박쥐 말풍선 -->
        <div id="bat-speech-bubble" style="position: absolute; left: 180px; top: 25%; z-index: 15; opacity: 1; transition: opacity 0.3s ease; transform: translateY(0);">
          <div id="bat-bubble-container" style="background: linear-gradient(135deg, #fef3c7, #fde68a); border: 2px solid #f59e0b; border-radius: 16px; padding: 12px 18px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15); position: relative; max-width: 250px; animation: bubbleFloat 2s ease-in-out infinite;">
            <div id="bat-speech-text" style="font-size: 14px; font-weight: 600; color: #92400e; line-height: 1.4; text-align: center;">
              음... 아직은 좀 먼데? (탐색 중)
            </div>
            <!-- 말풍선 꼬리 -->
            <div id="bat-tail-outer" style="position: absolute; left: -10px; top: 50%; transform: translateY(-50%); width: 0; height: 0; border-top: 10px solid transparent; border-bottom: 10px solid transparent; border-right: 12px solid #f59e0b;"></div>
            <div id="bat-tail-inner" style="position: absolute; left: -8px; top: 50%; transform: translateY(-50%); width: 0; height: 0; border-top: 8px solid transparent; border-bottom: 8px solid transparent; border-right: 10px solid #fde68a;"></div>
          </div>
        </div>
        <div id="sim-bat" style="position: absolute; left: 50px; font-size: 80px; z-index: 10; top: 50%; transform: translateY(-50%); animation: batHover 2s ease-in-out infinite;">🦇</div>
        <div id="sim-moth" style="position: absolute; right: 10%; font-size: 60px; transition: right 0.3s; z-index: 10; top: 50%; transform: translateY(-50%);">🦋</div>
        <div id="wave-ping" style="position: absolute; width: 60px; height: 60px; border-radius: 50%; opacity: 0; z-index: 5; top: 50%; transform: translateY(-50%); left: 90px; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 14px; border: 3px solid #6366f1; background: rgba(99, 102, 241, 0.2); color: #4f46e5;">Ping</div>
        <div id="wave-pong" style="position: absolute; width: 60px; height: 60px; border-radius: 50%; opacity: 0; z-index: 5; top: 50%; transform: translateY(-50%); display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 14px; border: 3px solid #8b5cf6; background: rgba(139, 92, 246, 0.2); color: #7c3aed;">Pong</div>
        <div style="position: absolute; bottom: 10px; left: 100px; right: 100px; height: 30px; border-top: 2px solid #94a3b8; display: flex; justify-content: space-between; font-size: 11px; color: #64748b; padding-top: 5px;">
          <span>0cm</span><span>100cm</span><span>200cm</span><span>300cm</span><span>400cm</span>
        </div>
      </div>

      <div style="display: flex; gap: 20px; align-items: center; flex-wrap: wrap;">
        <div style="flex: 1; min-width: 300px;">
          <label style="font-weight: bold; font-size: 14px; color: #7c3aed; display: block; margin-bottom: 8px;">거리 조절 (2cm ~ 400cm)</label>
          <input type="range" id="dist-slider" min="2" max="400" value="400" style="width: 100%; cursor: pointer;" oninput="updateSimDistance(this.value)">
        </div>
        <div style="display: flex; gap: 15px;">
          <div style="background: white; padding: 8px 20px; border-radius: 12px; border: 2px solid rgba(139, 92, 246, 0.3); font-weight: bold; font-size: 16px; color: #7c3aed;" id="disp-distance">400cm</div>
          <div style="background: white; padding: 8px 20px; border-radius: 12px; border: 2px solid rgba(239, 68, 68, 0.3); font-weight: bold; font-size: 16px; color: #dc2626;" id="disp-time">23,529μs</div>
        </div>
        <button onclick="fireWave()" style="padding: 12px 30px; background: linear-gradient(135deg, #8b5cf6, #6366f1); color: white; border: none; border-radius: 12px; font-weight: bold; cursor: pointer; box-shadow: 0 4px 6px rgba(139, 92, 246, 0.3); transition: all 0.2s;">
          📡 발사!
        </button>
      </div>
    </div>

    <!-- 퀴즈 영역 -->
    <div style="background: rgba(255, 251, 235, 0.8); border: 2px solid #f59e0b; border-radius: 16px; padding: 25px; margin-bottom: 20px;">
      <div style="font-size: 18px; font-weight: 800; color: #92400e; margin-bottom: 15px; display: flex; align-items: center; gap: 8px;">
        ❓ <strong>개념 체크:</strong> 초음파 센서로 알 수 있는 것은?
      </div>
      <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 15px;">
        <button class="quiz-option-btn" onclick="checkQuizAnswer(this, false, 'color')" style="flex: 1; min-width: 150px; padding: 15px; border: 2px solid #e2e8f0; background: white; border-radius: 12px; font-size: 15px; font-weight: 600; cursor: pointer; transition: all 0.2s; color: #475569;">
          물체의 색깔
        </button>
        <button class="quiz-option-btn" onclick="checkQuizAnswer(this, false, 'type')" style="flex: 1; min-width: 150px; padding: 15px; border: 2px solid #e2e8f0; background: white; border-radius: 12px; font-size: 15px; font-weight: 600; cursor: pointer; transition: all 0.2s; color: #475569;">
          물체의 종류
        </button>
        <button class="quiz-option-btn" onclick="checkQuizAnswer(this, true, 'distance')" style="flex: 1; min-width: 150px; padding: 15px; border: 2px solid #e2e8f0; background: white; border-radius: 12px; font-size: 15px; font-weight: 600; cursor: pointer; transition: all 0.2s; color: #475569;">
          물체까지의 거리
        </button>
        <button class="quiz-option-btn" onclick="checkQuizAnswer(this, false, 'sound')" style="flex: 1; min-width: 150px; padding: 15px; border: 2px solid #e2e8f0; background: white; border-radius: 12px; font-size: 15px; font-weight: 600; cursor: pointer; transition: all 0.2s; color: #475569;">
          소리 측정
        </button>
      </div>
      <div id="quiz-feedback" style="margin-top: 15px; font-size: 14px; font-weight: bold; padding: 12px; border-radius: 12px; display: none;"></div>
    </div>

    <!-- 배운 점 정리 (드래그 앤 드롭 빈칸 채우기) -->
    <div style="margin-bottom: 20px;">
      <div style="font-weight: bold; color: #8b5cf6; font-size: 18px; display: flex; align-items: center; gap: 8px; margin-bottom: 10px;">
        ✨ <strong>[핵심 요약] 단어를 끌어넣어 완성하세요!</strong>
      </div>
      <div style="color: #64748b; font-size: 14px; margin-bottom: 15px; display: flex; align-items: center; gap: 5px;">
        🖱️ 아래 단어를 마우스로 끌어서 빈칸에 넣어보세요.
      </div>
      
      <div style="background: linear-gradient(135deg, #f5f3ff 0%, #ede9fe 100%); border: 2px solid #a78bfa; border-radius: 20px; padding: 30px; margin-bottom: 15px; box-shadow: 0 4px 12px rgba(139, 92, 246, 0.15);">
        <!-- 상단 점선 영역 - 드래그 가능한 단어 버튼들 -->
        <div style="border: 2px dashed #a78bfa; border-radius: 16px; padding: 25px; margin-bottom: 30px; background: rgba(255, 255, 255, 0.8); backdrop-filter: blur(10px);">
          <div id="word-container" style="display: flex; gap: 12px; flex-wrap: wrap; justify-content: center;">
            <div class="drag-word" draggable="true" data-word="초음파" style="background: linear-gradient(135deg, #8b5cf6, #6366f1); color: white; padding: 12px 28px; border-radius: 25px; font-size: 16px; font-weight: 600; cursor: grab; user-select: none; box-shadow: 0 4px 8px rgba(139, 92, 246, 0.3); transition: all 0.3s ease;">
              초음파
            </div>
            <div class="drag-word" draggable="true" data-word="반사" style="background: linear-gradient(135deg, #8b5cf6, #6366f1); color: white; padding: 12px 28px; border-radius: 25px; font-size: 16px; font-weight: 600; cursor: grab; user-select: none; box-shadow: 0 4px 8px rgba(139, 92, 246, 0.3); transition: all 0.3s ease;">
              반사
            </div>
            <div class="drag-word" draggable="true" data-word="시간" style="background: linear-gradient(135deg, #8b5cf6, #6366f1); color: white; padding: 12px 28px; border-radius: 25px; font-size: 16px; font-weight: 600; cursor: grab; user-select: none; box-shadow: 0 4px 8px rgba(139, 92, 246, 0.3); transition: all 0.3s ease;">
              시간
            </div>
            <div class="drag-word" draggable="true" data-word="거리" style="background: linear-gradient(135deg, #8b5cf6, #6366f1); color: white; padding: 12px 28px; border-radius: 25px; font-size: 16px; font-weight: 600; cursor: grab; user-select: none; box-shadow: 0 4px 8px rgba(139, 92, 246, 0.3); transition: all 0.3s ease;">
              거리
            </div>
          </div>
        </div>
        
        <!-- 빈칸이 있는 문장 -->
        <div style="font-size: 18px; line-height: 2.4; color: #1e293b; text-align: left; padding: 15px 0;">
          초음파 센서는 
          <span class="drop-zone" id="drop1" data-correct="초음파" style="display: inline-block; min-width: 100px; padding: 8px 12px; border: 2px dashed #c4b5fd; border-radius: 8px; background: white; margin: 0 5px; vertical-align: middle; text-align: center;"></span>
          를 쏘고, 물체에 
          <span class="drop-zone" id="drop2" data-correct="반사" style="display: inline-block; min-width: 100px; padding: 8px 12px; border: 2px dashed #c4b5fd; border-radius: 8px; background: white; margin: 0 5px; vertical-align: middle; text-align: center;"></span>
          되어 돌아오는 
          <span class="drop-zone" id="drop3" data-correct="시간" style="display: inline-block; min-width: 100px; padding: 8px 12px; border: 2px dashed #c4b5fd; border-radius: 8px; background: white; margin: 0 5px; vertical-align: middle; text-align: center;"></span>
          으로 
          <span class="drop-zone" id="drop4" data-correct="거리" style="display: inline-block; min-width: 100px; padding: 8px 12px; border: 2px dashed #c4b5fd; border-radius: 8px; background: white; margin: 0 5px; vertical-align: middle; text-align: center;"></span>
          를 측정합니다.
        </div>
      </div>
      
      <!-- 다시하기 및 정답 확인 버튼 -->
      <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 15px;">
        <button onclick="resetDragDrop()" style="padding: 12px 28px; background: #64748b; color: white; border: none; border-radius: 10px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 2px 6px rgba(100, 116, 139, 0.2);">
          다시하기
        </button>
        <button onclick="checkDragDropAnswer()" style="padding: 12px 28px; background: linear-gradient(135deg, #8b5cf6, #6366f1); color: white; border: none; border-radius: 10px; font-size: 14px; font-weight: 600; cursor: pointer; box-shadow: 0 4px 12px rgba(139, 92, 246, 0.4); transition: all 0.3s ease;">
          정답 확인
        </button>
      </div>
      
      <div id="reflection-feedback" style="margin-top: 15px; font-size: 14px; font-weight: bold; padding: 12px; border-radius: 12px; display: none;"></div>
    </div>

    <!-- 페이지 네비게이션 -->
    <div class="page-navigation">
      <button class="nav-prev-btn" id="learning-prev-btn" onclick="goToPreviousPage('learning')" disabled style="opacity: 0.5; cursor: not-allowed;">
        ◀ 이전 페이지로
      </button>
      <button class="nav-next-btn" id="learning-next-btn" onclick="completeLearning()" style="padding: 14px 30px; font-size: 15px; font-weight: 700; color: white; background: linear-gradient(135deg, #8b5cf6, #6366f1); border: none; border-radius: 10px; cursor: pointer; box-shadow: 0 4px 12px rgba(139, 92, 246, 0.4); transition: all 0.2s;">
        다음 페이지로 →
      </button>
    </div>
  </div>
</div>

<!-- VIEW 5-S: 학생 메인 캔버스 -->
<div id="view-student-main" class="view-section">
  <div class="app-inner">
    <!-- 상태 배너 -->
    <div id="status-banner" class="status-banner" style="display:none;">
      <span id="status-msg">상태 메시지</span>
      <span id="status-label" style="background:rgba(255,255,255,0.2); padding:4px 10px; border-radius:12px; font-size:12px;"></span>
    </div>

    <div class="header">
      <div class="header-icon">🦇</div>
      <h1>SDGs 문제해결 설계</h1>
      <div class="user-tag" id="user-display">학생</div>
    </div>
    
    <div class="scroll-area">
      <!-- 설계 폼 전체 -->
      <div id="design-form-container">
        <button class="helper-btn" id="load-example-btn" onclick="loadExample()" style="margin-bottom: 20px;">🎲 예시 불러오기 (따라 쓰기 금지!)</button>
        
        <!-- STEP 1: 문제 발견 & 목표 설정 -->
        <div class="design-section" style="margin-bottom: 40px; padding-bottom: 30px; border-bottom: 2px solid #e2e8f0;">
        <div class="step-header">
          <div class="step-title">1. 문제 발견 & 목표 설정</div>
          <div class="step-desc">어떤 불편함을 해결하고 싶나요? SDGs 목표와 연결해보세요.</div>
        </div>
        
        <div class="form-group">
          <label class="label">① 해결하고 싶은 문제</label>
          <textarea id="inp-problem" class="text-area" placeholder="예: 복도에 사람이 없는데도 불이 켜져 있어 전기가 낭비돼요."></textarea>
        </div>
        <div class="form-group">
          <label class="label">② 관련 SDGs 목표</label>
          
          <!-- SDGs 이미지와 커스텀 드롭다운 -->
          <div class="sdg-container">
            <!-- 왼쪽: 이미지 영역 -->
            <div class="sdg-image-box">
              <img src="https://sampyo.co.kr/wp-content/uploads/2021/10/new_ksdgs_symbols-scaled-e1634708639615-1024x660.jpg" alt="K-SDGs Goals">
            </div>
            
            <!-- 오른쪽: 우측 영역 -->
            <div class="sdg-right-area">
              <!-- 1. 드롭다운 -->
              <div>
                <div class="select-wrapper">
                  <div class="select-trigger" id="sdg-trigger" onclick="toggleSDGDropdown()">
                    <span id="sdg-selected-text" style="color:#64748b;">목표를 선택하세요</span>
                  </div>
                  
                  <!-- 17개 옵션 리스트 (JS로 자동 생성) -->
                  <div class="select-options" id="sdg-dropdown-options">
                    <!-- JavaScript로 동적 생성됨 -->
                  </div>
                </div>
              </div>
              
              <!-- 2. 설명 박스 -->
              <div id="sdg-detail-box" class="info-box">
                <div class="placeholder-text">
                  <span>👆</span> 목표를 선택하세요
                </div>
              </div>
            </div>
          </div>
          
          <!-- 숨겨진 select (기존 로직과 호환) -->
          <select id="inp-sdg" style="display: none;">
            <option value="">목표를 선택하세요</option>
            <option value="1">Goal 1. 빈곤 퇴치</option>
            <option value="2">Goal 2. 기아 종식</option>
            <option value="3">Goal 3. 건강과 웰빙</option>
            <option value="4">Goal 4. 양질의 교육</option>
            <option value="5">Goal 5. 성평등</option>
            <option value="6">Goal 6. 깨끗한 물과 위생</option>
            <option value="7">Goal 7. 모두를 위한 깨끗한 에너지</option>
            <option value="8">Goal 8. 양질의 일자리와 경제 성장</option>
            <option value="9">Goal 9. 산업, 혁신, 사회기반시설</option>
            <option value="10">Goal 10. 불평등 감소</option>
            <option value="11">Goal 11. 지속가능한 도시와 공동체</option>
            <option value="12">Goal 12. 지속가능한 소비와 생산</option>
            <option value="13">Goal 13. 기후변화 대응</option>
            <option value="14">Goal 14. 해양생태계 보전</option>
            <option value="15">Goal 15. 육상생태계 보전</option>
            <option value="16">Goal 16. 평화, 정의, 강력한 제도</option>
            <option value="17">Goal 17. 목표 달성을 위한 파트너십</option>
          </select>
        </div>
      </div>

        <!-- STEP 2 & 3: 센서 & 반응 설계 (통합) -->
        <div class="design-section" style="margin-bottom: 40px; padding-bottom: 30px; border-bottom: 2px solid #e2e8f0;">
        <div class="step-header">
          <div class="step-title">2. 센서 & 반응 설계</div>
          <div class="step-desc">초음파 센서가 '언제' 작동할지 거리를 정하고, 조건에 따라 어떤 장치가 어떻게 움직일지 설계해주세요.</div>
        </div>
        
        <div class="sensor-tip">
          <strong>🦇 초음파 센서 핵심:</strong> 오직 <strong>"거리(cm)"</strong>만 알 수 있습니다.<br>
          *소리, 빛, 냄새, 물체의 종류(사람 vs 강아지)는 구별하지 못해요.
        </div>
        
        <!-- 기준값 설정 -->
        <div class="threshold-row">
          <span>📏 기준 거리:</span>
          <input type="number" class="threshold-input" id="inp-dist" value="30" min="2" max="400" oninput="updateSensorDesign()">
          <span>cm</span>
        </div>
        
        <!-- 두 개의 카드 -->
        <div class="sensor-design-cards">
          <!-- 가까울 때 (TRUE) -->
          <div class="sensor-card when-true">
            <div class="sensor-card-header">
              <span>🟢</span>
              <span>가까울 때 (거리 < <span class="header-value" id="true-threshold">30</span>cm)</span>
        </div>
            <div class="sensor-card-body">
              <!-- 상황 설명 -->
              <div class="situation-box">
                <div class="situation-label">💭 이건 어떤 상황이야?</div>
                <textarea class="situation-input" id="inp-cond-on" placeholder="예: 사람이 쓰레기통 앞에 다가왔다" oninput="updateSensorDesign()"></textarea>
              </div>
              
              <!-- 동작 영역 -->
              <div class="action-title">⚡ 그래서 기계가 뭘 해야 해?</div>
              <div class="action-list" id="true-actions">
                <div class="action-row">
                  <select onchange="handleDeviceChange(this)">
                    <option>💡 LED</option>
                    <option>🔊 스피커</option>
                    <option>🦾 서보모터</option>
                    <option>📟 디스플레이</option>
                    <option>🌀 DC모터</option>
                    <option value="custom">✏️ 직접 입력</option>
                  </select>
                  <input type="text" class="custom-device-input" placeholder="장치 이름">
                  <input type="text" class="action-detail" placeholder="예: 초록색으로 켜기" oninput="updateSensorDesign()">
                  <button class="btn-remove-action" onclick="removeActionRow(this)">×</button>
                </div>
              </div>
              <button class="btn-add-action" onclick="addActionRow('true-actions')">+ 동작 추가</button>
        </div>
      </div>

          <!-- 멀 때 (FALSE) -->
          <div class="sensor-card when-false">
            <div class="sensor-card-header">
              <span>🟠</span>
              <span>멀 때 (거리 ≥ <span class="header-value" id="false-threshold">30</span>cm)</span>
            </div>
            <div class="sensor-card-body">
              <!-- 상황 설명 -->
              <div class="situation-box false">
                <div class="situation-label">💭 이건 어떤 상황이야?</div>
                <textarea class="situation-input" id="inp-cond-off" placeholder="예: 사람이 없어서 대기 상태다" oninput="updateSensorDesign()"></textarea>
        </div>

              <!-- 동작 영역 -->
              <div class="action-title">⚡ 그래서 기계가 뭘 해야 해?</div>
              <div class="action-list" id="false-actions">
                <div class="action-row">
                  <select onchange="handleDeviceChange(this)">
                    <option>💡 LED</option>
                    <option>🔊 스피커</option>
                    <option>🦾 서보모터</option>
                    <option>📟 디스플레이</option>
                    <option>🌀 DC모터</option>
                    <option value="custom">✏️ 직접 입력</option>
            </select>
                  <input type="text" class="custom-device-input" placeholder="장치 이름">
                  <input type="text" class="action-detail" placeholder="예: 끄기" oninput="updateSensorDesign()">
                  <button class="btn-remove-action" onclick="removeActionRow(this)">×</button>
          </div>
          </div>
              <button class="btn-add-action" onclick="addActionRow('false-actions')">+ 동작 추가</button>
        </div>
          </div>
        </div>
        
        <!-- 알고리즘 미리보기 -->
        <div class="preview-box" id="algorithm-preview"></div>
        
        <br>
        <div class="form-group" style="margin-top: 20px;">
          <label class="label">📝 전체 시나리오 정리</label>
          <textarea id="inp-scenario" class="text-area" placeholder="작동 과정을 누구나 이해할 수 있게 한 문단으로 정리해주세요."></textarea>
        </div>
      </div>

        <!-- 제출 섹션 -->
        <div class="design-section" style="margin-bottom: 20px;">
        <div class="step-header">
          <div class="step-title">4. AI 검사 및 최종 제출</div>
          <div class="step-desc">내용을 점검하고 선생님께 제출합니다.</div>
        </div>

          <div class="sensor-tip" style="background:rgba(254, 243, 199, 0.6); border-color:#f59e0b; color:#92400e;">
          <strong>🚨 제출 전 필수 체크!</strong><br>
            1. 먼저 '검사' 버튼을 눌러 내용을 확인하세요.<br>
            2. 예시를 그대로 베끼면 <strong>표절</strong>로 처리되어 제출 불가합니다.<br>
            3. 내용이 너무 짧거나 부실하면 <strong>검사에서 반려</strong>됩니다.<br>
            4. 검사 통과 후 '제출' 버튼을 눌러 제출하고, <strong>선생님의 승인</strong>을 받아야 완료됩니다.
        </div>

        <div class="chat-box" id="chat-box">
            <div class="chat-bubble chat-ai">안녕! 나는 너의 설계를 도와줄 AI 코치야. 먼저 '검사' 버튼으로 내용을 확인한 후, 문제가 없으면 '제출' 버튼을 눌러줘. 🤖</div>
        </div>
      </div>
      </div>
    </div>

    <div class="bottom-nav">
      <button class="nav-btn btn-check" id="btn-check" onclick="checkAssignment()">🔍 검사</button>
      <button class="nav-btn btn-submit" id="btn-submit" onclick="submitAssignment()" style="opacity:0.5; cursor:not-allowed;" disabled>✅ 제출</button>
    </div>
    
    <!-- 페이지 네비게이션 -->
    <div class="page-navigation">
      <button class="nav-prev-btn" id="design-prev-btn" onclick="goToPreviousPage('design')">
        ◀ 이전 페이지로
      </button>
      <button class="nav-next-btn" id="design-next-btn" onclick="goToNextPage('design')" disabled style="opacity: 0.5; cursor: not-allowed;">
        다음 페이지로 →
      </button>
    </div>
  </div>
</div>

<!-- VIEW 6-S: 아이디어 선정 페이지 -->
<div id="view-idea-selection" class="view-section">
  <div class="app-inner">
    <div class="header">
      <div class="header-icon">📊</div>
      <h1>아이디어 분석 및 선정</h1>
      <div class="user-tag" id="selection-user-display">학생</div>
    </div>

    <div class="scroll-area">
      <div class="idea-selection-container">
        <!-- 헤더 -->
        <div style="margin-bottom: 25px;">
          <h2 style="font-size: 20px; font-weight: 800; color: #1e293b; margin-bottom: 8px;">떠오른 아이디어들을 분석하고 가장 좋은 것을 골라보세요!</h2>
          <p style="color: #64748b; font-size: 14px;">모둠원들과 함께 PMI 분석과 평가행렬법을 통해 최적의 아이디어를 선정합니다.</p>
        </div>

        <!-- 모둠원 설정 -->
        <div class="member-setup">
          <div class="member-setup-header">
            <h3>👥 모둠원</h3>
            <div class="member-input-group">
              <input type="text" id="newMember" placeholder="이름 입력" onkeypress="if(event.key==='Enter') addMember()">
              <button onclick="addMember()">+ 추가</button>
            </div>
          </div>
          <div class="member-tags" id="memberList"></div>
        </div>

        <!-- 탭 네비게이션 -->
        <div class="tab-nav">
          <button class="tab-btn active" onclick="showSelectionTab('pmi')">
            📊 PMI 분석
          </button>
          <button class="tab-btn" onclick="showSelectionTab('matrix')">
            📈 평가행렬법
          </button>
          <button class="tab-btn" onclick="showSelectionTab('final')">
            🏆 최종 선정
          </button>
        </div>

        <!-- PMI 분석 탭 -->
        <div id="pmi-tab" class="tab-content active">
          <div style="display: flex; gap: 15px; margin-bottom: 20px; flex-wrap: wrap;">
            <div style="flex: 1; min-width: 250px;">
              <label style="display: block; font-size: 13px; font-weight: 700; color: #475569; margin-bottom: 8px;">💡 아이디어 이름</label>
              <input type="text" id="ideaName" class="input-line" placeholder="예: 자동 높이 조절 스위치" style="width: 100%;">
            </div>
            <div style="max-width: 200px;">
              <label style="display: block; font-size: 13px; font-weight: 700; color: #475569; margin-bottom: 8px;">🙋 제안자</label>
              <select id="ideaProposer" class="select-box" style="width: 100%;">
                <option value="">선택하세요</option>
              </select>
            </div>
          </div>

          <div class="pmi-grid">
            <div class="pmi-box plus">
              <div class="pmi-header">+ Plus (장점)</div>
              <textarea id="pmiPlus" placeholder="이 아이디어의 좋은 점은?"></textarea>
            </div>
            <div class="pmi-box minus">
              <div class="pmi-header">− Minus (단점)</div>
              <textarea id="pmiMinus" placeholder="이 아이디어의 아쉬운 점은?"></textarea>
            </div>
            <div class="pmi-box interesting">
              <div class="pmi-header">? Interesting (흥미)</div>
              <textarea id="pmiInteresting" placeholder="흥미롭거나 더 알아볼 점은?"></textarea>
            </div>
          </div>

          <button class="selection-save-btn" onclick="savePMI()">분석 저장하기</button>
          <div id="pmiAlert" class="selection-alert">✅ PMI 분석이 저장되었습니다!</div>

          <!-- 저장된 목록 -->
          <div class="result-section">
            <h3>📋 저장된 아이디어 분석</h3>
            <table class="result-table">
              <thead>
                <tr>
                  <th style="width:50px;">No.</th>
                  <th style="width:180px;">아이디어</th>
                  <th style="width:110px;">제안자</th>
                  <th style="width:auto; min-width:420px;">PMI</th>
                  <th style="width:80px;">삭제</th>
                </tr>
              </thead>
              <tbody id="pmiTableBody">
                <tr>
                  <td colspan="5" class="empty-state">
                    <div class="icon">📝</div>
                    <p>아직 분석된 아이디어가 없습니다.</p>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <!-- 평가행렬법 탭 -->
        <div id="matrix-tab" class="tab-content">
          <div class="criteria-section">
            <div class="criteria-header">
              <h4>📌 평가 기준</h4>
              <div class="criteria-input-group">
                <input type="text" id="newCriteria" placeholder="기준 입력" onkeypress="if(event.key==='Enter') addCriteria()">
                <button onclick="addCriteria()">+ 추가</button>
              </div>
            </div>
            <div class="suggested-btns">
              <span style="font-size:12px; color:#64748b;">추천:</span>
              <button class="suggested-btn" onclick="addSuggestedCriteria('실현가능성')">실현가능성</button>
              <button class="suggested-btn" onclick="addSuggestedCriteria('창의성')">창의성</button>
              <button class="suggested-btn" onclick="addSuggestedCriteria('효과성')">효과성</button>
              <button class="suggested-btn" onclick="addSuggestedCriteria('비용')">비용</button>
              <button class="suggested-btn" onclick="addSuggestedCriteria('시간')">시간</button>
            </div>
            <div class="criteria-tags" id="criteriaList"></div>
          </div>

          <div style="overflow-x:auto;">
            <table class="matrix-table" id="matrixTable">
              <thead id="matrixHead">
                <tr>
                  <th>아이디어</th>
                  <th>총점</th>
                  <th>순위</th>
                </tr>
              </thead>
              <tbody id="matrixBody">
                <tr>
                  <td colspan="3" class="empty-state">
                    <div class="icon">📊</div>
                    <p>PMI 분석에서 아이디어를 먼저 추가해주세요.</p>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>

          <button class="selection-save-btn" onclick="calculateMatrix()">🧮 점수 계산하기</button>
        </div>

        <!-- 최종 선정 탭 -->
        <div id="final-tab" class="tab-content">
          <div class="final-result" id="finalResult">
            <div class="empty-state">
              <div class="icon">🏆</div>
              <p>평가행렬법에서 점수를 계산하면<br>최종 결과가 표시됩니다.</p>
            </div>
          </div>
        </div>

        <!-- 내부 탭 네비게이션 -->
        <div class="selection-nav-buttons" style="margin-bottom: 20px;">
          <button class="selection-nav-btn selection-prev-btn" onclick="prevSelectionTab()" style="display: none;">◀ 이전 탭</button>
          <button class="selection-nav-btn selection-next-btn" onclick="nextSelectionTab()">다음 탭 ▶</button>
        </div>
      </div>
      
      <!-- 페이지 네비게이션 -->
      <div class="page-navigation" style="margin-top: 30px; padding-top: 20px; border-top: 2px solid rgba(139, 92, 246, 0.2);">
        <button class="nav-prev-btn" id="selection-prev-btn" onclick="goToPreviousPage('selection')">
          ◀ 이전 페이지로
        </button>
        <button class="nav-next-btn" id="selection-next-btn" onclick="goToNextPage('selection')">
          다음 페이지로 →
        </button>
      </div>
    </div>
  </div>
</div>

<!-- VIEW 7-S: 마이크로비트 닥터 (배선 진단 도구) -->
<div id="view-microbit-doctor" class="view-section">
  <div class="app-inner">
    <div class="header">
      <div class="header-icon">🩺</div>
      <h1>마이크로비트 닥터</h1>
      <div class="user-tag" id="doctor-user-display">학생</div>
    </div>

    <div class="scroll-area">
      <div style="max-width: 900px; margin: 0 auto; padding: 20px;">
        <p style="text-align: center; color: #64748b; font-size: 15px; margin-bottom: 30px;">
          복잡한 배선 문제, 3단계로 해결하세요.
        </p>

        <!-- STEP 0: 코드 분석 -->
        <div class="step-section-doctor">
          <div class="step-badge-doctor">STEP 0</div>
          <h2>블록 코드 분석</h2>
          <p class="description-doctor">작성한 블록 코드를 캡처해서 올려주세요. Trig와 Echo 핀 번호를 자동으로 추출합니다!</p>
          
          <div class="image-upload-area-doctor" id="blockCodeUploadArea" onclick="document.getElementById('blockCodeInput').click()">
            <div>📸 블록 코드 사진 업로드</div>
            <div style="font-size: 0.85rem; color: #64748b; margin-top: 5px;">
              클릭하거나 드래그하여 이미지를 업로드하세요
            </div>
            <input type="file" id="blockCodeInput" accept="image/*" style="display:none;" onchange="handleBlockCodeImage(event)">
            <img id="blockCodePreview" class="image-preview-doctor" style="display:none;">
          </div>
          <div id="ocrStatus" style="margin-top: 15px; font-weight: bold; color: #64748b;"></div>
          <div id="ocrResults"></div>
          <div id="aiFeedbackArea" style="margin-top: 20px; display: none;">
            <div style="background: rgba(139, 92, 246, 0.1); border-left: 4px solid #8b5cf6; padding: 15px; border-radius: 8px;">
              <div style="font-weight: bold; color: #7c3aed; margin-bottom: 10px; display: flex; align-items: center; gap: 8px;">
                <span>🤖</span>
                <span>AI 코드 피드백</span>
              </div>
              <div id="aiFeedbackContent" style="color: #475569; line-height: 1.6; font-size: 14px;"></div>
            </div>
          </div>
        </div>

        <!-- STEP 1: 연결 시뮬레이터 -->
        <div class="step-section-doctor" id="step1-section" style="position: relative;">
          <div id="step1-overlay" style="display: none; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(255, 255, 255, 0.9); z-index: 100; border-radius: 12px; display: flex; align-items: center; justify-content: center; flex-direction: column; gap: 15px;">
            <div style="font-size: 48px;">⚠️</div>
            <div style="font-size: 18px; font-weight: bold; color: #ef4444;">STEP 0에서 오류를 먼저 수정해주세요!</div>
            <div style="font-size: 14px; color: #64748b; text-align: center; max-width: 400px;">
              Trig와 Echo 핀이 같은 핀으로 설정되어 있습니다.<br>
              코드를 수정한 후 다시 분석해주세요.
            </div>
          </div>
          <div class="step-badge-doctor">STEP 1</div>
          <h2>🔌 초음파 센서 연결 실습</h2>
          <p class="description-doctor">초음파 센서의 핀을 드래그해서 확장보드의 올바른 위치에 연결해보세요!</p>
          <div class="simulator-controls-doctor">
            <span id="simulator-feedback-msg">선을 드래그해서 연결해보세요!</span>
            <button onclick="resetWiring()" class="btn-outline-doctor" style="width: auto; margin: 0; padding: 8px 16px;">🔄 다시 하기</button>
          </div>
          <div class="simulator-canvas-container-doctor">
            <canvas id="simCanvas" width="950" height="550"></canvas>
          </div>
        </div>

        <!-- STEP 2: 최종 연결 확인 -->
        <div class="step-section-doctor">
          <div class="step-badge-doctor">STEP 2</div>
          <h2>최종 신호 확인</h2>
          <p class="description-doctor">마지막으로 USB를 연결해 실제 센서 값이 들어오는지 확인합니다.</p>
          <button onclick="connectUSB()" class="btn-primary-doctor" style="background: linear-gradient(135deg, #8b5cf6, #6366f1);">🔌 장치 연결하기</button>
          <div class="status-grid-doctor">
            <div class="status-card-doctor">
              <span class="status-icon-doctor" id="icon-status">❓</span>
              <span style="display:block; font-size:0.9rem; color:#64748b;">연결 상태</span>
              <span class="status-val-doctor" id="text-status" style="color:#64748b">대기 중</span>
            </div>
            <div class="status-card-doctor">
              <span class="status-icon-doctor">📏</span>
              <span style="display:block; font-size:0.9rem; color:#64748b;">현재 거리</span>
              <span class="status-val-doctor" id="text-dist">-- cm</span>
            </div>
          </div>
          <!-- 측정 그래프 -->
          <div class="chart-container-doctor">
            <div class="chart-title-doctor">📊 실시간 거리 측정 그래프</div>
            <div style="height:200px;">
              <canvas id="sensorChart"></canvas>
            </div>
          </div>
        </div>
      </div>
      
      <!-- 페이지 네비게이션 -->
      <div class="page-navigation" style="margin-top: 30px; padding-top: 20px; border-top: 2px solid rgba(139, 92, 246, 0.2);">
        <button class="nav-prev-btn" onclick="goToPreviousPage('doctor')">
          ◀ 이전 페이지로
        </button>
        <button class="nav-next-btn" disabled style="opacity: 0.5; cursor: not-allowed;">
          다음 페이지로 →
        </button>
      </div>
    </div>
  </div>
</div>

<script type="module" src="/env-config.js"></script>
<script>
  /* =========================================
     GLOBAL VARIABLES
     ========================================= */
  let currentUser = { id: '', name: '' };
  let lastLoadedExample = null; // 표절 검사용
  let isChecked = false; // 검사 통과 여부
  const TEACHER_PW = "1234"; // 교사 비밀번호

  /* =========================================
     API 키 가져오기 (localStorage → 환경 변수 순서)
     ========================================= */
  function getApiKey() {
    // 1. localStorage에서 먼저 확인 (교사가 설정한 값 우선)
    const storedKey = localStorage.getItem('openai_api_key');
    if(storedKey) return storedKey;
    
    // 2. 환경 변수에서 확인 (Vite 환경 변수)
    if(typeof window !== 'undefined' && window.VITE_OPENAI_API_KEY) {
      // 환경 변수 값을 localStorage에 저장 (다음에 빠르게 접근)
      localStorage.setItem('openai_api_key', window.VITE_OPENAI_API_KEY);
      return window.VITE_OPENAI_API_KEY;
    }
    
    return null;
  }

  /* =========================================
     VIEW NAVIGATION
     ========================================= */
  function showView(viewId) {
    try {
      // 모든 섹션 숨기기 (명시적으로 display: none 설정)
      const allSections = document.querySelectorAll('.view-section');
      allSections.forEach(el => {
        el.classList.remove('active');
        el.style.display = 'none';
        el.style.visibility = 'hidden';
      });
      
      // 선택한 섹션 표시
      const targetSection = document.getElementById(viewId);
      if(targetSection) {
        console.log('페이지 표시:', viewId);
        targetSection.classList.add('active');
        targetSection.style.display = 'block';
        targetSection.style.visibility = 'visible';
      } else {
        console.error('View section not found:', viewId);
        // 에러 대신 인트로 페이지로 이동
        const fallbackView = document.getElementById('view-intro');
        if(fallbackView) {
          fallbackView.classList.add('active');
          fallbackView.style.display = 'block';
          fallbackView.style.visibility = 'visible';
        }
        return; // targetSection이 없으면 여기서 종료
      }
      
      // 상단 네비게이션 바 표시/숨김 제어
      const topNav = document.getElementById('top-nav');
      if(topNav) {
        if(viewId === 'view-intro') {
          topNav.classList.add('hidden');
          document.body.style.paddingTop = '20px';
        } else {
          topNav.classList.remove('hidden');
          document.body.style.paddingTop = '60px';
        }
      }
    
    // 학습 페이지로 이동 시 시뮬레이션 초기화 및 퀴즈 상태 초기화
    if(viewId === 'view-student-learning') {
      setTimeout(() => {
        initSimulation();
        const feedback = document.getElementById('quiz-feedback');
        if(feedback) {
          feedback.style.display = 'none';
        }
        // 배운 점 정리 피드백 초기화
        const reflectionFeedback = document.getElementById('reflection-feedback');
        if(reflectionFeedback) {
          reflectionFeedback.style.display = 'none';
        }
        // 학습 완료 여부 확인하여 배지 표시
        if(currentUser && currentUser.id && currentUser.name) {
          const completed = checkLearningCompleted(currentUser.id, currentUser.name);
          const badge = document.getElementById('learning-completed-badge');
          if(badge) {
            badge.style.display = completed ? 'block' : 'none';
          }
          
          // 학습 상태 확인
          const state = getLearningState();
          
          // 저장된 상태가 있으면 복원, 없으면 초기화
          if(state.quizAnswered || state.dragDropAnswers) {
            // 저장된 상태 복원
            setTimeout(() => {
              restoreLearningState();
              // 복원 후 퀴즈 상태 업데이트
              if(state.quizAnswered) {
                quizAnswered = true;
              }
              // 네비게이션 버튼 상태 업데이트 (학습 완료 체크)
              updateNavigationButtons();
            }, 200);
          } else {
            quizAnswered = false;
            // 저장된 상태가 없으면 초기화
            setTimeout(() => {
              resetDragDrop();
              initDragDrop();
            }, 100);
            // 모든 퀴즈 버튼 상태 초기화
            document.querySelectorAll('.quiz-option-btn').forEach(btn => {
              btn.classList.remove('correct', 'wrong');
            });
            // 네비게이션 버튼 상태 업데이트
            updateNavigationButtons();
          }
        } else {
          quizAnswered = false;
          // 로그인하지 않은 경우 초기화
          setTimeout(() => {
            resetDragDrop();
            initDragDrop();
          }, 100);
        }
      }, 100);
    }
    
    // 학생 메인 페이지로 이동 시 초기화
    if(viewId === 'view-student-main') {
      setTimeout(() => {
        // 제출한 데이터가 있으면 복구
        if(currentUser && currentUser.id && currentUser.name) {
          loadMySubmission();
        }
        initSDGDropdown();
        updateAlgorithmPreview();
        updateSensorDesign();
        // 네비게이션 버튼 상태 업데이트
        updateNavigationButtons();
      }, 200);
    }
    
    // 선정 페이지로 이동 시 네비게이션 업데이트 및 입력 활성화
    if(viewId === 'view-microbit-doctor') {
      setTimeout(() => {
        initMicrobitDoctor();
      }, 100);
    }
    
    if(viewId === 'view-idea-selection') {
      setTimeout(() => {
        updateNavigationButtons();
        // 다음 버튼 활성화
        const selectionNextBtn = document.getElementById('selection-next-btn');
        if(selectionNextBtn) {
          selectionNextBtn.disabled = false;
          selectionNextBtn.style.opacity = '1';
          selectionNextBtn.style.cursor = 'pointer';
        }
        // 아이디어 선정 페이지의 모든 입력 필드 활성화
        const selectionPage = document.getElementById('view-idea-selection');
        if(selectionPage) {
          const inputs = selectionPage.querySelectorAll('input, textarea, select');
          inputs.forEach(el => {
            el.disabled = false;
            el.readOnly = false;
            el.style.pointerEvents = 'auto';
            el.style.opacity = '1';
            el.style.cursor = 'auto';
          });
        }
        // initIdeaSelection 호출
        if(typeof initIdeaSelection === 'function') {
          initIdeaSelection();
        }
      }, 200);
    }
    } catch(error) {
      console.error('Error in showView:', error, viewId);
    }
  }
  
  // 페이지 진행바 업데이트 함수
  function updatePageProgress() {
    const steps = [
      { id: 'page-step-1', check: () => {
        const problem = document.getElementById('inp-problem')?.value.trim() || '';
        return problem.length >= 30;
      }},
      { id: 'page-step-2', check: () => {
        const sdg = document.getElementById('inp-sdg')?.value || '';
        return sdg !== '';
      }},
      { id: 'page-step-3', check: () => {
        const dist = document.getElementById('inp-dist')?.value.trim() || '';
        const condOn = document.getElementById('inp-cond-on')?.value.trim() || '';
        const condOff = document.getElementById('inp-cond-off')?.value.trim() || '';
        const trueActions = getActionsFromUI('true-actions');
        const falseActions = getActionsFromUI('false-actions');
        return dist && condOn.length >= 10 && condOff.length >= 10 && 
               trueActions.length > 0 && falseActions.length > 0;
      }},
      { id: 'page-step-4', check: () => {
        const scenario = document.getElementById('inp-scenario')?.value.trim() || '';
        return scenario.length >= 50;
      }}
    ];
    
    let currentStep = 1;
    let completedSteps = 0;
    
    steps.forEach((step, index) => {
      const stepEl = document.getElementById(step.id);
      if(!stepEl) return;
      
      const isCompleted = step.check();
      const stepNum = index + 1;
      
      stepEl.classList.remove('active', 'completed');
      
      if(isCompleted) {
        stepEl.classList.add('completed');
        completedSteps = stepNum;
        if(stepNum >= currentStep) {
          currentStep = stepNum + 1;
        }
      } else if(stepNum === currentStep) {
        stepEl.classList.add('active');
      }
    });
    
    // 현재 단계 표시 (완료되지 않은 첫 번째 단계)
    currentStep = Math.min(currentStep, 4);
    const currentStepEl = document.getElementById('pageCurrentStep');
    if(currentStepEl) {
      currentStepEl.textContent = currentStep;
    }
  }
  
  // 저장된 동작 데이터 복구 함수
  function restoreActions(listId, actionsArray) {
    const list = document.getElementById(listId);
    if(!list) {
      console.warn(`restoreActions: ${listId} 요소를 찾을 수 없습니다.`);
      return;
    }
    
    // 기존 동작 모두 제거
    list.innerHTML = '';
    
    // 저장된 동작이 없으면 기본 행 하나 추가
    if(!actionsArray || actionsArray.length === 0) {
      addActionRow(listId);
      return;
    }
    
    // 저장된 동작들을 복구
    actionsArray.forEach((action, index) => {
      const row = document.createElement('div');
      row.className = 'action-row';
      
      // device에서 이모지와 텍스트 추출
      let deviceValue = '💡 LED'; // 기본값
      let isCustom = false;
      let customDeviceName = '';
      
      if(action.device) {
        if(action.device.includes('🔧')) {
          // 직접 입력인 경우
          isCustom = true;
          customDeviceName = action.device.replace('🔧 ', '').trim();
          deviceValue = 'custom';
        } else {
          // 드롭다운에서 선택된 경우 - 이모지로 매칭
          const deviceText = action.device.trim();
          if(deviceText.includes('💡')) deviceValue = '💡 LED';
          else if(deviceText.includes('🔊')) deviceValue = '🔊 스피커';
          else if(deviceText.includes('🦾')) deviceValue = '🦾 서보모터';
          else if(deviceText.includes('📟')) deviceValue = '📟 디스플레이';
          else if(deviceText.includes('🌀')) deviceValue = '🌀 DC모터';
          else deviceValue = deviceText; // 그대로 사용
        }
      }
      
      row.innerHTML = `
        <select onchange="handleDeviceChange(this)">
          <option>💡 LED</option>
          <option>🔊 스피커</option>
          <option>🦾 서보모터</option>
          <option>📟 디스플레이</option>
          <option>🌀 DC모터</option>
          <option value="custom">✏️ 직접 입력</option>
        </select>
        <input type="text" class="custom-device-input" placeholder="장치 이름" value="${customDeviceName || ''}" style="display: ${isCustom ? 'block' : 'none'};">
        <input type="text" class="action-detail" placeholder="동작 입력" value="${(action.action || '').replace(/"/g, '&quot;')}" oninput="updateSensorDesign()">
        <button class="btn-remove-action" onclick="removeActionRow(this)">×</button>
      `;
      
      list.appendChild(row);
      
      // select 값 설정 (약간의 지연 후)
      setTimeout(() => {
        const selectEl = row.querySelector('select');
        if(selectEl) {
          selectEl.value = deviceValue;
          // 직접 입력인 경우 handleDeviceChange 호출
          if(isCustom) {
            handleDeviceChange(selectEl);
          }
        }
      }, 10 * index); // 각 행마다 약간씩 지연
    });
    
    // 동작이 하나도 없으면 기본 행 추가
    setTimeout(() => {
      if(list.querySelectorAll('.action-row').length === 0) {
        addActionRow(listId);
      }
    }, 100);
  }
  
  
  // 저장된 동작 데이터 복구 함수
  function restoreActions(listId, actionsArray) {
    const list = document.getElementById(listId);
    if(!list) return;
    
    // 기존 동작 모두 제거 (첫 번째 기본 행은 유지할 수도 있음)
    list.innerHTML = '';
    
    // 저장된 동작이 없으면 기본 행 하나 추가
    if(!actionsArray || actionsArray.length === 0) {
      addActionRow(listId);
      return;
    }
    
    // 저장된 동작들을 복구
    actionsArray.forEach(action => {
      const row = document.createElement('div');
      row.className = 'action-row';
      
      // device에서 이모지와 텍스트 추출
      let deviceValue = '💡 LED'; // 기본값
      let isCustom = false;
      let customDeviceName = '';
      
      if(action.device) {
        if(action.device.includes('🔧')) {
          // 직접 입력인 경우
          isCustom = true;
          customDeviceName = action.device.replace('🔧 ', '').trim();
          deviceValue = 'custom';
        } else {
          // 드롭다운에서 선택
          deviceValue = action.device;
        }
      }
      
      row.innerHTML = `
        <select onchange="handleDeviceChange(this)">
          <option>💡 LED</option>
          <option>🔊 스피커</option>
          <option>🦾 서보모터</option>
          <option>📟 디스플레이</option>
          <option>🌀 DC모터</option>
          <option value="custom">✏️ 직접 입력</option>
        </select>
        <input type="text" class="custom-device-input" placeholder="장치 이름" value="${customDeviceName}" style="display: ${isCustom ? 'block' : 'none'};">
        <input type="text" class="action-detail" placeholder="동작 입력" value="${action.action || ''}" oninput="updateSensorDesign()">
        <button class="btn-remove-action" onclick="removeActionRow(this)">×</button>
      `;
      
      list.appendChild(row);
      
      // select 값 설정
      const selectEl = row.querySelector('select');
      if(selectEl) {
        selectEl.value = deviceValue;
        // 직접 입력인 경우 handleDeviceChange 호출
        if(isCustom) {
          handleDeviceChange(selectEl);
        }
      }
    });
    
    // 동작이 하나도 없으면 기본 행 추가
    if(list.querySelectorAll('.action-row').length === 0) {
      addActionRow(listId);
    }
  }

  function showIntro() { showView('view-intro'); }
  function goToStudentLogin() { showView('view-student-login'); }
  function goToTeacherLogin() { 
    document.getElementById('tea-pw').value = ''; 
    showView('view-teacher-login'); 
  }

  /* =========================================
     STUDENT LOGIC
     ========================================= */
  function studentLogin() {
    const id = document.getElementById('std-id').value.trim();
    const name = document.getElementById('std-name').value.trim();
    if(!id || !name) { alert('학번과 이름을 모두 입력해주세요.'); return; }

    currentUser = { id, name };
    document.getElementById('user-display').textContent = `${id} ${name}`;
    document.getElementById('learning-user-display').textContent = `${id} ${name}`;
    
    // 학번 기반으로 자동으로 학급에 배정
    assignStudentToClassById(id, name);
    
    // 학생의 활동 상태 확인 (마지막 활동 위치 판단)
    const learningCompleted = checkLearningCompleted(id, name);
    const allSubmissions = JSON.parse(localStorage.getItem('student_submissions') || '[]');
    const mySub = allSubmissions.find(s => s.id === id && s.name === name);
    const hasSubmission = !!mySub; // 제출한 적이 있는지
    
    // 아이디어 선정 페이지 데이터 확인 (학생별로 확인)
    const selectionDataKey = `pblData_${id}_${name}`;
    const pblData = JSON.parse(localStorage.getItem(selectionDataKey) || '{}');
    const hasSelectionData = !!(pblData.pmiData && pblData.pmiData.length > 0);
    
    // 마지막 활동 위치 판단 (우선순위 순):
    // 1. 아이디어 선정 데이터가 있으면 -> 아이디어 선정 페이지 (가장 최근 활동)
    // 2. 제출한 적이 있고 피드백을 받았으면 -> 아이디어 설계 페이지 (수정해야 함)
    // 3. 제출한 적이 있으면 -> 아이디어 설계 페이지 (제출 완료했으니)
    // 4. 학습 완료했으면 -> 아이디어 설계 페이지 (학습 끝났으니)
    // 5. 그 외 -> 학습 페이지 (처음 시작)
    
    // 피드백이 있는지 확인
    const hasFeedback = mySub && mySub.status && mySub.status !== 'pending' && 
                       mySub.teacherFeedback && mySub.teacherFeedback.trim() !== '';
    
    if(hasSelectionData) {
      // 아이디어 선정 페이지로 이동 (가장 최근 활동)
      showView('view-idea-selection');
      setTimeout(() => {
        if(typeof initIdeaSelection === 'function') {
          initIdeaSelection();
        }
        updateNavigationButtons();
      }, 200);
    } else if(hasFeedback) {
      // 피드백을 받았으면 아이디어 설계 페이지로 이동 (수정 필요)
      showView('view-student-main');
      setTimeout(() => {
        if(typeof loadMySubmission === 'function') {
          loadMySubmission();
        }
        checkFeedbackNotification(id, name);
        updateNavigationButtons();
      }, 300);
    } else if(hasSubmission || learningCompleted) {
      // 아이디어 설계 페이지로 이동
      showView('view-student-main');
      setTimeout(() => {
        if(typeof loadMySubmission === 'function') {
          loadMySubmission();
        }
        checkFeedbackNotification(id, name);
        updateNavigationButtons();
      }, 300);
    } else {
      // 학습 페이지로 이동 (처음 시작)
      showView('view-student-learning');
      setTimeout(() => {
        if(typeof initSimulation === 'function') {
          initSimulation();
        }
        if(typeof restoreLearningState === 'function') {
          restoreLearningState(id, name);
        }
        updateNavigationButtons();
      }, 100);
    }
  }
  
  function checkLearningCompleted(id, name) {
    // localStorage에서 학습 완료 상태 확인
    const completedKey = `learning_completed_${id}_${name}`;
    return localStorage.getItem(completedKey) === 'true';
  }
  
  function setLearningCompleted(id, name) {
    // localStorage에 학습 완료 상태 저장
    const completedKey = `learning_completed_${id}_${name}`;
    localStorage.setItem(completedKey, 'true');
  }
  
  // 아이디어 설계 페이지로 이동
  function goToDesignPage() {
    if(currentUser && currentUser.id && currentUser.name) {
      showView('view-student-main');
      // loadMySubmission은 showView에서 호출됨
    } else {
      alert('로그인이 필요합니다.');
      showView('view-student-login');
    }
  }
  
  // 피드백 알림 확인 및 표시
  function checkFeedbackNotification(id, name) {
    const allSubmissions = JSON.parse(localStorage.getItem('student_submissions') || '[]');
    const mySub = allSubmissions.find(s => s.id === id && s.name === name);
    
    // 제출한 적이 없으면 알림 표시 안 함
    if(!mySub) return false;
    
    // 제출 상태가 pending이면 아직 피드백 없음
    if(mySub.status === 'pending' || !mySub.status) return false;
    
    // 피드백이 실제로 존재하고 비어있지 않은지 확인
    if(!mySub.teacherFeedback || mySub.teacherFeedback.trim() === '') return false;
    
    // 피드백이 있고 아직 확인하지 않은 경우
    const notificationKey = `feedback_notified_${id}_${name}_${mySub.timestamp || 'default'}`;
    const alreadyNotified = localStorage.getItem(notificationKey) === 'true';
    
    if((mySub.status === 'rejected' || mySub.status === 'approved') && !alreadyNotified) {
      // 약간의 지연 후 알림 표시 (페이지 이동 후)
      setTimeout(() => {
        if(typeof window.showFeedbackNotification === 'function') {
          window.showFeedbackNotification(mySub);
        }
      }, 500);
      // 알림 확인 플래그 저장
      localStorage.setItem(notificationKey, 'true');
      return true; // 피드백 있음
    }
    
    return false; // 피드백 없음
  }
  
  // 피드백 알림 모달 표시 (SweetAlert2 스타일) - 전역 함수
  window.showFeedbackNotification = function(submission) {
    const isRejected = submission.status === 'rejected';
    
    // 기존 모달이 있으면 제거
    const existingModal = document.getElementById('feedback-notification-modal');
    if(existingModal) {
      existingModal.remove();
    }
    
    const modal = document.createElement('div');
    modal.id = 'feedback-notification-modal';
    modal.style.cssText = `
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.4);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 10000;
      animation: swal2-fade-in 0.3s;
      font-family: 'Pretendard', -apple-system, BlinkMacSystemFont, system-ui, Roboto, sans-serif;
    `;
    
    // SweetAlert2 스타일의 모달 박스
    modal.innerHTML = `
      <div class="swal2-popup" style="
        background: white;
        border-radius: 17px;
        padding: 0;
        max-width: 478px;
        width: 90%;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
        animation: swal2-show 0.3s;
        overflow: hidden;
        display: flex;
        flex-direction: column;
      ">
        <!-- 아이콘 영역 -->
        <div class="swal2-icon" style="
          width: 80px;
          height: 80px;
          border-radius: 50%;
          margin: 32px auto 20px;
          display: flex;
          align-items: center;
          justify-content: center;
          font-size: 60px;
          background: ${isRejected ? 'rgba(254, 242, 242, 0.2)' : 'rgba(237, 233, 254, 0.2)'};
          border: 4px solid ${isRejected ? '#fecaca' : '#c4b5fd'};
          animation: swal2-animate-success-icon 0.5s;
        ">
          ${isRejected ? '⚠️' : '🎉'}
        </div>
        
        <!-- 제목 -->
        <h2 class="swal2-title" style="
          font-size: 24px;
          font-weight: 700;
          color: #1e293b;
          margin: 0 32px 16px;
          text-align: center;
          line-height: 1.4;
        ">
          ${isRejected ? '피드백을 받았습니다' : '과제가 승인되었습니다!'}
        </h2>
        
        <!-- 설명 -->
        <div class="swal2-html-container" style="
          margin: 0 32px 24px;
          text-align: center;
          font-size: 15px;
          color: #64748b;
          line-height: 1.6;
        ">
          ${isRejected ? '선생님께서 피드백을 남겨주셨습니다.<br>확인 후 수정하여 재제출해주세요.' : '축하합니다! 선생님께서 과제를 승인하셨습니다.'}
        </div>
        
        <!-- 피드백 내용 박스 -->
        <div style="
          background: ${isRejected ? 'rgba(254, 242, 242, 0.3)' : 'rgba(237, 233, 254, 0.3)'};
          border: 1px solid ${isRejected ? '#fecaca' : '#c4b5fd'};
          border-radius: 12px;
          padding: 20px;
          margin: 0 32px 24px;
          max-height: 250px;
          overflow-y: auto;
        ">
          <div style="
            font-size: 13px;
            font-weight: 700;
            color: ${isRejected ? '#991b1b' : '#6d28d9'};
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 6px;
          ">
            <span>📝</span>
            <span>선생님 피드백:</span>
          </div>
          <div style="
            font-size: 14px;
            color: #475569;
            line-height: 1.7;
            white-space: pre-wrap;
            word-break: break-word;
          ">
            ${submission.teacherFeedback || '피드백이 없습니다.'}
          </div>
        </div>
        
        <!-- 버튼 영역 -->
        <div class="swal2-actions" style="
          margin: 0 32px 32px;
          display: flex;
          gap: 12px;
        ">
          <button onclick="closeFeedbackNotification()" class="swal2-cancel" style="
            flex: 1;
            padding: 14px 24px;
            background: #f1f5f9;
            color: #475569;
            border: none;
            border-radius: 8px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
          " onmouseover="this.style.background='#e2e8f0'; this.style.transform='translateY(-1px)';" 
             onmouseout="this.style.background='#f1f5f9'; this.style.transform='translateY(0)';">
            나중에 보기
          </button>
          <button onclick="goToDesignPageFromNotification()" class="swal2-confirm" style="
            flex: 1;
            padding: 14px 24px;
            background: linear-gradient(135deg, #8b5cf6, #6366f1);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(139, 92, 246, 0.4);
            transition: all 0.2s;
          " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 16px rgba(139, 92, 246, 0.5)';" 
             onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(139, 92, 246, 0.4)';">
            ${isRejected ? '수정하러 가기' : '확인하기'}
          </button>
        </div>
      </div>
    `;
    
    document.body.appendChild(modal);
    
    // 모달 외부 클릭 시 닫기
    modal.addEventListener('click', function(e) {
      if(e.target === modal) {
        window.closeFeedbackNotification();
      }
    });
    
    // ESC 키로 닫기
    const escHandler = function(e) {
      if(e.key === 'Escape') {
        window.closeFeedbackNotification();
        document.removeEventListener('keydown', escHandler);
      }
    };
    document.addEventListener('keydown', escHandler);
  }
  
  // 전역 함수로 설정 (모달 내부에서 호출 가능하도록)
  window.closeFeedbackNotification = function() {
    const modal = document.getElementById('feedback-notification-modal');
    if(modal) {
      modal.style.animation = 'swal2-fade-out 0.15s';
      setTimeout(() => {
        modal.remove();
      }, 150);
    }
  };
  
  window.goToDesignPageFromNotification = function() {
    window.closeFeedbackNotification();
    setTimeout(() => {
      goToDesignPage();
    }, 200);
  };
  
  // 재제출 안내 팝업 표시 (SweetAlert2 스타일)
  function showResubmissionGuide(feedback) {
    // 기존 팝업이 있으면 제거
    const existingPopup = document.getElementById('resubmission-popup');
    if(existingPopup) {
      existingPopup.remove();
    }
    
    const popup = document.createElement('div');
    popup.id = 'resubmission-popup';
    popup.style.cssText = `
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.4);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 9999;
      animation: swal2-fade-in 0.3s;
      font-family: 'Pretendard', -apple-system, BlinkMacSystemFont, system-ui, Roboto, sans-serif;
    `;
    
    popup.innerHTML = `
      <div class="swal2-popup" style="
        background: white;
        border-radius: 17px;
        padding: 0;
        max-width: 500px;
        width: 90%;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
        animation: swal2-show 0.3s;
        overflow: hidden;
        display: flex;
        flex-direction: column;
      ">
        <!-- 아이콘 영역 -->
        <div class="swal2-icon" style="
          width: 80px;
          height: 80px;
          border-radius: 50%;
          margin: 32px auto 20px;
          display: flex;
          align-items: center;
          justify-content: center;
          font-size: 60px;
          background: rgba(254, 242, 242, 0.2);
          border: 4px solid #fecaca;
          animation: swal2-animate-success-icon 0.5s;
        ">
          ⚠️
        </div>
        
        <!-- 제목 -->
        <h2 class="swal2-title" style="
          font-size: 24px;
          font-weight: 700;
          color: #1e293b;
          margin: 0 32px 16px;
          text-align: center;
          line-height: 1.4;
        ">
          피드백을 받았습니다 - 수정 후 재제출해주세요
        </h2>
        
        <!-- 피드백 내용 박스 -->
        <div style="
          background: rgba(254, 242, 242, 0.3);
          border: 1px solid #fecaca;
          border-radius: 12px;
          padding: 20px;
          margin: 0 32px 24px;
          max-height: 200px;
          overflow-y: auto;
        ">
          <div style="
            font-size: 13px;
            font-weight: 700;
            color: #991b1b;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 6px;
          ">
            <span>📝</span>
            <span>선생님 피드백:</span>
          </div>
          <div style="
            font-size: 14px;
            color: #475569;
            line-height: 1.7;
            white-space: pre-wrap;
            word-break: break-word;
          ">
            ${feedback || '피드백이 없습니다.'}
          </div>
        </div>
        
        <!-- 안내 메시지 -->
        <div style="
          background: rgba(239, 68, 68, 0.1);
          border-left: 4px solid #ef4444;
          padding: 12px 20px;
          margin: 0 32px 24px;
          border-radius: 6px;
          font-size: 13px;
          color: #991b1b;
          line-height: 1.6;
        ">
          💡 <strong>안내:</strong> 위 피드백을 참고하여 내용을 수정한 후, 다시 "검사" 버튼을 눌러 검증하고 "제출" 버튼으로 재제출해주세요.
        </div>
        
        <!-- 닫기 버튼 -->
        <div class="swal2-actions" style="
          margin: 0 32px 32px;
          display: flex;
          justify-content: center;
        ">
          <button onclick="closeResubmissionPopup()" class="swal2-confirm" style="
            padding: 14px 40px;
            background: linear-gradient(135deg, #8b5cf6, #6366f1);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(139, 92, 246, 0.4);
            transition: all 0.2s;
          " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 16px rgba(139, 92, 246, 0.5)';" 
             onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(139, 92, 246, 0.4)';">
            확인했습니다
          </button>
        </div>
      </div>
    `;
    
    document.body.appendChild(popup);
    
    // 팝업 외부 클릭 시 닫기
    popup.addEventListener('click', function(e) {
      if(e.target === popup) {
        closeResubmissionPopup();
      }
    });
    
    // ESC 키로 닫기
    const escHandler = function(e) {
      if(e.key === 'Escape') {
        closeResubmissionPopup();
        document.removeEventListener('keydown', escHandler);
      }
    };
    document.addEventListener('keydown', escHandler);
  }
  
  // 재제출 안내 팝업 닫기
  window.closeResubmissionPopup = function() {
    const popup = document.getElementById('resubmission-popup');
    if(popup) {
      popup.style.animation = 'swal2-fade-out 0.15s';
      setTimeout(() => {
        popup.remove();
      }, 150);
    }
  };
  
  // 피드백 알림 확인 및 표시
  function checkFeedbackNotification(id, name) {
    const allSubmissions = JSON.parse(localStorage.getItem('student_submissions') || '[]');
    const mySub = allSubmissions.find(s => s.id === id && s.name === name);
    
    // 제출한 적이 없으면 알림 표시 안 함
    if(!mySub) return false;
    
    // 제출 상태가 pending이면 아직 피드백 없음
    if(mySub.status === 'pending' || !mySub.status) return false;
    
    // 피드백이 실제로 존재하고 비어있지 않은지 확인
    if(!mySub.teacherFeedback || mySub.teacherFeedback.trim() === '') return false;
    
    // 피드백이 있고 아직 확인하지 않은 경우
    const notificationKey = `feedback_notified_${id}_${name}_${mySub.timestamp || 'default'}`;
    const alreadyNotified = localStorage.getItem(notificationKey) === 'true';
    
    if((mySub.status === 'rejected' || mySub.status === 'approved') && !alreadyNotified) {
      // 약간의 지연 후 알림 표시 (페이지 이동 후)
      setTimeout(() => {
        if(typeof window.showFeedbackNotification === 'function') {
          window.showFeedbackNotification(mySub);
        }
      }, 500);
      // 알림 확인 플래그 저장
      localStorage.setItem(notificationKey, 'true');
      return true; // 피드백 있음
    }
    
    return false; // 피드백 없음
  }
  
  // 피드백 알림 모달 표시 (SweetAlert2 스타일) - 전역 함수
  window.showFeedbackNotification = function(submission) {
    const isRejected = submission.status === 'rejected';
    
    // 기존 모달이 있으면 제거
    const existingModal = document.getElementById('feedback-notification-modal');
    if(existingModal) {
      existingModal.remove();
    }
    
    const modal = document.createElement('div');
    modal.id = 'feedback-notification-modal';
    modal.style.cssText = `
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.4);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 10000;
      animation: swal2-fade-in 0.3s;
      font-family: 'Pretendard', -apple-system, BlinkMacSystemFont, system-ui, Roboto, sans-serif;
    `;
    
    // SweetAlert2 스타일의 모달 박스
    modal.innerHTML = `
      <div class="swal2-popup" style="
        background: white;
        border-radius: 17px;
        padding: 0;
        max-width: 478px;
        width: 90%;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
        animation: swal2-show 0.3s;
        overflow: hidden;
        display: flex;
        flex-direction: column;
      ">
        <!-- 아이콘 영역 -->
        <div class="swal2-icon" style="
          width: 80px;
          height: 80px;
          border-radius: 50%;
          margin: 32px auto 20px;
          display: flex;
          align-items: center;
          justify-content: center;
          font-size: 60px;
          background: ${isRejected ? 'rgba(254, 242, 242, 0.2)' : 'rgba(237, 233, 254, 0.2)'};
          border: 4px solid ${isRejected ? '#fecaca' : '#c4b5fd'};
          animation: swal2-animate-success-icon 0.5s;
        ">
          ${isRejected ? '⚠️' : '🎉'}
        </div>
        
        <!-- 제목 -->
        <h2 class="swal2-title" style="
          font-size: 24px;
          font-weight: 700;
          color: #1e293b;
          margin: 0 32px 16px;
          text-align: center;
          line-height: 1.4;
        ">
          ${isRejected ? '피드백을 받았습니다' : '과제가 승인되었습니다!'}
        </h2>
        
        <!-- 설명 -->
        <div class="swal2-html-container" style="
          margin: 0 32px 24px;
          text-align: center;
          font-size: 15px;
          color: #64748b;
          line-height: 1.6;
        ">
          ${isRejected ? '선생님께서 피드백을 남겨주셨습니다.<br>확인 후 수정하여 재제출해주세요.' : '축하합니다! 선생님께서 과제를 승인하셨습니다.'}
        </div>
        
        <!-- 피드백 내용 박스 -->
        <div style="
          background: ${isRejected ? 'rgba(254, 242, 242, 0.3)' : 'rgba(237, 233, 254, 0.3)'};
          border: 1px solid ${isRejected ? '#fecaca' : '#c4b5fd'};
          border-radius: 12px;
          padding: 20px;
          margin: 0 32px 24px;
          max-height: 250px;
          overflow-y: auto;
        ">
          <div style="
            font-size: 13px;
            font-weight: 700;
            color: ${isRejected ? '#991b1b' : '#6d28d9'};
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 6px;
          ">
            <span>📝</span>
            <span>선생님 피드백:</span>
          </div>
          <div style="
            font-size: 14px;
            color: #475569;
            line-height: 1.7;
            white-space: pre-wrap;
            word-break: break-word;
          ">
            ${submission.teacherFeedback || '피드백이 없습니다.'}
          </div>
        </div>
        
        <!-- 버튼 영역 -->
        <div class="swal2-actions" style="
          margin: 0 32px 32px;
          display: flex;
          gap: 12px;
        ">
          <button onclick="closeFeedbackNotification()" class="swal2-cancel" style="
            flex: 1;
            padding: 14px 24px;
            background: #f1f5f9;
            color: #475569;
            border: none;
            border-radius: 8px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
          " onmouseover="this.style.background='#e2e8f0'; this.style.transform='translateY(-1px)';" 
             onmouseout="this.style.background='#f1f5f9'; this.style.transform='translateY(0)';">
            나중에 보기
          </button>
          <button onclick="goToDesignPageFromNotification()" class="swal2-confirm" style="
            flex: 1;
            padding: 14px 24px;
            background: linear-gradient(135deg, #8b5cf6, #6366f1);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(139, 92, 246, 0.4);
            transition: all 0.2s;
          " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 16px rgba(139, 92, 246, 0.5)';" 
             onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(139, 92, 246, 0.4)';">
            ${isRejected ? '수정하러 가기' : '확인하기'}
          </button>
        </div>
      </div>
    `;
    
    document.body.appendChild(modal);
    
    // 모달 외부 클릭 시 닫기
    modal.addEventListener('click', function(e) {
      if(e.target === modal) {
        window.closeFeedbackNotification();
      }
    });
    
    // ESC 키로 닫기
    const escHandler = function(e) {
      if(e.key === 'Escape') {
        window.closeFeedbackNotification();
        document.removeEventListener('keydown', escHandler);
      }
    };
    document.addEventListener('keydown', escHandler);
  };
  
  // 전역 함수로 설정 (모달 내부 onclick에서 호출 가능하도록)
  window.closeFeedbackNotification = function() {
    const modal = document.getElementById('feedback-notification-modal');
    if(modal) {
      modal.style.animation = 'swal2-fade-out 0.15s';
      setTimeout(() => {
        modal.remove();
      }, 150);
    }
  };
  
  window.goToDesignPageFromNotification = function() {
    window.closeFeedbackNotification();
    setTimeout(() => {
      goToDesignPage();
    }, 200);
  };

  // 스텝 전환 함수 제거 (한 페이지로 통합됨)

  // 예시 불러오기 (AI로 새로운 예시 생성)
  async function loadExample() {
    const btn = document.getElementById('load-example-btn');
    if(btn) {
      btn.disabled = true;
      btn.textContent = '🎲 예시 생성 중...';
    }
    
    try {
      const apiKey = getApiKey();
      if(!apiKey) {
        alert('⚠️ OpenAI API 키가 설정되지 않았습니다.\n.env 파일에 VITE_OPENAI_API_KEY를 설정해주세요.');
        if(btn) {
          btn.disabled = false;
          btn.textContent = '🎲 예시 불러오기 (따라 쓰기 금지!)';
        }
        return;
      }
      
      // SDGs 목표 중 하나를 랜덤하게 선택 (1-17)
      const randomSDG = Math.floor(Math.random() * 17) + 1;
      
      const prompt = `당신은 중학생을 위한 창의적 문제해결 교육 전문가입니다. 초음파 센서(HC-SR04, 측정 범위 2cm~400cm)를 활용한 SDGs 목표 ${randomSDG} 관련 문제 해결 아이디어를 하나 만들어주세요.

다음 JSON 형식으로만 응답하세요 (다른 텍스트 없이):
{
  "problem": "구체적인 문제 상황 설명 (50자 이상, 현실적이고 구체적으로)",
  "sdg": "${randomSDG}",
  "distance": "20~100 사이의 합리적인 거리(cm)",
  "conditionOn": "초음파 센서가 [거리]cm 이내의 물체(사람)를 감지하면",
  "conditionOff": "물체가 [거리]cm 이상 멀어지거나 또는 특정 시간이 지나면",
  "actionsOn": [
    {"device": "💡 LED", "action": "구체적인 동작 설명"},
    {"device": "🔊 스피커", "action": "구체적인 동작 설명 (선택사항)"}
  ],
  "actionsOff": [
    {"device": "💡 LED", "action": "구체적인 동작 설명"},
    {"device": "🦾 서보모터", "action": "구체적인 동작 설명 (선택사항)"}
  ],
  "scenario": "전체 작동 과정을 한 문단으로 설명 (80자 이상, SDGs 목표와의 연관성 포함)"
}

중요 사항:
- 매번 완전히 다른 주제와 상황으로 생성해주세요 (물 절약, 에너지 절약, 안전, 환경 등 다양한 주제)
- 거리는 20~100cm 사이의 현실적인 값
- 장치는 💡 LED, 🔊 스피커, 🦾 서보모터, 📟 디스플레이, 🌀 DC모터 중에서 선택
- 초음파 센서의 한계(거리만 측정 가능, 물체 종류 구별 불가)를 고려한 현실적인 아이디어`;

      const response = await fetch('https://api.openai.com/v1/chat/completions', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${apiKey}`
        },
        body: JSON.stringify({
          model: 'gpt-4o-mini',
          messages: [
            {
              role: 'system',
              content: 'You are a helpful assistant that provides creative problem-solving ideas in JSON format only, without any additional text.'
            },
            {
              role: 'user',
              content: prompt
            }
          ],
          temperature: 1.0, // 다양성을 위해 높은 temperature 사용
          max_tokens: 1500
        })
      });
      
      if(!response.ok) {
        throw new Error(`API 오류: ${response.status}`);
      }
      
      const result = await response.json();
      const content = result.choices[0].message.content.trim();
      
      // JSON 파싱
      let ex;
      try {
        const jsonMatch = content.match(/\{[\s\S]*\}/);
        if(jsonMatch) {
          ex = JSON.parse(jsonMatch[0]);
        } else {
          ex = JSON.parse(content);
        }
      } catch(e) {
        console.error('JSON 파싱 오류:', e, content);
        alert('예시 생성 중 오류가 발생했습니다. 다시 시도해주세요.');
        if(btn) {
          btn.disabled = false;
          btn.textContent = '🎲 예시 불러오기 (따라 쓰기 금지!)';
        }
        return;
      }
      
      // 폼에 데이터 채우기
      document.getElementById('inp-problem').value = ex.problem || '';
      
      // SDG 선택 복원
      if(ex.sdg) {
        const sdgNum = parseInt(ex.sdg);
        if(sdgNum >= 1 && sdgNum <= 17) {
          // SDG 데이터에서 찾아서 선택
          if(typeof sdgData !== 'undefined' && sdgData[sdgNum - 1]) {
            setTimeout(() => {
              selectSDGOption(sdgData[sdgNum - 1]);
            }, 100);
          } else {
            // 드롭다운이 없으면 직접 설정 (숨겨진 select 사용)
            const hiddenSelect = document.getElementById('inp-sdg');
            if(hiddenSelect) {
              hiddenSelect.value = ex.sdg;
            }
          }
        }
      }
      
      // 거리 기준 설정 및 threshold 업데이트
      const distValue = ex.distance || '30';
      document.getElementById('inp-dist').value = distValue;
      
      // threshold 값 업데이트
      const trueThreshold = document.getElementById('true-threshold');
      const falseThreshold = document.getElementById('false-threshold');
      if(trueThreshold) trueThreshold.textContent = distValue;
      if(falseThreshold) falseThreshold.textContent = distValue;
      
      updateSensorDesign();
      
      // 조건 설정
      const condOnInput = document.getElementById('inp-cond-on');
      const condOffInput = document.getElementById('inp-cond-off');
      if(condOnInput) condOnInput.value = ex.conditionOn || '';
      if(condOffInput) condOffInput.value = ex.conditionOff || '';
      
      // 동작 설정
      const trueList = document.getElementById('true-actions');
      const falseList = document.getElementById('false-actions');
      
      // true-actions 설정
      if(trueList && ex.actionsOn && Array.isArray(ex.actionsOn) && ex.actionsOn.length > 0) {
        trueList.innerHTML = '';
        // 모든 동작 행 추가
        ex.actionsOn.forEach(() => {
          addActionRow('true-actions');
        });
        
        // 값 설정 (DOM이 준비될 때까지 약간의 지연)
        setTimeout(() => {
          const rows = trueList.querySelectorAll('.action-row');
          ex.actionsOn.forEach((action, idx) => {
            if(rows[idx]) {
              const select = rows[idx].querySelector('select');
              const detailInput = rows[idx].querySelector('.action-detail');
              if(select && detailInput) {
                // 장치 매칭
                const deviceMap = {
                  '💡 LED': '💡 LED',
                  '🔊 스피커': '🔊 스피커',
                  '🦾 서보모터': '🦾 서보모터',
                  '📟 디스플레이': '📟 디스플레이',
                  '🌀 DC모터': '🌀 DC모터'
                };
                if(deviceMap[action.device]) {
                  select.value = deviceMap[action.device];
                  select.dispatchEvent(new Event('change'));
                } else if(action.device) {
                  select.value = 'custom';
                  handleDeviceChange(select);
                  const customInput = rows[idx].querySelector('.custom-device-input');
                  if(customInput) {
                    customInput.value = action.device.replace('🔧 ', '').trim();
                  }
                }
                detailInput.value = action.action || '';
              }
            }
          });
          updateSensorDesign();
        }, 100);
      }
      
      // false-actions 설정
      if(falseList && ex.actionsOff && Array.isArray(ex.actionsOff) && ex.actionsOff.length > 0) {
        falseList.innerHTML = '';
        // 모든 동작 행 추가
        ex.actionsOff.forEach(() => {
          addActionRow('false-actions');
        });
        
        // 값 설정
        setTimeout(() => {
          const rows = falseList.querySelectorAll('.action-row');
          ex.actionsOff.forEach((action, idx) => {
            if(rows[idx]) {
              const select = rows[idx].querySelector('select');
              const detailInput = rows[idx].querySelector('.action-detail');
              if(select && detailInput) {
                const deviceMap = {
                  '💡 LED': '💡 LED',
                  '🔊 스피커': '🔊 스피커',
                  '🦾 서보모터': '🦾 서보모터',
                  '📟 디스플레이': '📟 디스플레이',
                  '🌀 DC모터': '🌀 DC모터'
                };
                if(deviceMap[action.device]) {
                  select.value = deviceMap[action.device];
                  select.dispatchEvent(new Event('change'));
                } else if(action.device) {
                  select.value = 'custom';
                  handleDeviceChange(select);
                  const customInput = rows[idx].querySelector('.custom-device-input');
                  if(customInput) {
                    customInput.value = action.device.replace('🔧 ', '').trim();
                  }
                }
                detailInput.value = action.action || '';
              }
            }
          });
          updateSensorDesign();
        }, 150);
      }
      
      document.getElementById('inp-scenario').value = ex.scenario || '';
      
      // 미리보기 업데이트
      setTimeout(() => {
        updateSensorDesign();
        updateAlgorithmPreview();
      }, 500);

      // 표절 검사용 저장 (표절 검사는 예시 내용을 그대로 사용했는지 확인)
      lastLoadedExample = {
        problem: ex.problem,
        scenario: ex.scenario
      };
      
      if(btn) {
        btn.disabled = false;
        btn.textContent = '🎲 예시 불러오기 (따라 쓰기 금지!)';
      }
      
      alert("✨ 새로운 예시를 생성했습니다! 내용을 반드시 수정해서 제출하세요!");
    } catch(error) {
      console.error('예시 생성 오류:', error);
      alert('⚠️ 예시 생성 중 오류가 발생했습니다.\n\n' + error.message + '\n\n.env 파일에 VITE_OPENAI_API_KEY가 올바르게 설정되어 있는지 확인해주세요.');
      if(btn) {
        btn.disabled = false;
        btn.textContent = '🎲 예시 불러오기 (따라 쓰기 금지!)';
      }
    }
  }

  // 표절 검사
  function checkPlagiarism() {
    if(!lastLoadedExample) return false;
    const currProb = document.getElementById('inp-problem').value.trim();
    const currScen = document.getElementById('inp-scenario').value.trim();
    return (currProb === lastLoadedExample.problem || currScen === lastLoadedExample.scenario);
  }

  // 채팅 메시지 추가
  function addChat(msg, type='ai') {
    const box = document.getElementById('chat-box');
    box.style.display = 'flex';
    const bubble = document.createElement('div');
    bubble.className = `chat-bubble chat-${type}`;
    bubble.innerHTML = msg;
    box.appendChild(bubble);
    box.scrollTop = box.scrollHeight;
  }

  // 상세 검사 및 피드백 제공
  function checkAssignment() {
    const box = document.getElementById('chat-box');
    box.style.display = 'flex';
    box.innerHTML = ''; // 초기화
    
    addChat("📄 내용을 분석 중입니다...", "ai");

    setTimeout(async () => {
      isChecked = false; // 초기화
      
      // 1. 표절 검사
      if(checkPlagiarism()) {
        addChat("🚨 <strong>[검사 실패] 표절이 의심됩니다.</strong><br>예시 내용을 그대로 사용하지 말고, 본인의 생각으로 수정해주세요.", "warn");
        addChat("내용을 수정한 후 다시 검사해주세요.", "warn");
        disableSubmitButton();
        return;
      }

      // 2. 기본 검증
      const prob = document.getElementById('inp-problem').value.trim();
      const scen = document.getElementById('inp-scenario').value.trim();
      const sdg = document.getElementById('inp-sdg').value;
      const dist = document.getElementById('inp-dist').value.trim();
      const condOn = document.getElementById('inp-cond-on').value.trim();
      const condOff = document.getElementById('inp-cond-off').value.trim();
      
      // 새로운 구조에서 동작 가져오기
      const trueActions = getActionsFromUI('true-actions');
      const falseActions = getActionsFromUI('false-actions');
      
      // 첫 번째 동작을 기본값으로 사용 (기존 코드 호환)
      const devOn = trueActions.length > 0 ? trueActions[0].device : '';
      const actOn = trueActions.length > 0 ? trueActions[0].action.trim() : '';
      const devOff = falseActions.length > 0 ? falseActions[0].device : '';
      const actOff = falseActions.length > 0 ? falseActions[0].action.trim() : '';

      let warnings = [];
      let suggestions = [];
      
      // 문제 정의 검증
      if(prob.length < 30) {
        warnings.push("문제 정의가 너무 짧습니다. 구체적인 상황과 문제점을 더 자세히 설명해주세요.");
      }
      if(!prob.includes('문제') && !prob.includes('불편') && !prob.includes('낭비') && !prob.includes('위험')) {
        suggestions.push("문제 상황을 더 명확하게 드러내는 표현을 사용해보세요 (예: '문제', '불편', '낭비', '위험' 등).");
      }
      
      // SDG 관련성 검증
      if(!sdg) {
        warnings.push("SDGs 목표를 선택해주세요. 해결하고자 하는 문제와 가장 관련이 깊은 목표를 선택하세요.");
      }
      
      // 거리 기준 검증
      if(!dist || isNaN(dist) || dist < 5 || dist > 500) {
        warnings.push("거리 기준을 5cm~500cm 사이의 합리적인 값으로 설정해주세요.");
      } else {
        const distNum = parseInt(dist);
        if(distNum < 10) {
          suggestions.push("거리 기준이 너무 작습니다. 10cm 이상이면 더 안정적으로 작동할 수 있습니다.");
        } else if(distNum > 200) {
          suggestions.push("거리 기준이 너무 큽니다. 실제 환경을 고려하여 조정해보세요.");
        }
      }
      
      // 조건 명확성 검증
      if(condOn.length < 10 || condOff.length < 10) {
        warnings.push("센서 감지 조건을 더 구체적으로 설명해주세요. (예: '30cm 안으로 들어오면', '30cm 이상 멀어지면')");
      }
      if(!condOn.includes(dist) || !condOff.includes(dist)) {
        suggestions.push("감지 조건에 설정한 거리 기준(" + dist + "cm)을 명확히 포함해주세요.");
      }
      
      // 동작 존재 여부 검증
      if(trueActions.length === 0) {
        warnings.push("가까울 때(ON) 동작을 최소 하나 이상 추가해주세요.");
      }
      if(falseActions.length === 0) {
        warnings.push("멀 때(OFF) 동작을 최소 하나 이상 추가해주세요.");
      }
      
      // 동작 구체성 검증
      trueActions.forEach((action, idx) => {
        if(!action.action || action.action.trim().length < 5) {
          warnings.push(`가까울 때 ${idx + 1}번째 동작을 더 구체적으로 설명해주세요. (예: '조명 켜기', '90도 회전')`);
        }
      });
      falseActions.forEach((action, idx) => {
        if(!action.action || action.action.trim().length < 5) {
          warnings.push(`멀 때 ${idx + 1}번째 동작을 더 구체적으로 설명해주세요.`);
        }
      });
      
      // 시나리오 충실도
      if(scen.length < 50) {
        warnings.push("시나리오를 더 구체적으로 작성해주세요. (최소 50자 이상 권장)");
      }
      if(!scen.includes(prob.substring(0, 10))) {
        suggestions.push("시나리오에 제시한 문제와의 연결고리를 더 명확히 해주세요.");
      }
      
      // SDGs 관련성 확인
      if(sdg && scen.length > 0) {
        const sdgNames = {
          '3': '건강', '4': '교육', '6': '물', '7': '에너지',
          '11': '도시', '12': '소비', '13': '기후', '14': '해양', '15': '육상'
        };
        const sdgName = sdgNames[sdg];
        if(sdgName && !scen.includes(sdgName) && !scen.includes('SDG') && !scen.includes('목표')) {
          suggestions.push("시나리오에 선택한 SDGs 목표(" + sdgNames[sdg] + ")와의 연관성을 더 명확히 설명해주세요.");
        }
      }

      // 실현 가능성 체크
      if(condOn.includes('사람') || condOn.includes('강아지') || condOn.includes('고양이')) {
        suggestions.push("💡 초음파 센서는 물체 종류를 구별하지 못합니다. '물체', '장애물' 등으로 표현하는 것이 더 정확합니다.");
      }
      
      if(condOn.includes('소리') || condOn.includes('냄새') || condOn.includes('빛')) {
        warnings.push("⚠️ 초음파 센서는 거리만 측정 가능합니다. 소리, 냄새, 빛 등은 감지하지 못합니다.");
      }

      // 기본 검증 실패 시
      if(warnings.length > 0) {
        displayAIFeedback({
          generalFeedback: warnings.length > 0 ? "기본 검증에서 수정이 필요한 부분이 발견되었습니다." : null,
          improvements: warnings,
          questions: []
        }, warnings.length > 0);
        disableSubmitButton();
        return;
      }

      // 기본 검증 통과 - AI 피드백 요청
      const sdgSelectEl = document.getElementById('inp-sdg');
      const sdgText = sdgSelectEl ? sdgSelectEl.options[sdgSelectEl.selectedIndex]?.text || '' : '';
      const apiKey = getApiKey();
      
      if(apiKey) {
        // AI API 호출
        addChat("🤖 AI 설계 코치가 피드백을 분석 중입니다...", "ai");
        requestAIFeedback({
          problem: prob,
          sdg: sdgText,
          distance: dist,
          conditionOn: condOn,
          conditionOff: condOff,
          actionsOn: trueActions,
          actionsOff: falseActions,
          scenario: scen
        }).then(aiFeedback => {
          displayAIFeedback(aiFeedback, false);
          isChecked = true;
          enableSubmitButton();
        }).catch(err => {
          console.error('AI 피드백 오류:', err);
          // AI 오류 시 기본 피드백만 표시
          displayBasicFeedback(suggestions, sdg);
          isChecked = true;
          enableSubmitButton();
        });
      } else {
        // API 키가 없으면 기본 피드백만 표시
        displayBasicFeedback(suggestions, sdg);
        isChecked = true;
        enableSubmitButton();
      }
    }, 1500);
  }

  // Google Form에 데이터 제출 함수 (강의자료 방식 적용)
  async function submitToGoogleForm(data) {
    const googleFormUrl = 'https://docs.google.com/forms/d/e/1FAIpQLSfn4OPaqKJudaGZXAnUdPdQAe9aFIcfuArIxzEg0Gqk7R7euA/formResponse';
    
    // FormData 생성 (강의자료 방식)
    const formData = new FormData();
    formData.append('entry.1839667691', data.id || ''); // 학번
    formData.append('entry.1826774088', data.name || ''); // 이름
    formData.append('entry.607276148', data.problem || ''); // 문제 설명
    formData.append('entry.818573526', data.sdg || ''); // SDGs 목표 번호
    formData.append('entry.248286985', data.scenario || ''); // 시나리오
    
    try {
      // no-cors 모드로 제출 (강의자료 방식)
      // 응답을 읽을 수 없지만 제출은 성공
      const response = await fetch(googleFormUrl, {
        method: 'POST',
        mode: 'no-cors',
        body: formData
      });
      
      console.log('Google Form 제출 성공:', {
        id: data.id,
        name: data.name,
        sdg: data.sdg,
        problem: data.problem ? data.problem.substring(0, 50) + '...' : ''
      });
      
      return true;
    } catch(error) {
      // no-cors 모드에서는 네트워크 오류만 catch되며, 실제 제출은 성공할 수 있음
      console.warn('Google Form 제출 시도 완료 (no-cors 모드이므로 응답 확인 불가):', error);
      // 제출은 성공했을 가능성이 높음
      return true;
    }
  }

  // 제출 로직 (검사 통과 후에만 실행)
  function submitAssignment() {
    if(!isChecked) {
      alert("먼저 '검사' 버튼을 눌러 검사를 통과해야 제출할 수 있습니다.");
      return;
    }

    const box = document.getElementById('chat-box');
    box.style.display = 'flex';
    
    addChat("📤 제출 중입니다...", "ai");

    setTimeout(() => {
      const prob = document.getElementById('inp-problem').value.trim();
      const scen = document.getElementById('inp-scenario').value.trim();
      const sdgEl = document.getElementById('inp-sdg');
      const sdgValue = sdgEl ? sdgEl.value : '';
      const sdgText = sdgEl && sdgEl.selectedIndex >= 0 ? sdgEl.options[sdgEl.selectedIndex].text : '';
      const dist = document.getElementById('inp-dist').value.trim();
      const condOn = document.getElementById('inp-cond-on').value.trim();
      const condOff = document.getElementById('inp-cond-off').value.trim();
      
      // 새로운 구조에서 동작 가져오기
      const trueActions = getActionsFromUI('true-actions');
      const falseActions = getActionsFromUI('false-actions');

      // 제출 데이터 저장 (모든 필드 포함)
      const submission = {
        id: currentUser.id,
        name: currentUser.name,
        timestamp: new Date().toISOString(),
        problem: prob,
        sdg: sdgValue, // 숫자 값 저장
        sdgText: sdgText, // 텍스트도 저장
        distance: dist,
        conditionOn: condOn,
        conditionOff: condOff,
        actionsOn: trueActions, // 배열로 저장
        actionsOff: falseActions, // 배열로 저장
        scenario: scen,
        status: 'pending', // 대기중
        teacherFeedback: ''
      };

      // 기존 데이터 로드 및 갱신
      let allData = JSON.parse(localStorage.getItem('student_submissions') || '[]');
      const idx = allData.findIndex(d => d.id === currentUser.id && d.name === currentUser.name);
      
      if(idx >= 0) {
        // 기존 제출이 있는 경우, 기존 피드백은 유지하되 새 데이터로 업데이트
        const existing = allData[idx];
        submission.teacherFeedback = existing.teacherFeedback || ''; // 기존 피드백 유지
        // 이전 제출의 알림 플래그는 유지 (새 제출이므로 다시 알림 가능하도록)
        // 새로운 timestamp가 생성되므로 알림 플래그도 새로 생성됨
        allData[idx] = submission;
      } else {
        allData.push(submission);
      }
      
      localStorage.setItem('student_submissions', JSON.stringify(allData));
      
      // 학년/반 추출하여 자동으로 학급에 배정
      assignStudentToClassById(currentUser.id, currentUser.name);

      // Google Form에 자동 제출
      submitToGoogleForm({
        id: currentUser.id,
        name: currentUser.name,
        problem: prob,
        sdg: sdgValue,
        scenario: scen
      });

      addChat("✅ <strong>제출 성공!</strong> 선생님께 전송되었습니다.", "success");
      addChat("선생님의 승인을 기다려주세요.", "success");
      
      loadMySubmission(); // 상태 배너 갱신

      // 제출 버튼 다시 비활성화
      isChecked = false;
      disableSubmitButton();
      
      // 네비게이션 버튼 상태 업데이트 (제출 완료로 다음 페이지 이동 가능)
      setTimeout(() => {
        updateNavigationButtons();
      }, 200);

    }, 500);
  }

  // 제출 버튼 활성화/비활성화 함수
  function enableSubmitButton() {
    const btnSubmit = document.getElementById('btn-submit');
    btnSubmit.disabled = false;
    btnSubmit.style.opacity = '1';
    btnSubmit.style.cursor = 'pointer';
  }

  function disableSubmitButton() {
    const btnSubmit = document.getElementById('btn-submit');
    btnSubmit.disabled = true;
    btnSubmit.style.opacity = '0.5';
    btnSubmit.style.cursor = 'not-allowed';
  }

  // 내 제출 상태 확인 및 UI 잠금
  function loadMySubmission() {
    const allData = JSON.parse(localStorage.getItem('student_submissions') || '[]');
    const mySub = allData.find(d => d.id === currentUser.id && d.name === currentUser.name);
    
    const banner = document.getElementById('status-banner');
    const statusMsg = document.getElementById('status-msg');
    const statusLabel = document.getElementById('status-label');
    
    // 초기화
    banner.style.display = 'none';
    toggleInputs(true); // 입력 가능

    if(mySub) {
      banner.style.display = 'flex';
      banner.className = `status-banner ${mySub.status}`;
      
      // 필드 값 복구 (재로그인 시 또는 피드백 받고 수정할 때)
      // 모든 상태에서 기존 작성 내용 복구
      if(mySub.problem) {
        const probEl = document.getElementById('inp-problem');
        if(probEl) probEl.value = mySub.problem;
      }
      if(mySub.scenario) {
        const scenEl = document.getElementById('inp-scenario');
        if(scenEl) scenEl.value = mySub.scenario;
      }
      
      // SDGs 선택 복구
      if(mySub.sdg) {
        const sdgEl = document.getElementById('inp-sdg');
        if(sdgEl) {
          sdgEl.value = mySub.sdg;
          // SDGs 드롭다운 UI도 업데이트
          setTimeout(() => {
            restoreSDGSelection(mySub.sdg);
          }, 100);
        }
      }
      
      // 센서 설계 데이터 복구
      if(mySub.distance) {
        const distEl = document.getElementById('inp-dist');
        if(distEl) distEl.value = mySub.distance;
      }
      if(mySub.conditionOn) {
        const condOnEl = document.getElementById('inp-cond-on');
        if(condOnEl) condOnEl.value = mySub.conditionOn;
      }
      if(mySub.conditionOff) {
        const condOffEl = document.getElementById('inp-cond-off');
        if(condOffEl) condOffEl.value = mySub.conditionOff;
      }
      
      // 동작 데이터 복구 (새로운 구조)
      // DOM이 완전히 준비된 후 복구하도록 지연
      setTimeout(() => {
        // actionsOn이 있으면 복구, 없으면 기본 행 하나 추가
        if(mySub.actionsOn && Array.isArray(mySub.actionsOn) && mySub.actionsOn.length > 0) {
          restoreActions('true-actions', mySub.actionsOn);
        } else {
          // 기존 데이터 구조 호환성 (dev_on, act_on)
          if(mySub.dev_on && mySub.act_on) {
            restoreActions('true-actions', [{
              device: mySub.dev_on.includes('servo') ? '🦾 서보모터' : '💡 LED',
              action: mySub.act_on
            }]);
          }
        }
        
        // actionsOff가 있으면 복구, 없으면 기본 행 하나 추가
        if(mySub.actionsOff && Array.isArray(mySub.actionsOff) && mySub.actionsOff.length > 0) {
          restoreActions('false-actions', mySub.actionsOff);
        } else {
          // 기존 데이터 구조 호환성 (dev_off, act_off)
          if(mySub.dev_off && mySub.act_off) {
            restoreActions('false-actions', [{
              device: mySub.dev_off.includes('servo') ? '🦾 서보모터' : '💡 LED',
              action: mySub.act_off
            }]);
          }
        }
        
        // 센서 설계 UI 업데이트
        updateSensorDesign();
        updateAlgorithmPreview();
      }, 400);

      if(mySub.status === 'pending') {
        statusMsg.innerHTML = "⏳ <strong>선생님 확인 대기 중입니다.</strong> (수정 불가)";
        statusLabel.textContent = "검토중";
        toggleInputs(false); // 잠금
      } else if(mySub.status === 'approved') {
        statusMsg.innerHTML = `🎉 <strong>과제 승인 완료!</strong> (피드백: ${mySub.teacherFeedback || '없음'})`;
        statusLabel.textContent = "완료";
        toggleInputs(false); // 잠금
      } else if(mySub.status === 'rejected') {
        // 피드백이 실제로 있는 경우에만 표시
        if(mySub.teacherFeedback && mySub.teacherFeedback.trim() !== '') {
          statusMsg.innerHTML = `⚠️ <strong>반려되었습니다. 수정 후 재제출하세요.</strong>`;
          statusLabel.textContent = "수정요망";
          toggleInputs(true); // 잠금 해제
          
          // 재제출 안내 카드 표시
          showResubmissionGuide(mySub.teacherFeedback);
        } else {
          // 피드백이 없으면 일반 대기 상태로 표시
          statusMsg.innerHTML = `⏳ <strong>제출 완료</strong> - 선생님의 검토를 기다리고 있습니다.`;
          statusLabel.textContent = "대기중";
          toggleInputs(false); // 잠금
        }
      }
    }
  }

  function toggleInputs(enable) {
    // 아이디어 설계 페이지(view-student-main)에만 적용
    const designPage = document.getElementById('view-student-main');
    if(!designPage || !designPage.classList.contains('active')) {
      // 설계 페이지가 활성화되어 있지 않으면 실행하지 않음
      return;
    }
    
    const inputs = designPage.querySelectorAll('input, textarea, select, #btn-check, #btn-submit');
    inputs.forEach(el => {
      if(el.id === 'btn-submit' && !enable) {
        // 입력 잠금 시 제출 버튼도 잠금
        el.disabled = true;
        el.style.opacity = '0.5';
        el.style.cursor = 'not-allowed';
      } else {
        el.disabled = !enable;
      }
    });
    if(!enable) {
      isChecked = false; // 입력 잠금 시 검사 상태도 초기화
    }
  }

  /* =========================================
     TEACHER LOGIC
     ========================================= */
  function teacherLogin() {
    const pw = document.getElementById('tea-pw').value;
    if(pw === TEACHER_PW) {
      showDashboard();
    } else {
      alert('비밀번호가 틀렸습니다.');
    }
  }

  function showDashboard() {
    showView('view-teacher-dashboard');
    renderTeacherDashboard();
  }
  
  // Google Form 응답 확인 및 일괄 제출 함수 (선택된 학급만)
  async function submitAllToGoogleForm() {
    const formId = '1FAIpQLSfn4OPaqKJudaGZXAnUdPdQAe9aFIcfuArIxzEg0Gqk7R7euA';
    const formURL = `https://docs.google.com/forms/d/e/${formId}/formResponse`;
    
    // 현재 선택된 학급 확인
    const selectedClassId = localStorage.getItem('selected_class');
    
    // localStorage에서 학생 제출 데이터 가져오기
    const allSubmissions = JSON.parse(localStorage.getItem('student_submissions') || '[]');
    
    // 선택된 학급의 학생들만 필터링
    let studentsToSubmit = [];
    
    if (!selectedClassId || selectedClassId === 'class_all') {
      // "전체" 학급이 선택된 경우 모든 학생
      studentsToSubmit = allSubmissions;
    } else {
      // 특정 학급이 선택된 경우 해당 학급 학생만 필터링
      const classes = JSON.parse(localStorage.getItem('teacher_classes') || '[]');
      const classItem = classes.find(c => c.id === selectedClassId);
      
      if (!classItem) {
        alert('선택된 학급을 찾을 수 없습니다.');
        return;
      }
      
      const classStudents = classItem.students || [];
      
      // 학급에 속한 학생들의 제출 데이터만 필터링
      studentsToSubmit = allSubmissions.filter(submission => {
        const studentKey = `${submission.id}|${submission.name}`;
        return classStudents.includes(studentKey);
      });
    }
    
    if (studentsToSubmit.length === 0) {
      const classInfo = selectedClassId && selectedClassId !== 'class_all' 
        ? `선택한 학급에 제출된 학생 데이터가 없습니다.`
        : `제출할 학생 데이터가 없습니다.`;
      alert(classInfo);
      return;
    }
    
    // 제출 진행
    const submitCount = studentsToSubmit.length;
    const className = selectedClassId && selectedClassId !== 'class_all'
      ? (() => {
          const classes = JSON.parse(localStorage.getItem('teacher_classes') || '[]');
          const classItem = classes.find(c => c.id === selectedClassId);
          return classItem ? classItem.name : '선택한 학급';
        })()
      : '전체';
    
    // 각 학생 데이터를 Google Form에 제출 (강의자료 방식)
    studentsToSubmit.forEach((student, index) => {
      setTimeout(() => {
        fetch(formURL, {
          method: 'POST',
          mode: 'no-cors',
          headers: {
            'Content-Type': 'application/x-www-form-urlencoded'
          },
          body: new URLSearchParams({
            'entry.1839667691': student.id || '',        // 학번
            'entry.1826774088': student.name || '',      // 이름
            'entry.607276148': student.problem || '',    // 문제 설명
            'entry.818573526': student.sdg || '',        // SDGs 목표 번호
            'entry.248286985': student.scenario || ''    // 시나리오
          })
        });
        console.log(`제출 시도: ${student.name} (${index + 1}/${submitCount})`);
      }, index * 300);
    });
    
    // 완료 메시지 (링크 열기 없이 알림만)
    alert(
      `✅ ${className} ${submitCount}명의 데이터가 Google Form으로 전송되었습니다!\n\n` +
      `Google Form에서 응답을 확인하세요.\n\n` +
      `Form 편집 페이지:\n` +
      `https://docs.google.com/forms/d/${formId}/edit\n\n` +
      `※ Form 소유자 계정으로 로그인 후 "응답" 탭에서 확인하실 수 있습니다.`
    );
  }
  
  // 기존 함수명 유지 (호환성)
  function openGoogleFormResponses() {
    submitAllToGoogleForm();
  }
  
  // 학생 데이터 CSV 다운로드 함수 (선택된 학급만)
  function downloadStudentDataCSV() {
    // 현재 선택된 학급 확인
    const selectedClassId = localStorage.getItem('selected_class');
    
    // localStorage에서 학생 제출 데이터 가져오기
    const allSubmissions = JSON.parse(localStorage.getItem('student_submissions') || '[]');
    
    // 선택된 학급의 학생들만 필터링
    let studentsToExport = [];
    let className = '전체';
    
    if (!selectedClassId || selectedClassId === 'class_all') {
      // "전체" 학급이 선택된 경우 모든 학생
      studentsToExport = allSubmissions;
      className = '전체';
    } else {
      // 특정 학급이 선택된 경우 해당 학급 학생만 필터링
      const classes = JSON.parse(localStorage.getItem('teacher_classes') || '[]');
      const classItem = classes.find(c => c.id === selectedClassId);
      
      if (!classItem) {
        alert('선택된 학급을 찾을 수 없습니다.');
        return;
      }
      
      className = classItem.name;
      const classStudents = classItem.students || [];
      
      // 학급에 속한 학생들의 제출 데이터만 필터링
      studentsToExport = allSubmissions.filter(submission => {
        const studentKey = `${submission.id}|${submission.name}`;
        return classStudents.includes(studentKey);
      });
    }
    
    if (studentsToExport.length === 0) {
      const classInfo = selectedClassId && selectedClassId !== 'class_all' 
        ? `선택한 학급에 제출된 학생 데이터가 없습니다.`
        : `다운로드할 학생 데이터가 없습니다.`;
      alert(classInfo);
      return;
    }
    
    // CSV 헤더 정의
    const headers = [
      '학번',
      '이름',
      '제출일시',
      '상태',
      'SDGs 목표',
      'SDGs 목표 텍스트',
      '문제 설명',
      '기준 거리(cm)',
      '가까울 때 조건',
      '멀 때 조건',
      '가까울 때 동작',
      '멀 때 동작',
      '시나리오',
      '교사 피드백'
    ];
    
    // CSV 데이터 생성
    const csvRows = [];
    
    // 헤더 추가
    csvRows.push(headers.map(h => `"${h}"`).join(','));
    
    // 데이터 행 추가
    studentsToExport.forEach(student => {
      // 가까울 때 동작 배열을 문자열로 변환
      const actionsOnText = student.actionsOn && Array.isArray(student.actionsOn)
        ? student.actionsOn.map(a => `${a.device || ''}: ${a.action || ''}`).join('; ')
        : (student.act_on || '');
      
      // 멀 때 동작 배열을 문자열로 변환
      const actionsOffText = student.actionsOff && Array.isArray(student.actionsOff)
        ? student.actionsOff.map(a => `${a.device || ''}: ${a.action || ''}`).join('; ')
        : (student.act_off || '');
      
      const row = [
        student.id || '',
        student.name || '',
        student.timestamp ? new Date(student.timestamp).toLocaleString('ko-KR') : '',
        student.status || 'pending',
        student.sdg || '',
        student.sdgText || '',
        `"${(student.problem || '').replace(/"/g, '""')}"`, // 따옴표 이스케이프
        student.distance || '',
        `"${(student.conditionOn || '').replace(/"/g, '""')}"`,
        `"${(student.conditionOff || '').replace(/"/g, '""')}"`,
        `"${actionsOnText.replace(/"/g, '""')}"`,
        `"${actionsOffText.replace(/"/g, '""')}"`,
        `"${(student.scenario || '').replace(/"/g, '""')}"`,
        `"${(student.teacherFeedback || '').replace(/"/g, '""')}"`
      ];
      
      csvRows.push(row.join(','));
    });
    
    // CSV 문자열 생성
    const csvContent = csvRows.join('\n');
    
    // BOM 추가 (한글 깨짐 방지)
    const BOM = '\uFEFF';
    const csvWithBOM = BOM + csvContent;
    
    // Blob 생성
    const blob = new Blob([csvWithBOM], { type: 'text/csv;charset=utf-8;' });
    
    // 다운로드 링크 생성
    const link = document.createElement('a');
    const url = URL.createObjectURL(blob);
    link.setAttribute('href', url);
    
    // 파일명 생성 (학급명 + 날짜)
    const dateStr = new Date().toISOString().slice(0, 10).replace(/-/g, '');
    const fileName = `학생제출데이터_${className}_${dateStr}.csv`;
    link.setAttribute('download', fileName);
    
    // 다운로드 실행
    link.style.visibility = 'hidden';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    
    // 완료 메시지
    alert(
      `✅ ${className} ${studentsToExport.length}명의 데이터가 CSV 파일로 다운로드되었습니다!\n\n` +
      `파일명: ${fileName}\n\n` +
      `Excel에서 열어서 확인하실 수 있습니다.`
    );
  }
  
  // 교사 대시보드 렌더링 (새로운 구조)
  function renderTeacherDashboard() {
    // 모든 제출된 학생들을 학번 기반으로 자동으로 학급에 배정
    organizeStudentsByClass();
    
    // 기본적으로 학급별 관리 탭 표시
    switchTeacherTab('class');
  }
  
  // 모든 제출된 학생들을 학번 기반으로 학급별로 자동 정리
  function organizeStudentsByClass() {
    const allSubmissions = JSON.parse(localStorage.getItem('student_submissions') || '[]');
    let classes = JSON.parse(localStorage.getItem('teacher_classes') || '[]');
    
    // 모든 학생의 올바른 학급 정보 수집
    const studentClassMap = new Map();
    allSubmissions.forEach(sub => {
      const classInfo = extractGradeAndClass(sub.id);
      if(!classInfo) return; // 학번 형식이 맞지 않으면 건너뜀
      
      const studentKey = `${sub.id}|${sub.name}`;
      studentClassMap.set(studentKey, classInfo.className);
    });
    
    // 모든 학급에서 학생 정리
    classes = classes.map(classItem => {
      if(!classItem.students) return classItem;
      
      // "전체" 학급은 모든 학생 유지
      if(classItem.id === 'class_all') {
        return classItem;
      }
      
      // 일반 학급: 올바른 학생만 유지
      classItem.students = classItem.students.filter(studentKey => {
        const correctClass = studentClassMap.get(studentKey);
        // 학번 기반으로 추출한 학급 이름이 현재 학급 이름과 일치하는 학생만 유지
        return correctClass === classItem.name;
      });
      
      return classItem;
    });
    
    // 모든 학생을 올바른 학급에 배정
    studentClassMap.forEach((correctClassName, studentKey) => {
      // 올바른 학급 찾기 또는 생성
      let targetClass = classes.find(c => c.name === correctClassName);
      if(!targetClass) {
        const [id, name] = studentKey.split('|');
        const classInfo = extractGradeAndClass(id);
        if(classInfo) {
          targetClass = {
            id: 'class_' + classInfo.grade + '_' + classInfo.classNum,
            name: correctClassName,
            students: []
          };
          classes.push(targetClass);
        }
      }
      
      // 학생이 올바른 학급에 없으면 추가
      if(targetClass && !targetClass.students.includes(studentKey)) {
        targetClass.students.push(studentKey);
      }
    });
    
    localStorage.setItem('teacher_classes', JSON.stringify(classes));
  }
  
  // 탭 전환
  function switchTeacherTab(tabType) {
    const classView = document.getElementById('class-management-view');
    const studentView = document.getElementById('student-management-view');
    const tabs = document.querySelectorAll('.teacher-tab');
    
    tabs.forEach(tab => tab.classList.remove('active'));
    
    if(tabType === 'class') {
      classView.style.display = 'flex';
      studentView.style.display = 'none';
      tabs[0].classList.add('active');
      renderClassManagement();
    } else {
      classView.style.display = 'none';
      studentView.style.display = 'flex';
      tabs[1].classList.add('active');
      renderStudentManagement();
    }
  }
  
  // 학급별 관리 렌더링
  function renderClassManagement() {
    // 기본 "전체" 학급이 없으면 생성
    ensureDefaultClass();
    renderClassList();
    // 기본 선택된 학급이 없으면 "전체" 학급 선택
    const selectedClass = localStorage.getItem('selected_class');
    if(selectedClass) {
      selectClass(selectedClass);
    } else {
      const classes = JSON.parse(localStorage.getItem('teacher_classes') || '[]');
      const defaultClass = classes.find(c => c.id === 'class_all');
      if(defaultClass) {
        selectClass('class_all');
      } else {
        document.getElementById('student-list-container').innerHTML = '<div class="empty-state"><div class="empty-state-icon">📚</div><div>학급을 선택하세요</div></div>';
        document.getElementById('student-worksheet-container').innerHTML = '<div class="empty-state"><div class="empty-state-icon">👆</div><div>학생을 선택하세요</div></div>';
      }
    }
  }
  
  // 기본 "전체" 학급 생성
  function ensureDefaultClass() {
    let classes = JSON.parse(localStorage.getItem('teacher_classes') || '[]');
    const defaultClassExists = classes.find(c => c.id === 'class_all');
    
    if(!defaultClassExists) {
      // 제출된 모든 학생을 "전체" 학급에 추가
      const allSubmissions = JSON.parse(localStorage.getItem('student_submissions') || '[]');
      const allStudents = [...new Set(allSubmissions.map(s => `${s.id}|${s.name}`))];
      
      classes.unshift({
        id: 'class_all',
        name: '전체',
        students: allStudents
      });
      localStorage.setItem('teacher_classes', JSON.stringify(classes));
    } else {
      // 기존 "전체" 학급에 새로 제출된 학생 추가
      const allSubmissions = JSON.parse(localStorage.getItem('student_submissions') || '[]');
      const allStudents = [...new Set(allSubmissions.map(s => `${s.id}|${s.name}`))];
      const existingStudents = new Set(defaultClassExists.students || []);
      
      allStudents.forEach(studentKey => {
        if(!existingStudents.has(studentKey)) {
          defaultClassExists.students.push(studentKey);
        }
      });
      
      classes = classes.map(c => c.id === 'class_all' ? defaultClassExists : c);
      localStorage.setItem('teacher_classes', JSON.stringify(classes));
    }
  }
  
  // 학급 목록 렌더링
  function renderClassList() {
    let classes = JSON.parse(localStorage.getItem('teacher_classes') || '[]');
    const container = document.getElementById('class-list-container');
    
    if(classes.length === 0) {
      container.innerHTML = '<div class="empty-state" style="padding:20px; font-size:12px; color:#94a3b8;">+ 버튼을 눌러 학급을 추가하세요</div>';
      return;
    }

    // "전체" 학급을 분리
    const allClass = classes.find(c => c.id === 'class_all');
    const otherClasses = classes.filter(c => c.id !== 'class_all');
    
    // 나머지 학급 정렬: 학년/반별 학급을 먼저, 그 다음 사용자가 추가한 학급
    otherClasses.sort((a, b) => {
      // 학년/반 형식인 학급은 학년순, 반순으로 정렬
      const aMatch = a.name.match(/(\d+)학년\s*(\d+)반/);
      const bMatch = b.name.match(/(\d+)학년\s*(\d+)반/);
      
      if(aMatch && bMatch) {
        const aGrade = parseInt(aMatch[1]);
        const aClass = parseInt(aMatch[2]);
        const bGrade = parseInt(bMatch[1]);
        const bClass = parseInt(bMatch[2]);
        
        if(aGrade !== bGrade) return aGrade - bGrade;
        return aClass - bClass;
      }
      
      if(aMatch) return -1; // 학년/반 형식이 우선
      if(bMatch) return 1;
      
      // 나머지는 이름순
      return a.name.localeCompare(b.name);
    });
    
    // "전체" 학급을 맨 위에, 나머지는 그 아래에 배치
    const sortedClasses = allClass ? [allClass, ...otherClasses] : otherClasses;
    
    let html = '';
    sortedClasses.forEach((classItem, index) => {
      const isActive = localStorage.getItem('selected_class') === classItem.id;
      const isAllClass = classItem.id === 'class_all';
      html += `
        <div class="class-item ${isActive ? 'active' : ''}" style="display: flex; justify-content: space-between; align-items: center;">
          <span onclick="selectClass('${classItem.id}')" style="flex: 1; cursor: pointer;">${classItem.name}</span>
          ${!isAllClass ? `<button class="btn-delete-student" onclick="deleteClass('${classItem.id}', '${classItem.name}')" title="학급 삭제" style="margin-left: 8px;">🗑️</button>` : ''}
          </div>
      `;
    });
    container.innerHTML = html;
  }
  
  // 학급 선택
  function selectClass(classId) {
    localStorage.setItem('selected_class', classId);
    renderClassList();
    renderStudentList(classId);
  }
  
  // 학생 목록 렌더링 (학급별)
  function renderStudentList(classId) {
    const classes = JSON.parse(localStorage.getItem('teacher_classes') || '[]');
    const classItem = classes.find(c => c.id === classId);
    if(!classItem) return;
    
    const allSubmissions = JSON.parse(localStorage.getItem('student_submissions') || '[]');
    const container = document.getElementById('student-list-container');
    
    // "전체" 학급인 경우 모든 학생 표시
    if(classId === 'class_all') {
      const allStudents = [...new Set(allSubmissions.map(s => `${s.id}|${s.name}`))];
      
      if(allStudents.length === 0) {
        container.innerHTML = '<div class="empty-state" style="padding:20px; font-size:12px; color:#94a3b8;">제출된 학생이 없습니다</div>';
        document.getElementById('student-worksheet-container').innerHTML = '<div class="empty-state"><div class="empty-state-icon">👆</div><div>학생을 선택하세요</div></div>';
        return;
      }
      
      let html = '';
      allStudents.forEach(studentKey => {
        const [id, name] = studentKey.split('|');
        const submission = allSubmissions.find(s => s.id === id && s.name === name);
        const hasSubmission = !!submission;
        const pendingCount = hasSubmission && submission.status === 'pending' ? 1 : 0;
        
        html += `
          <div class="student-item">
            <span onclick="selectStudent('${id}', '${name}')" style="flex: 1; cursor: pointer;">${id} ${name}</span>
            <div class="student-actions" onclick="event.stopPropagation();">
              ${pendingCount > 0 ? `<span class="student-badge">${pendingCount}</span>` : ''}
              <button class="btn-delete-student" onclick="deleteStudent('${id}', '${name}')" title="학생 삭제">🗑️</button>
          </div>
            </div>
        `;
      });
      container.innerHTML = html;
      return;
    }
    
    // 일반 학급인 경우: 학번 기반으로 올바른 학생만 표시
    const classStudents = classItem.students || [];
    
    // 학번 기반으로 필터링: 현재 학급 이름과 일치하는 학생만 표시
    const filteredStudents = classStudents.filter(studentKey => {
      const [id, name] = studentKey.split('|');
      const classInfo = extractGradeAndClass(id);
      if(!classInfo) return false; // 학번 형식이 맞지 않으면 제외
      
      // 학번 기반으로 추출한 학급 이름이 현재 학급 이름과 일치하는지 확인
      return classInfo.className === classItem.name;
    });
    
    // 학급 정보 업데이트 (잘못 배정된 학생 제거)
    if(filteredStudents.length !== classStudents.length) {
      classItem.students = filteredStudents;
      const updatedClasses = classes.map(c => c.id === classId ? classItem : c);
      localStorage.setItem('teacher_classes', JSON.stringify(updatedClasses));
    }
    
    if(filteredStudents.length === 0) {
      container.innerHTML = '<div class="empty-state" style="padding:20px; font-size:12px; color:#94a3b8;">이 학급에 학생이 없습니다</div>';
      document.getElementById('student-worksheet-container').innerHTML = '<div class="empty-state"><div class="empty-state-icon">👆</div><div>학생을 선택하세요</div></div>';
      return;
    }
    
    let html = '';
    filteredStudents.forEach(studentKey => {
      const [id, name] = studentKey.split('|');
      const submission = allSubmissions.find(s => s.id === id && s.name === name);
      const hasSubmission = !!submission;
      const pendingCount = hasSubmission && submission.status === 'pending' ? 1 : 0;
      
      html += `
        <div class="student-item">
          <span onclick="selectStudent('${id}', '${name}')" style="flex: 1; cursor: pointer;">${id} ${name}</span>
          <div class="student-actions" onclick="event.stopPropagation();">
            ${pendingCount > 0 ? `<span class="student-badge">${pendingCount}</span>` : ''}
            <button class="btn-delete-student" onclick="deleteStudent('${id}', '${name}')" title="학생 삭제">🗑️</button>
          </div>
        </div>
      `;
    });
    container.innerHTML = html;
  }

  // 학생별 관리 렌더링
  function renderStudentManagement() {
    const allSubmissions = JSON.parse(localStorage.getItem('student_submissions') || '[]');
    const container = document.getElementById('all-student-list-container');
    
    // 모든 학생 추출 (중복 제거)
    const studentMap = new Map();
    allSubmissions.forEach(sub => {
      const key = `${sub.id}|${sub.name}`;
      if(!studentMap.has(key)) {
        studentMap.set(key, { id: sub.id, name: sub.name, submission: sub });
      }
    });
    
    if(studentMap.size === 0) {
      container.innerHTML = '<div class="empty-state" style="padding:20px; font-size:12px; color:#94a3b8;">제출된 과제가 없습니다</div>';
      document.getElementById('all-student-worksheet-container').innerHTML = '<div class="empty-state"><div class="empty-state-icon">📝</div><div>제출된 과제가 없습니다</div></div>';
      return;
    }
    
    let html = '';
    studentMap.forEach((student, key) => {
      const pendingCount = student.submission.status === 'pending' ? 1 : 0;
      html += `
        <div class="student-item">
          <span onclick="selectStudent('${student.id}', '${student.name}')" style="flex: 1; cursor: pointer;">${student.id} ${student.name}</span>
          <div class="student-actions" onclick="event.stopPropagation();">
            ${pendingCount > 0 ? `<span class="student-badge">${pendingCount}</span>` : ''}
            <button class="btn-delete-student" onclick="deleteStudent('${student.id}', '${student.name}')" title="학생 삭제">🗑️</button>
          </div>
        </div>
      `;
    });
    container.innerHTML = html;
  }
  
  // 학생 선택 및 학습지 표시
  function selectStudent(studentId, studentName) {
    // 모든 student-item에서 active 제거
    document.querySelectorAll('.student-item').forEach(item => item.classList.remove('active'));
    // 클릭된 항목에 active 추가
    event.currentTarget.classList.add('active');
    
    const allSubmissions = JSON.parse(localStorage.getItem('student_submissions') || '[]');
    const submission = allSubmissions.find(s => s.id === studentId && s.name === studentName);
    
    // 학생별 관리 뷰인지 학급별 관리 뷰인지 확인
    const isStudentManagement = document.getElementById('student-management-view').style.display !== 'none';
    const container = isStudentManagement 
      ? document.getElementById('all-student-worksheet-container')
      : document.getElementById('student-worksheet-container');
    
    if(!submission) {
      container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">📝</div><div>아직 제출된 과제가 없습니다</div></div>';
      return;
    }
    
    renderStudentWorksheet(submission, container);
  }
  
  // 학습지 렌더링
  function renderStudentWorksheet(submission, container) {
    const statusText = {
      'pending': '대기중',
      'approved': '승인됨',
      'rejected': '반려됨'
    };
    
    const html = `
      <div class="student-worksheet">
        <div class="worksheet-header">
          <div class="worksheet-title">${submission.id} ${submission.name}</div>
          <div class="worksheet-status ${submission.status}">${statusText[submission.status]}</div>
        </div>
        
        <div class="worksheet-section">
          <div class="worksheet-label">문제</div>
          <div class="worksheet-value">${submission.problem || '-'}</div>
        </div>
        
        <div class="worksheet-section">
          <div class="worksheet-label">SDG 목표</div>
          <div class="worksheet-value">${submission.sdg || '-'}</div>
        </div>
        
        <div class="worksheet-section">
          <div class="worksheet-label">시나리오</div>
          <div class="worksheet-value">${submission.scenario || '-'}</div>
        </div>
        
        <div class="worksheet-feedback">
          <div class="worksheet-label">피드백</div>
          <textarea id="worksheet-feedback-${submission.timestamp}" class="worksheet-feedback-input" placeholder="피드백을 입력하세요...">${submission.teacherFeedback || ''}</textarea>
          <div class="worksheet-actions">
            <button class="worksheet-btn approve" onclick="updateStudentStatus('${submission.timestamp}', 'approved')">승인</button>
            <button class="worksheet-btn reject" onclick="updateStudentStatus('${submission.timestamp}', 'rejected')">반려</button>
          </div>
          </div>
        </div>
      `;
    
    container.innerHTML = html;
  }

  // 학생 상태 업데이트
  function updateStudentStatus(timestamp, newStatus) {
    let data = JSON.parse(localStorage.getItem('student_submissions') || '[]');
    const idx = data.findIndex(d => d.timestamp === timestamp);
    
    if(idx === -1) return;

    const feedbackEl = document.getElementById(`worksheet-feedback-${timestamp}`);
    const feedback = feedbackEl ? feedbackEl.value : '';
    
    if(newStatus === 'rejected' && !feedback.trim()) {
      alert("반려 시 피드백을 반드시 입력해주세요.");
      return;
    }

    data[idx].status = newStatus;
    data[idx].teacherFeedback = feedback;
    
    localStorage.setItem('student_submissions', JSON.stringify(data));
    
    // 현재 선택된 학생 정보로 학습지 다시 렌더링
    const submission = data[idx];
    const isStudentManagement = document.getElementById('student-management-view').style.display !== 'none';
    const container = isStudentManagement 
      ? document.getElementById('all-student-worksheet-container')
      : document.getElementById('student-worksheet-container');
    
    renderStudentWorksheet(submission, container);
    
    // 학생 목록도 업데이트 (배지 표시를 위해)
    const tabType = isStudentManagement ? 'student' : 'class';
    switchTeacherTab(tabType);
    if(!isStudentManagement) {
      const selectedClass = localStorage.getItem('selected_class');
      if(selectedClass) {
        selectClass(selectedClass);
      }
    }
    
    alert("처리되었습니다. 학생이 다음 로그인 시 피드백 알림을 받게 됩니다.");
  }
  
  // 학생 삭제 함수
  function deleteStudent(studentId, studentName) {
    if(!confirm(`"${studentId} ${studentName}" 학생의 모든 데이터를 삭제하시겠습니까?\n\n삭제될 내용:\n- 제출한 과제\n- 학급 정보\n- 학습 완료 상태`)) {
      return;
    }
    
    const studentKey = `${studentId}|${studentName}`;
    
    // 1. 제출 데이터에서 삭제
    let submissions = JSON.parse(localStorage.getItem('student_submissions') || '[]');
    submissions = submissions.filter(s => !(s.id === studentId && s.name === studentName));
    localStorage.setItem('student_submissions', JSON.stringify(submissions));
    
    // 2. 모든 학급에서 학생 제거
    let classes = JSON.parse(localStorage.getItem('teacher_classes') || '[]');
    classes = classes.map(classItem => {
      if(classItem.students && classItem.students.includes(studentKey)) {
        classItem.students = classItem.students.filter(s => s !== studentKey);
      }
      return classItem;
    });
    localStorage.setItem('teacher_classes', JSON.stringify(classes));
    
    // 3. 학습 완료 상태 삭제
    const completedKey = `learning_completed_${studentId}_${studentName}`;
    localStorage.removeItem(completedKey);
    
    // 4. UI 새로고침
    const isStudentManagement = document.getElementById('student-management-view').style.display !== 'none';
    if(isStudentManagement) {
      renderStudentManagement();
      document.getElementById('all-student-worksheet-container').innerHTML = '<div class="empty-state"><div class="empty-state-icon">👆</div><div>학생을 선택하세요</div></div>';
    } else {
      const selectedClass = localStorage.getItem('selected_class');
      if(selectedClass) {
        selectClass(selectedClass);
      }
      document.getElementById('student-worksheet-container').innerHTML = '<div class="empty-state"><div class="empty-state-icon">👆</div><div>학생을 선택하세요</div></div>';
    }
    
    alert(`"${studentId} ${studentName}" 학생이 삭제되었습니다.`);
  }
  
  // 학급 삭제 함수
  function deleteClass(classId, className) {
    if(!confirm(`"${className}" 학급을 삭제하시겠습니까?\n\n학급이 삭제되어도 학생 데이터는 유지됩니다.`)) {
      return;
    }
    
    let classes = JSON.parse(localStorage.getItem('teacher_classes') || '[]');
    classes = classes.filter(c => c.id !== classId);
    localStorage.setItem('teacher_classes', JSON.stringify(classes));
    
    // 선택된 학급이 삭제된 학급이면 선택 해제
    if(localStorage.getItem('selected_class') === classId) {
      localStorage.removeItem('selected_class');
    }
    
    // UI 새로고침
    renderClassList();
    document.getElementById('student-list-container').innerHTML = '<div class="empty-state"><div class="empty-state-icon">📚</div><div>학급을 선택하세요</div></div>';
    document.getElementById('student-worksheet-container').innerHTML = '<div class="empty-state"><div class="empty-state-icon">👆</div><div>학생을 선택하세요</div></div>';
    
    alert(`"${className}" 학급이 삭제되었습니다.`);
  }
  
  // 학번에서 학년과 반 추출
  function extractGradeAndClass(studentId) {
    if(!studentId || studentId.length !== 5) return null;
    
    // 학번 형식: 총 5자리
    // 첫 번째 자리: 학년
    // 두 번째 + 세 번째 자리: 반 (2자리)
    // 네 번째 + 다섯 번째 자리: 번호 (2자리)
    // 예: 20325 -> 2학년 03반 25번 -> 2학년 3반
    // 예: 11111 -> 1학년 11반 11번 -> 1학년 11반
    // 예: 20312 -> 2학년 03반 12번 -> 2학년 3반
    
    const idStr = studentId.toString();
    
    if(idStr.length === 5) {
      const grade = parseInt(idStr[0]);              // 첫 번째 자리: 학년
      const classNum = parseInt(idStr.substring(1, 3)); // 두 번째+세 번째 자리: 반
      
      // 학년이 1-6 사이이고, 반이 1-99 사이인 경우만 유효
      if(grade >= 1 && grade <= 6 && classNum >= 1 && classNum <= 99) {
        return {
          grade: grade,
          classNum: classNum,
          className: `${grade}학년 ${classNum}반`
        };
      }
    }
    
    return null;
  }
  
  // 학번 기반으로 학생을 학급에 자동 배정
  function assignStudentToClassById(studentId, studentName) {
    const classInfo = extractGradeAndClass(studentId);
    if(!classInfo) return; // 학번 형식이 맞지 않으면 배정하지 않음
    
    const studentKey = `${studentId}|${studentName}`;
    let classes = JSON.parse(localStorage.getItem('teacher_classes') || '[]');
    const correctClassName = classInfo.className;
    
    // 해당 학생을 잘못 배정된 학급에서 제거 (올바른 학급과 "전체" 제외)
    classes = classes.map(classItem => {
      if(classItem.students && classItem.students.includes(studentKey)) {
        // 올바른 학급이 아니고 "전체"도 아니면 제거
        if(classItem.name !== correctClassName && classItem.id !== 'class_all') {
          classItem.students = classItem.students.filter(s => s !== studentKey);
        }
      }
      return classItem;
    });
    
    // 해당 학급 찾기 또는 생성
    let targetClass = classes.find(c => c.name === correctClassName);
    
    if(!targetClass) {
      // 학급이 없으면 생성
      targetClass = {
        id: 'class_' + classInfo.grade + '_' + classInfo.classNum,
        name: correctClassName,
        students: []
      };
      classes.push(targetClass);
    }
    
    // 학생이 해당 학급에 없으면 추가
    if(!targetClass.students.includes(studentKey)) {
      targetClass.students.push(studentKey);
    }
    
    // classes 배열 업데이트
    classes = classes.map(c => c.id === targetClass.id ? targetClass : c);
    localStorage.setItem('teacher_classes', JSON.stringify(classes));
  }
  
  // 학급 추가 다이얼로그 표시
  function showAddClassDialog() {
    const className = prompt('학급 이름을 입력하세요:');
    if(!className || !className.trim()) return;
    
    const classes = JSON.parse(localStorage.getItem('teacher_classes') || '[]');
    const newClass = {
      id: 'class_' + Date.now(),
      name: className.trim(),
      students: []
    };
    
    classes.push(newClass);
    localStorage.setItem('teacher_classes', JSON.stringify(classes));
    
    renderClassList();
    selectClass(newClass.id);
    
    // 학생 추가 안내
    alert(`"${className}" 학급이 생성되었습니다.\n학생은 학번|이름 형식으로 추가할 수 있습니다.`);
  }

  function goToTeacherConfig() {
    const savedPrompt = localStorage.getItem('teacher_prompt_v1');
    const savedApiKey = localStorage.getItem('openai_api_key');
    if(savedPrompt) document.getElementById('teacher-prompt').value = savedPrompt;
    if(savedApiKey) document.getElementById('api-key').value = savedApiKey;
    showView('view-teacher-config');
  }

  function saveTeacherConfig() {
    const prompt = document.getElementById('teacher-prompt').value;
    const apiKey = document.getElementById('api-key').value.trim();
    
    localStorage.setItem('teacher_prompt_v1', prompt);
    
    if(apiKey) {
      localStorage.setItem('openai_api_key', apiKey);
      alert('설정이 저장되었습니다. (API 키는 안전한 백엔드 서버를 통해 관리하는 것을 권장합니다.)');
    } else {
      localStorage.removeItem('openai_api_key');
      alert('설정이 저장되었습니다. (기본 검증만 사용됩니다.)');
    }
    
    showDashboard();
  }

  function clearData() {
    if(confirm("모든 데이터를 삭제하시겠습니까? (제출 데이터와 학급 정보가 모두 삭제됩니다)")) {
      localStorage.removeItem('student_submissions');
      localStorage.removeItem('teacher_classes');
      localStorage.removeItem('selected_class');
      renderTeacherDashboard();
    }
  }

  /* =========================================
     초음파 센서 학습 페이지 로직
     ========================================= */
  let simDistance = 400;
  const soundSpeed = 0.034; // cm/μs

  function initSimulation() {
    updateSimDistance(400);
  }

  function updateSimDistance(val) {
    simDistance = parseInt(val);
    
    // 나방 위치 계산 (400cm = 10%, 2cm = 85%)
    const rightPercent = 85 - ((simDistance - 2) * (75 / 398));
    document.getElementById('sim-moth').style.right = rightPercent + '%';
    
    // 거리 및 시간 표시
    document.getElementById('disp-distance').textContent = `${simDistance}cm`;
    const timeUs = Math.round((simDistance * 2) / soundSpeed);
    document.getElementById('disp-time').textContent = `${timeUs.toLocaleString()}μs`;
    
    // 박쥐 말풍선 업데이트
    updateBatSpeech(simDistance);
  }
  
  function updateBatSpeech(distance) {
    const speechBubble = document.getElementById('bat-speech-bubble');
    const speechText = document.getElementById('bat-speech-text');
    if(!speechBubble || !speechText) return;
    
    let message = '';
    let bgGradient = '';
    let borderColor = '';
    let textColor = '';
    let tailBorderColor = '';
    
    if (distance >= 300) {
      // 먼 경우: "음... 아직은 좀 먼데? (탐색 중)"
      message = '음... 아직은 좀 먼데? (탐색 중)';
      bgGradient = 'linear-gradient(135deg, #fef3c7, #fde68a)';
      borderColor = '#f59e0b';
      textColor = '#92400e';
      tailBorderColor = '#f59e0b';
    } else if (distance >= 100) {
      // 적당한 거리: "오호! 딱 좋은 거리다! (추적 중)"
      message = '오호! 딱 좋은 거리다! (추적 중)';
      bgGradient = 'linear-gradient(135deg, #dbeafe, #bfdbfe)';
      borderColor = '#3b82f6';
      textColor = '#1e40af';
      tailBorderColor = '#3b82f6';
    } else {
      // 가까운 거리: "잡았다 요놈! (사정권 진입)"
      message = '잡았다 요놈! (사정권 진입)';
      bgGradient = 'linear-gradient(135deg, #dcfce7, #bbf7d0)';
      borderColor = '#22c55e';
      textColor = '#166534';
      tailBorderColor = '#22c55e';
    }
    
    speechText.textContent = message;
    speechText.style.color = textColor;
    
    const bubbleContainer = document.getElementById('bat-bubble-container');
    if(bubbleContainer) {
      bubbleContainer.style.background = bgGradient;
      bubbleContainer.style.borderColor = borderColor;
    }
    
    // 말풍선 꼬리 색상 변경
    const tailOuter = document.getElementById('bat-tail-outer');
    const tailInner = document.getElementById('bat-tail-inner');
    if(tailOuter) tailOuter.style.borderRightColor = tailBorderColor;
    
    if(tailInner) {
      // 두 번째 꼬리는 배경 그라데이션에 맞춰 조정
      if(distance >= 300) {
        tailInner.style.borderRightColor = '#fde68a';
      } else if(distance >= 100) {
        tailInner.style.borderRightColor = '#bfdbfe';
      } else {
        tailInner.style.borderRightColor = '#bbf7d0';
      }
    }
    
    // 말풍선 표시
    speechBubble.style.opacity = '1';
  }

  function fireWave() {
    const ping = document.getElementById('wave-ping');
    const pong = document.getElementById('wave-pong');
    const moth = document.getElementById('sim-moth');
    const visual = document.getElementById('sim-visual');
    
    // 초기화
    ping.style.transition = 'none';
    pong.style.transition = 'none';
    ping.style.opacity = '1';
    pong.style.opacity = '0';
    ping.style.left = '90px';
    
    // 나방 위치 계산 (퍼센트 기반으로 계산)
    const visualRect = visual.getBoundingClientRect();
    const visualWidth = visualRect.width;
    const mothRect = moth.getBoundingClientRect();
    const mothLeft = mothRect.left - visualRect.left;
    const targetX = mothLeft + 20; // 나방 중심 기준
    
    // 애니메이션 시간 계산 (거리에 비례)
    const animTime = 0.3 + (simDistance / 400) * 1.0;
    
    // Ping 애니메이션 (박쥐 -> 나방)
    setTimeout(() => {
      ping.style.transition = `left ${animTime}s linear`;
      ping.style.left = `${targetX}px`;
    }, 50);
    
    // Pong 애니메이션 (나방 -> 박쥐)
    setTimeout(() => {
      ping.style.opacity = '0';
      pong.style.left = `${targetX}px`;
      pong.style.opacity = '1';
      setTimeout(() => {
        pong.style.transition = `left ${animTime}s linear`;
        pong.style.left = '90px';
      }, 50);
    }, animTime * 1000 + 50);
    
    // Pong 사라짐
    setTimeout(() => {
      pong.style.opacity = '0';
    }, animTime * 2000 + 100);
  }

  let quizAnswered = false; // 퀴즈 정답 여부
  
  // 학습 상태 저장 함수
  function saveLearningState(data) {
    if(!currentUser || !currentUser.id || !currentUser.name) return;
    
    const key = `learning_state_${currentUser.id}_${currentUser.name}`;
    const existingData = getLearningState();
    const newData = { ...existingData, ...data };
    localStorage.setItem(key, JSON.stringify(newData));
  }
  
  // 학습 상태 불러오기 함수
  function getLearningState() {
    if(!currentUser || !currentUser.id || !currentUser.name) return {};
    
    const key = `learning_state_${currentUser.id}_${currentUser.name}`;
    const saved = localStorage.getItem(key);
    return saved ? JSON.parse(saved) : {};
  }
  
  // 학습 상태 복원 함수
  function restoreLearningState() {
    if(!currentUser || !currentUser.id || !currentUser.name) return;
    
    const state = getLearningState();
    
    // 퀴즈 상태 복원
    if(state.quizAnswered && state.quizAnswerButton !== undefined) {
      const buttons = document.querySelectorAll('.quiz-option-btn');
      if(buttons[state.quizAnswerButton]) {
        const btn = buttons[state.quizAnswerButton];
        const isCorrect = state.quizAnswerType === 'distance';
        btn.classList.add(isCorrect ? 'correct' : 'wrong');
        quizAnswered = true;
        
        const feedback = document.getElementById('quiz-feedback');
        if(feedback) {
          feedback.style.display = 'block';
          if(isCorrect) {
            feedback.style.background = 'rgba(236, 253, 245, 0.8)';
            feedback.style.border = '2px solid #10b981';
            feedback.style.color = '#047857';
            feedback.innerHTML = "✅ 정답! 초음파 센서는 소리가 갔다 오는 시간으로 '거리'를 계산해요.";
          }
        }
      }
    }
    
    // 드래그 앤 드롭 상태 복원
    if(state.dragDropAnswers) {
      const wordContainer = document.getElementById('word-container');
      if(wordContainer) {
        // 먼저 모든 드롭 존에서 단어 제거
        document.querySelectorAll('.drop-zone').forEach(zone => {
          zone.innerHTML = '';
          zone.style.background = 'white';
          zone.style.border = '2px dashed #c4b5fd';
        });
        
        // 저장된 답안대로 드롭 존에 단어 배치
        Object.keys(state.dragDropAnswers).forEach(dropId => {
          const dropZone = document.getElementById(dropId);
          const wordText = state.dragDropAnswers[dropId];
          
          if(dropZone && wordText) {
            const wordButton = document.createElement('span');
            wordButton.className = 'dropped-word';
            wordButton.textContent = wordText;
            wordButton.style.cssText = 'color: #1e293b; font-weight: 600; display: block; text-align: center;';
            dropZone.appendChild(wordButton);
            dropZone.style.background = '#ede9fe';
            dropZone.style.border = '2px solid #8b5cf6';
          }
        });
        
        // 단어 컨테이너에서 사용된 단어 제거
        if(wordContainer) {
          const remainingWords = ['초음파', '반사', '시간', '거리'].filter(word => {
            return !Object.values(state.dragDropAnswers).includes(word);
          });
          
          wordContainer.innerHTML = '';
          remainingWords.forEach(wordText => {
            const wordButton = document.createElement('div');
            wordButton.className = 'drag-word';
            wordButton.setAttribute('draggable', 'true');
            wordButton.setAttribute('data-word', wordText);
            wordButton.textContent = wordText;
            wordButton.style.cssText = 'background: linear-gradient(135deg, #8b5cf6, #6366f1); color: white; padding: 12px 28px; border-radius: 25px; font-size: 16px; font-weight: 600; cursor: grab; user-select: none; box-shadow: 0 4px 8px rgba(139, 92, 246, 0.3); transition: all 0.3s ease;';
            
            wordButton.addEventListener('dragstart', handleDragStart);
            wordButton.addEventListener('dragend', handleDragEnd);
            wordContainer.appendChild(wordButton);
          });
        }
        
        // 이벤트 리스너 다시 설정
        initDragDrop();
        
        // 피드백 표시 (정답일 경우)
        const dropZones = [
          { id: 'drop1', correct: '초음파' },
          { id: 'drop2', correct: '반사' },
          { id: 'drop3', correct: '시간' },
          { id: 'drop4', correct: '거리' }
        ];
        
        let allCorrect = true;
        dropZones.forEach(zone => {
          if(state.dragDropAnswers[zone.id] !== zone.correct) {
            allCorrect = false;
          }
        });
        
        if(allCorrect) {
          const reflectionFeedbackDiv = document.getElementById('reflection-feedback');
          if(reflectionFeedbackDiv) {
            reflectionFeedbackDiv.style.display = 'block';
            reflectionFeedbackDiv.style.background = 'rgba(237, 233, 254, 0.9)';
            reflectionFeedbackDiv.style.border = '2px solid #8b5cf6';
            reflectionFeedbackDiv.style.color = '#6d28d9';
            reflectionFeedbackDiv.innerHTML = "✅ <strong>모두 맞습니다!</strong> 초음파 센서의 원리를 잘 이해하셨네요!";
          }
        }
      }
    }
  }
  
  function checkQuizAnswer(btn, isCorrect, answerType) {
    const buttons = document.querySelectorAll('.quiz-option-btn');
    // 이전 선택 해제 (다시 선택 가능하도록)
    buttons.forEach(b => {
      b.classList.remove('correct', 'wrong');
    });
    
    const feedback = document.getElementById('quiz-feedback');
    feedback.style.display = 'block';
    
    if(isCorrect) {
      btn.classList.add('correct');
      feedback.style.background = 'rgba(236, 253, 245, 0.8)';
      feedback.style.border = '2px solid #10b981';
      feedback.style.color = '#047857';
      feedback.innerHTML = "✅ 정답! 초음파 센서는 소리가 갔다 오는 시간으로 '거리'를 계산해요.";
      quizAnswered = true;
      
      // 학습 상태 저장 (정답 선택 시)
      if(currentUser && currentUser.id && currentUser.name) {
        saveLearningState({
          quizAnswered: true,
          quizAnswerType: answerType,
          quizAnswerButton: Array.from(buttons).indexOf(btn)
        });
      }
    } else {
      btn.classList.add('wrong');
      feedback.style.background = 'rgba(254, 242, 242, 0.8)';
      feedback.style.border = '2px solid #ef4444';
      feedback.style.color = '#991b1b';
      
      // 모든 오답에 동일한 피드백 형식 사용
      feedback.innerHTML = "❌ 땡! 초음파 센서는 물체에 반사되어 돌아오는 '시간'을 측정합니다. 다시 생각해보고 정답을 찾아보세요! 💭";
      quizAnswered = false;
    }
  }

  /* =========================================
     드래그 앤 드롭 기능
     ========================================= */
  let draggedElement = null;
  let draggedWord = null;
  
  // 드래그 앤 드롭 이벤트 리스너 설정
  function initDragDrop() {
    // 드래그 가능한 단어들에 이벤트 리스너 추가
    document.querySelectorAll('.drag-word').forEach(word => {
      word.removeEventListener('dragstart', handleDragStart);
      word.removeEventListener('dragend', handleDragEnd);
      word.addEventListener('dragstart', handleDragStart);
      word.addEventListener('dragend', handleDragEnd);
    });
    
    // 드롭 존에 이벤트 리스너 추가
    document.querySelectorAll('.drop-zone').forEach(zone => {
      zone.removeEventListener('dragover', handleDragOver);
      zone.removeEventListener('drop', handleDrop);
      zone.removeEventListener('dragenter', handleDragEnter);
      zone.removeEventListener('dragleave', handleDragLeave);
      zone.addEventListener('dragover', handleDragOver);
      zone.addEventListener('drop', handleDrop);
      zone.addEventListener('dragenter', handleDragEnter);
      zone.addEventListener('dragleave', handleDragLeave);
    });
  }
  
  // 페이지 로드 시 초기화
  document.addEventListener('DOMContentLoaded', function() {
    setTimeout(initDragDrop, 100);
  });
  
  function handleDragStart(e) {
    draggedElement = this;
    draggedWord = this.getAttribute('data-word');
    this.style.opacity = '0.5';
    e.dataTransfer.effectAllowed = 'move';
    e.dataTransfer.setData('text/html', this.innerHTML);
  }
  
  function handleDragEnd(e) {
    this.style.opacity = '1';
    document.querySelectorAll('.drop-zone').forEach(zone => {
      const droppedWord = zone.querySelector('.dropped-word');
      if(!droppedWord) {
        zone.style.background = 'white';
        zone.style.border = '2px dashed #c4b5fd';
      }
    });
  }
  
  function handleDragOver(e) {
    if(e.preventDefault) {
      e.preventDefault();
    }
    e.dataTransfer.dropEffect = 'move';
    return false;
  }
  
  function handleDragEnter(e) {
    const droppedWord = this.querySelector('.dropped-word');
    if(!droppedWord) {
      this.style.background = '#ede9fe';
      this.style.border = '2px dashed #8b5cf6';
    }
  }
  
  function handleDragLeave(e) {
    const droppedWord = this.querySelector('.dropped-word');
    if(!droppedWord) {
      this.style.background = 'white';
      this.style.border = '2px dashed #c4b5fd';
    }
  }
  
  function handleDrop(e) {
    if(e.stopPropagation) {
      e.stopPropagation();
    }
    
    if(draggedElement) {
      const word = draggedWord;
      const dropZone = this;
      
      // 이미 단어가 있으면 제거
      const existingWord = dropZone.querySelector('.dropped-word');
      if(existingWord) {
        // 원래 단어 버튼 복원
        const wordText = existingWord.textContent.trim();
        const wordButton = document.createElement('div');
        wordButton.className = 'drag-word';
        wordButton.setAttribute('draggable', 'true');
        wordButton.setAttribute('data-word', wordText);
        wordButton.textContent = wordText;
        wordButton.style.cssText = 'background: linear-gradient(135deg, #8b5cf6, #6366f1); color: white; padding: 12px 28px; border-radius: 25px; font-size: 16px; font-weight: 600; cursor: grab; user-select: none; box-shadow: 0 4px 8px rgba(139, 92, 246, 0.3); transition: all 0.3s ease;';
        
        // 이벤트 리스너 다시 추가
        wordButton.addEventListener('dragstart', handleDragStart);
        wordButton.addEventListener('dragend', handleDragEnd);
        
        draggedElement.parentNode.appendChild(wordButton);
        existingWord.remove();
      }
      
      // 새 단어 추가 (가운데 정렬)
      dropZone.innerHTML = `<span class="dropped-word" style="color: #1e293b; font-weight: 600; display: block; text-align: center;">${word}</span>`;
      dropZone.style.background = 'white';
      dropZone.style.border = '2px dashed #a78bfa';
      
      // 원래 단어 버튼 제거
      draggedElement.remove();
      draggedElement = null;
      draggedWord = null;
    }
    
    return false;
  }
  
  function resetDragDrop() {
    // 모든 드롭 존에서 단어를 다시 단어 컨테이너로 이동
    const wordContainer = document.getElementById('word-container');
    if(!wordContainer) return;
    
    // 드롭 존에서 단어 추출
    document.querySelectorAll('.drop-zone').forEach(zone => {
      const droppedWord = zone.querySelector('.dropped-word');
      if(droppedWord) {
        const wordText = droppedWord.textContent.trim();
        
        // 단어 버튼 다시 생성
        const wordButton = document.createElement('div');
        wordButton.className = 'drag-word';
        wordButton.setAttribute('draggable', 'true');
        wordButton.setAttribute('data-word', wordText);
        wordButton.textContent = wordText;
        wordButton.style.cssText = 'background: linear-gradient(135deg, #8b5cf6, #6366f1); color: white; padding: 12px 28px; border-radius: 25px; font-size: 16px; font-weight: 600; cursor: grab; user-select: none; box-shadow: 0 4px 8px rgba(139, 92, 246, 0.3); transition: all 0.3s ease;';
        
        wordButton.addEventListener('dragstart', handleDragStart);
        wordButton.addEventListener('dragend', handleDragEnd);
        
        wordContainer.appendChild(wordButton);
      }
      
      // 드롭 존 초기화
      zone.innerHTML = '';
      zone.style.background = 'white';
      zone.style.border = '2px dashed #c4b5fd';
    });
    
    // 이벤트 리스너 다시 설정
    initDragDrop();
    
    // 피드백 숨기기
    const feedback = document.getElementById('reflection-feedback');
    if(feedback) feedback.style.display = 'none';
  }
  
  function checkDragDropAnswer() {
    const dropZones = [
      { id: 'drop1', correct: '초음파' },
      { id: 'drop2', correct: '반사' },
      { id: 'drop3', correct: '시간' },
      { id: 'drop4', correct: '거리' }
    ];
    
    const reflectionFeedbackDiv = document.getElementById('reflection-feedback');
    reflectionFeedbackDiv.style.display = 'block';
    
    let allFilled = true;
    let allCorrect = true;
    const wrongBlanks = [];
    
    dropZones.forEach((zone, index) => {
      const dropZone = document.getElementById(zone.id);
      const droppedWord = dropZone.querySelector('.dropped-word');
      
      if(!droppedWord) {
        allFilled = false;
        dropZone.style.background = '#fee2e2';
        dropZone.style.border = '2px dashed #ef4444';
      } else {
        const word = droppedWord.textContent.trim();
        if(word === zone.correct) {
          dropZone.style.background = '#ede9fe';
          dropZone.style.border = '2px solid #8b5cf6';
        } else {
          allCorrect = false;
          wrongBlanks.push(`${index + 1}번`);
          dropZone.style.background = '#fee2e2';
          dropZone.style.border = '2px solid #ef4444';
        }
      }
    });
    
    if(!allFilled) {
      reflectionFeedbackDiv.style.background = 'rgba(254, 242, 242, 0.8)';
      reflectionFeedbackDiv.style.border = '2px solid #ef4444';
      reflectionFeedbackDiv.style.color = '#991b1b';
      reflectionFeedbackDiv.innerHTML = "❌ 모든 빈칸을 채워주세요!";
      return;
    }
    
    if(!allCorrect) {
      reflectionFeedbackDiv.style.background = 'rgba(254, 242, 242, 0.8)';
      reflectionFeedbackDiv.style.border = '2px solid #ef4444';
      reflectionFeedbackDiv.style.color = '#991b1b';
      reflectionFeedbackDiv.innerHTML = `❌ <strong>틀렸습니다!</strong><br>${wrongBlanks.join(', ')} 빈칸을 다시 확인해주세요.<br><br>💡 <strong>힌트:</strong> 초음파 센서는 초음파를 쏘고, 물체에 반사되어 돌아오는 시간으로 거리를 측정합니다.`;
      return;
    }
    
    // 모두 정답일 때
    reflectionFeedbackDiv.style.background = 'rgba(237, 233, 254, 0.9)';
    reflectionFeedbackDiv.style.border = '2px solid #8b5cf6';
    reflectionFeedbackDiv.style.color = '#6d28d9';
    reflectionFeedbackDiv.innerHTML = "✅ <strong>모두 맞습니다!</strong> 초음파 센서의 원리를 잘 이해하셨네요!";
    
    // 드래그 앤 드롭 정답 저장 및 학습 완료 체크
    if(currentUser && currentUser.id && currentUser.name) {
      const dragDropAnswers = {};
      dropZones.forEach(zone => {
        const dropZone = document.getElementById(zone.id);
        const droppedWord = dropZone.querySelector('.dropped-word');
        if(droppedWord) {
          dragDropAnswers[zone.id] = droppedWord.textContent.trim();
        }
      });
      
      const currentData = getLearningState();
      saveLearningState({
        ...currentData,
        dragDropAnswers: dragDropAnswers
      });
      
      // 퀴즈도 맞았고 드래그앤드롭도 맞았으면 학습 완료 처리
      if(quizAnswered) {
        setLearningCompleted(currentUser.id, currentUser.name);
        // 네비게이션 버튼 상태 업데이트
        setTimeout(() => {
          updateNavigationButtons();
        }, 100);
      }
    }
  }
  
  function completeLearning() {
    // 1. 퀴즈 정답 확인
    if(!quizAnswered) {
      alert("⚠️ 개념 체크 문제의 정답을 먼저 맞춰주세요! 정답을 선택하면 초록색으로 표시됩니다.");
      return;
    }
    
    // 2. 드래그 앤 드롭 정답 확인
    const dropZones = [
      { id: 'drop1', correct: '초음파' },
      { id: 'drop2', correct: '반사' },
      { id: 'drop3', correct: '시간' },
      { id: 'drop4', correct: '거리' }
    ];
    
    const reflectionFeedbackDiv = document.getElementById('reflection-feedback');
    reflectionFeedbackDiv.style.display = 'block';
    
    let allFilled = true;
    let allCorrect = true;
    
    dropZones.forEach((zone) => {
      const dropZone = document.getElementById(zone.id);
      const droppedWord = dropZone.querySelector('.dropped-word');
      
      if(!droppedWord) {
        allFilled = false;
      } else {
        const word = droppedWord.textContent.trim();
        if(word !== zone.correct) {
          allCorrect = false;
        }
      }
    });
    
    if(!allFilled) {
      reflectionFeedbackDiv.style.background = 'rgba(254, 242, 242, 0.8)';
      reflectionFeedbackDiv.style.border = '2px solid #ef4444';
      reflectionFeedbackDiv.style.color = '#991b1b';
      reflectionFeedbackDiv.innerHTML = "❌ 모든 빈칸을 채워주세요!";
      return;
    }
    
    if(!allCorrect) {
      reflectionFeedbackDiv.style.background = 'rgba(254, 242, 242, 0.8)';
      reflectionFeedbackDiv.style.border = '2px solid #ef4444';
      reflectionFeedbackDiv.style.color = '#991b1b';
      reflectionFeedbackDiv.innerHTML = "❌ <strong>틀렸습니다!</strong> 정답 확인 버튼을 눌러 올바른 답을 확인해주세요.";
      return;
    }
    
    // 모두 정답일 때
    reflectionFeedbackDiv.style.background = 'rgba(237, 233, 254, 0.9)';
    reflectionFeedbackDiv.style.border = '2px solid #8b5cf6';
    reflectionFeedbackDiv.style.color = '#6d28d9';
    reflectionFeedbackDiv.innerHTML = "✅ <strong>모두 맞습니다!</strong> 초음파 센서의 원리를 잘 이해하셨네요! 이제 설계하러 가볼까요? 👉";
    
    setTimeout(() => {
      // 학습 완료 상태 저장
      if(currentUser && currentUser.id && currentUser.name) {
        // 드래그 앤 드롭 정답 최종 저장
        const dragDropAnswers = {};
        dropZones.forEach(zone => {
          const dropZone = document.getElementById(zone.id);
          const droppedWord = dropZone.querySelector('.dropped-word');
          if(droppedWord) {
            dragDropAnswers[zone.id] = droppedWord.textContent.trim();
          }
        });
        
        // 학습 상태 저장
        const currentState = getLearningState();
        saveLearningState({
          ...currentState,
          dragDropAnswers: dragDropAnswers,
          completed: true
        });
        
        setLearningCompleted(currentUser.id, currentUser.name);
        // 네비게이션 버튼 상태 업데이트
        setTimeout(() => {
          updateNavigationButtons();
        }, 100);
      }
      
      // 학습 완료 후 학생 메인으로 이동
      showView('view-student-main');
      // loadMySubmission은 showView에서 호출됨
      // 네비게이션 버튼 상태 업데이트
      setTimeout(() => {
        updateNavigationButtons();
      }, 300);
    }, 1500);
  }

  /* === 박쥐 생성 스크립트 === */
  function createBats() {
    const container = document.getElementById('bat-container');
    if(!container) return; // 컨테이너가 없으면 리턴
    
    // 기존 박쥐 제거
    container.innerHTML = '';
    
    const batCount = 20; // 박쥐 마리 수
    
    for(let i=0; i<batCount; i++) {
      const bat = document.createElement('div');
      bat.innerText = '🦇';
      bat.classList.add('flying-bat');
      
      // 1. 랜덤 시작 위치 (Y축 0~100%)
      const startY = Math.random() * 100;
      
      // 2. 랜덤 속도 (5초 ~ 15초 사이)
      const duration = 8 + Math.random() * 12; 
      
      // 3. 랜덤 딜레이 (0초 ~ 5초 사이 - 자연스럽게 순차 등장)
      const delay = Math.random() * 5;
      
      // 4. 랜덤 크기 (0.5배 ~ 1.5배 - 원근감 효과)
      const scale = 0.5 + Math.random() * 1; 
      
      // 스타일 적용
      bat.style.top = startY + 'vh';
      bat.style.left = '-10vw'; // 화면 왼쪽 밖에서 시작
      bat.style.animationDuration = duration + 's';
      bat.style.animationDelay = delay + 's';
      bat.style.fontSize = (2 * scale) + 'rem';
      bat.style.opacity = 0.3 + Math.random() * 0.5; // 투명도도 랜덤
      
      container.appendChild(bat);
    }
  }
  
  // showIntro 함수 수정
  const originalShowIntro = showIntro;
  showIntro = function() {
    originalShowIntro();
    // 인트로 화면이 표시될 때 박쥐 생성
    setTimeout(createBats, 100);
  };

  // === K-SDGs 설명 데이터 ===
  const sdgData = [
    { num: 1, title: "1. 빈곤층 감소와 사회안전망 강화", color: "#E5243B", desc: "기초 생활을 보장하고 튼튼한 사회안전망을 구축하여, 질병이나 실직 등 갑작스러운 위기 상황에서도 빈곤에 빠지지 않도록 보호합니다." },
    { num: 2, title: "2. 식량안보와 지속가능한 농업 강화", color: "#DDA63A", desc: "기아를 종식시키고 식량 안보를 확보하며, 유전자 다양성 보존 및 친환경 농법을 통해 지속가능한 농업 생산성을 높입니다." },
    { num: 3, title: "3. 건강하고 행복한 삶 보장", color: "#4C9F38", desc: "감염병 예방 및 정신 건강 증진을 통해 모든 연령층의 건강을 보호하고, 누구나 차별 없이 의료 혜택을 받는 보편적 의료 보장(UHC)을 달성합니다." },
    { num: 4, title: "4. 모두를 위한 양질의 교육", color: "#C5192D", desc: "성별, 장애, 계층에 관계없이 포용적이고 공평한 교육을 제공하며, 직업 기술 습득을 포함한 평생 학습의 기회를 보장합니다." },
    { num: 5, title: "5. 성평등 보장", color: "#FF3A21", desc: "여성과 소녀에 대한 모든 형태의 차별과 폭력을 근절하고, 정치·경제·사회 모든 분야에서 동등한 참여 기회와 리더십을 보장합니다." },
    { num: 6, title: "6. 건강하고 안전한 물 관리", color: "#26BDE2", desc: "모든 사람이 안전한 식수와 위생 시설을 이용할 수 있게 하고, 수질 오염 방지 및 물 부족 문제 해결을 위해 수자원을 효율적으로 관리합니다." },
    { num: 7, title: "7. 에너지의 친환경적 생산과 소비", color: "#FCC30B", desc: "화석 연료 의존도를 낮추고 태양광, 풍력 등 재생에너지 비율을 획기적으로 늘려, 누구나 저렴하고 깨끗한 에너지를 사용하게 합니다." },
    { num: 8, title: "8. 좋은 일자리 확대와 경제성장", color: "#A21942", desc: "노동권을 철저히 보호하고 청년 고용을 확대하며, 환경을 훼손하지 않는 기술 혁신을 통해 지속가능한 경제 성장을 이룹니다." },
    { num: 9, title: "9. 산업의 성장과 혁신 활성화 및 사회기반시설 구축", color: "#FD6925", desc: "재난에 강한 회복력 있는 사회기반시설(인프라)을 구축하고, 친환경 기술 개발과 연구를 지원하여 지속가능한 산업화를 촉진합니다." },
    { num: 10, title: "10. 모든 종류의 불평등 해소", color: "#DD1367", desc: "소득 불평등을 완화하고, 나이, 성별, 장애, 인종 등에 따른 차별적인 법과 관행을 개선하여 사회적 포용성을 강화합니다." },
    { num: 11, title: "11. 지속가능한 도시와 주거지 조성", color: "#FD9D24", desc: "주거 불안정과 교통 혼잡 문제를 해결하고 대기 오염을 줄여, 재난으로부터 안전하고 환경 친화적인 도시 공간을 조성합니다." },
    { num: 12, title: "12. 지속가능한 생산과 소비", color: "#BF8B2E", desc: "자원 낭비와 폐기물 발생을 줄이는 '순환 경제'를 실현하고, 기업이 환경적·사회적 책임을 다하며 생산하도록 장려합니다." },
    { num: 13, title: "13. 기후변화와 대응", color: "#3F7E44", desc: "기후 위기의 심각성을 인식하여 탄소 배출을 줄이기 위한 긴급 조치를 취하고, 기후 변화로 인한 자연재해 대응 능력을 키웁니다." },
    { num: 14, title: "14. 해양생태계 보전", color: "#0A97D9", desc: "해양 오염, 특히 플라스틱 쓰레기를 줄이고, 무분별한 남획을 규제하여 바다 생태계와 수산 자원의 다양성을 보전합니다." },
    { num: 15, title: "15. 육상생태계 보전", color: "#56C02B", desc: "무분별한 산림 훼손과 사막화를 방지하고, 멸종 위기종을 보호하여 육상 생태계의 생물다양성 손실을 막습니다." },
    { num: 16, title: "16. 평화·정의·포용", color: "#00689D", desc: "모든 형태의 폭력을 감소시키고, 공정한 사법 제도와 투명한 공공 기관을 구축하여 인권이 존중받는 정의로운 사회를 만듭니다." },
    { num: 17, title: "17. 지구촌 협력 강화", color: "#19486A", desc: "개발도상국에 대한 기술 및 재정 지원을 확대하고, 전 지구적 문제 해결을 위해 국제사회가 정책적으로 협력하고 연대합니다." }
  ];
  
  // SDGs 드롭다운 옵션 초기화
  function initSDGDropdown() {
    const optionsContainer = document.getElementById('sdg-dropdown-options');
    if(!optionsContainer) return;
    
    // 기존 옵션 제거
    optionsContainer.innerHTML = '';
    
    // 옵션 생성
    sdgData.forEach(item => {
      const div = document.createElement('div');
      div.className = 'option-item';
      div.onclick = () => selectSDGOption(item);
      div.innerHTML = `
        <div class="opt-title" style="color: ${item.color}">${item.title}</div>
      `;
      optionsContainer.appendChild(div);
    });
  }
  
  // === SDGs 커스텀 드롭다운 함수 ===
  function toggleSDGDropdown() {
    const options = document.getElementById('sdg-dropdown-options');
    const trigger = document.getElementById('sdg-trigger');
    if(options && trigger) {
      options.classList.toggle('open');
      trigger.classList.toggle('open');
    }
  }
  
  function selectSDGOption(item) {
    // 선택된 값 화면에 표시
    const displayElement = document.getElementById('sdg-selected-text');
    if(displayElement) {
      displayElement.innerText = item.title;
      displayElement.style.fontWeight = '700';
      displayElement.style.color = item.color;
    }
    
    // 숨겨진 select 요소에 값 설정 (기존 로직과 호환)
    const hiddenSelect = document.getElementById('inp-sdg');
    if(hiddenSelect) {
      hiddenSelect.value = item.num;
      // change 이벤트 발생시켜 기존 로직이 동작하도록
      hiddenSelect.dispatchEvent(new Event('change'));
    }
    
    // 설명 박스 업데이트
    const infoBox = document.getElementById('sdg-detail-box');
    if(infoBox) {
      infoBox.className = 'info-box active';
      infoBox.style.borderColor = item.color;
      infoBox.innerHTML = `
        <div class="info-text">${item.desc}</div>
      `;
    }
    
    // 목록 닫기
    const options = document.getElementById('sdg-dropdown-options');
    const trigger = document.getElementById('sdg-trigger');
    if(options) options.classList.remove('open');
    if(trigger) trigger.classList.remove('open');
  }
  
  // 화면의 빈 곳을 누르면 SDGs 드롭다운 목록 닫기
  document.addEventListener('click', function(event) {
    const wrapper = document.querySelector('.select-wrapper');
    const trigger = document.getElementById('sdg-trigger');
    const options = document.getElementById('sdg-dropdown-options');
    
    if(wrapper && !wrapper.contains(event.target)) {
      if(options) options.classList.remove('open');
      if(trigger) trigger.classList.remove('open');
    }
  });
  
  // 제출 데이터 로드 시 SDGs 값 복원
  function restoreSDGSelection(value) {
    if(!value) return;
    
    const item = sdgData.find(d => d.num.toString() === value.toString());
    if(!item) return;
    
    const displayElement = document.getElementById('sdg-selected-text');
    if(displayElement) {
      displayElement.innerText = item.title;
      displayElement.style.fontWeight = '700';
      displayElement.style.color = item.color;
    }
    
    // 설명 박스 업데이트
    const infoBox = document.getElementById('sdg-detail-box');
    if(infoBox) {
      infoBox.className = 'info-box active';
      infoBox.style.borderColor = item.color;
      infoBox.innerHTML = `
        <div class="info-text">${item.desc}</div>
      `;
    }
  }
  
  const originalLoadMySubmission = typeof loadMySubmission !== 'undefined' ? loadMySubmission : null;
  if(originalLoadMySubmission) {
    // 기존 함수를 래핑하여 SDGs 값 복원 기능 추가
    window.loadMySubmission = function() {
      originalLoadMySubmission();
      
      // SDGs 값 복원
      setTimeout(() => {
        const hiddenSelect = document.getElementById('inp-sdg');
        if(hiddenSelect && hiddenSelect.value) {
          restoreSDGSelection(hiddenSelect.value);
        }
      }, 100);
    };
  }

  // 초기 실행
  // 환경 변수에서 API 키가 있으면 localStorage에 자동 저장
  if(typeof window !== 'undefined' && window.VITE_OPENAI_API_KEY) {
    if(!localStorage.getItem('openai_api_key')) {
      localStorage.setItem('openai_api_key', window.VITE_OPENAI_API_KEY);
    }
  }
  
  // === 센서 & 반응 설계 통합 UI 함수 ===
  
  // 드롭다운에서 "직접 입력" 선택 시 입력칸 보이기
  function handleDeviceChange(selectEl) {
    const row = selectEl.parentElement;
    const customInput = row.querySelector('.custom-device-input');
    
    if(selectEl.value === 'custom') {
      customInput.style.display = 'block';
      customInput.focus();
    } else {
      customInput.style.display = 'none';
      customInput.value = '';
    }
    updateSensorDesign();
  }
  
  // 동작 행 추가
  function addActionRow(listId) {
    const list = document.getElementById(listId);
    if(!list) return;
    
    const row = document.createElement('div');
    row.className = 'action-row';
    row.innerHTML = `
      <select onchange="handleDeviceChange(this)">
        <option>💡 LED</option>
        <option>🔊 스피커</option>
        <option>🦾 서보모터</option>
        <option>📟 디스플레이</option>
        <option>🌀 DC모터</option>
        <option value="custom">✏️ 직접 입력</option>
      </select>
      <input type="text" class="custom-device-input" placeholder="장치 이름">
      <input type="text" class="action-detail" placeholder="동작 입력" oninput="updateSensorDesign()">
      <button class="btn-remove-action" onclick="removeActionRow(this)">×</button>
    `;
    list.appendChild(row);
    updateSensorDesign();
  }
  
  // 동작 행 제거
  function removeActionRow(btn) {
    const list = btn.parentElement.parentElement;
    btn.parentElement.remove();
    
    // 동작이 하나도 없으면 기본 동작 하나 추가
    if(list && list.querySelectorAll('.action-row').length === 0) {
      addActionRow(list.id);
    } else {
      updateSensorDesign();
    }
  }
  
  // 장치 이름 가져오기 (드롭다운 or 직접입력)
  function getDeviceName(row) {
    const select = row.querySelector('select');
    const customInput = row.querySelector('.custom-device-input');
    
    if(select && select.value === 'custom') {
      return customInput ? ('🔧 ' + (customInput.value || '(장치명 입력)')) : '';
    } else if(select) {
      return select.selectedOptions[0] ? select.selectedOptions[0].text : '';
    }
    return '';
  }
  
  // 새로운 구조에서 동작 배열 가져오기 (기존 코드 호환용)
  function getActionsFromUI(listId) {
    const list = document.getElementById(listId);
    if(!list) return [];
    
    const actions = [];
    list.querySelectorAll('.action-row').forEach(row => {
      const device = getDeviceName(row);
      const detail = row.querySelector('.action-detail');
      if(device && detail) {
        actions.push({
          device: device,
          action: detail.value || ''
        });
      }
    });
    return actions;
  }
  
  // 전체 업데이트 (거리 변경 시)
  function updateSensorDesign() {
    const thresholdInput = document.getElementById('inp-dist');
    if(!thresholdInput) return;
    
    const threshold = thresholdInput.value || 30;
    const trueThreshold = document.getElementById('true-threshold');
    const falseThreshold = document.getElementById('false-threshold');
    
    if(trueThreshold) trueThreshold.textContent = threshold;
    if(falseThreshold) falseThreshold.textContent = threshold;
    updateAlgorithmPreview();
  }
  
  // 알고리즘 미리보기 업데이트
  function updateAlgorithmPreview() {
    const thresholdInput = document.getElementById('inp-dist');
    const condOnInput = document.getElementById('inp-cond-on');
    const condOffInput = document.getElementById('inp-cond-off');
    const trueList = document.getElementById('true-actions');
    const falseList = document.getElementById('false-actions');
    const previewBox = document.getElementById('algorithm-preview');
    
    if(!previewBox) return;
    
    const threshold = thresholdInput ? (thresholdInput.value || 30) : 30;
    const trueSituation = condOnInput ? (condOnInput.value || '(상황을 적어주세요)') : '(상황을 적어주세요)';
    const falseSituation = condOffInput ? (condOffInput.value || '(상황을 적어주세요)') : '(상황을 적어주세요)';
    
    let trueActions = '';
    if(trueList) {
      trueList.querySelectorAll('.action-row').forEach(row => {
        const device = getDeviceName(row);
        const detailInput = row.querySelector('.action-detail');
        const action = detailInput ? (detailInput.value || '(동작 입력)') : '(동작 입력)';
        if(device) {
          trueActions += `&nbsp;&nbsp;&nbsp;&nbsp;<span class="act">→ ${device} ${action}</span><br>`;
        }
      });
    }
    
    let falseActions = '';
    if(falseList) {
      falseList.querySelectorAll('.action-row').forEach(row => {
        const device = getDeviceName(row);
        const detailInput = row.querySelector('.action-detail');
        const action = detailInput ? (detailInput.value || '(동작 입력)') : '(동작 입력)';
        if(device) {
          falseActions += `&nbsp;&nbsp;&nbsp;&nbsp;<span class="act">→ ${device} ${action}</span><br>`;
        }
      });
    }
    
    previewBox.innerHTML = `
      <span class="kw">만약</span> <span class="cond">거리 < ${threshold}cm</span> <span class="kw">이면:</span><br>
      &nbsp;&nbsp;&nbsp;&nbsp;<span class="situation">// ${trueSituation}</span><br>
      ${trueActions || '&nbsp;&nbsp;&nbsp;&nbsp;<span class="act">(동작 없음)</span><br>'}
      <span class="kw">아니면:</span><br>
      &nbsp;&nbsp;&nbsp;&nbsp;<span class="situation">// ${falseSituation}</span><br>
      ${falseActions || '&nbsp;&nbsp;&nbsp;&nbsp;<span class="act">(동작 없음)</span><br>'}
    `;
  }
  
  // 페이지 로드 시 박쥐 생성 및 SDGs 드롭다운 초기화
  window.addEventListener('load', function() {
    if(document.getElementById('view-intro') && document.getElementById('view-intro').classList.contains('active')) {
      createBats();
    }
    
    // SDGs 드롭다운 초기화
    initSDGDropdown();
    
    // SDGs 값 복원
    setTimeout(() => {
      const hiddenSelect = document.getElementById('inp-sdg');
      if(hiddenSelect && hiddenSelect.value) {
        restoreSDGSelection(hiddenSelect.value);
      }
      
      // 알고리즘 미리보기 초기화
      updateAlgorithmPreview();
      
      // 입력 이벤트 리스너 추가
      const thresholdInput = document.getElementById('inp-dist');
      if(thresholdInput) {
        thresholdInput.addEventListener('input', updateSensorDesign);
      }
      
      const conditionInputs = ['inp-cond-on', 'inp-cond-off'];
      conditionInputs.forEach(id => {
        const input = document.getElementById(id);
        if(input) {
          input.addEventListener('input', updateAlgorithmPreview);
        }
      });
    }, 500);
  });
  
  // === 아이디어 선정 페이지 관련 함수 ===
  
  // 아이디어 선정 페이지로 이동
  function goToIdeaSelection() {
    if(currentUser && currentUser.id && currentUser.name) {
      const userTag = document.getElementById('selection-user-display');
      if(userTag) {
        userTag.textContent = `${currentUser.id} ${currentUser.name}`;
      }
    }
    showView('view-idea-selection');
    initIdeaSelection();
  }
  
  // 설계 페이지로 돌아가기
  function goBackToDesign() {
    showView('view-student-main');
  }
  
  // 설계 페이지로 이동
  function goToDesignPage() {
    showView('view-student-main');
  }
  
  // 아이디어 선정 데이터
  let selectionMembers = [];
  let selectionPMIData = [];
  let selectionCriteria = [];
  let selectionMatrixScores = {};
  let selectionCurrentTab = 0;
  const selectionTabs = ['pmi', 'matrix', 'final'];
  
  // 아이디어 선정 초기화
  function initIdeaSelection() {
    loadSelectionData();
    updateMemberList();
    updateMemberSelect();
    updatePMITable();
    updateCriteriaDisplay();
    updateMatrixTable();
    
    // 아이디어 선정 페이지의 모든 입력 필드 활성화
    const selectionPage = document.getElementById('view-idea-selection');
    if(selectionPage) {
      const inputs = selectionPage.querySelectorAll('input, textarea, select');
      inputs.forEach(el => {
        el.disabled = false;
        el.style.pointerEvents = 'auto';
        el.style.opacity = '1';
        el.style.cursor = 'auto';
        if(el.tagName === 'INPUT' || el.tagName === 'TEXTAREA') {
          el.readOnly = false;
        }
      });
    }
    
    // 다음 버튼 활성화
    const selectionNextBtn = document.getElementById('selection-next-btn');
    if(selectionNextBtn) {
      selectionNextBtn.disabled = false;
      selectionNextBtn.style.opacity = '1';
      selectionNextBtn.style.cursor = 'pointer';
      selectionNextBtn.onclick = () => goToNextPage('selection');
    }
    
    // 이전 버튼 활성화
    const selectionPrevBtn = document.getElementById('selection-prev-btn');
    if(selectionPrevBtn) {
      selectionPrevBtn.disabled = false;
      selectionPrevBtn.style.opacity = '1';
      selectionPrevBtn.style.cursor = 'pointer';
    }
    
    // 현재 탭에 따라 다음 탭 버튼 표시/숨기기
    const nextTabBtn = document.querySelector('.selection-next-btn');
    if(nextTabBtn) {
      if(selectionCurrentTab === 2) {
        nextTabBtn.style.display = 'none';
      } else {
        nextTabBtn.style.display = 'block';
      }
    }
  }
  
  // 데이터 저장/불러오기 (학생별로 저장)
  function loadSelectionData() {
    if(!currentUser || !currentUser.id || !currentUser.name) {
      // 현재 사용자 정보가 없으면 빈 데이터로 초기화
      selectionMembers = [];
      selectionPMIData = [];
      selectionCriteria = [];
      selectionMatrixScores = {};
      return;
    }
    
    const dataKey = `pblData_${currentUser.id}_${currentUser.name}`;
    const saved = localStorage.getItem(dataKey);
    if(saved) {
      try {
        const data = JSON.parse(saved);
        selectionMembers = data.members || [];
        selectionPMIData = data.pmiData || [];
        selectionCriteria = data.criteria || [];
        selectionMatrixScores = data.matrixScores || {};
      } catch(e) {
        console.error('선정 데이터 로드 오류:', e);
        selectionMembers = [];
        selectionPMIData = [];
        selectionCriteria = [];
        selectionMatrixScores = {};
      }
    } else {
      // 데이터가 없으면 빈 배열로 초기화
      selectionMembers = [];
      selectionPMIData = [];
      selectionCriteria = [];
      selectionMatrixScores = {};
    }
  }
  
  function saveSelectionData() {
    if(!currentUser || !currentUser.id || !currentUser.name) {
      console.error('현재 사용자 정보가 없어 데이터를 저장할 수 없습니다.');
      return;
    }
    
    const dataKey = `pblData_${currentUser.id}_${currentUser.name}`;
    localStorage.setItem(dataKey, JSON.stringify({
      members: selectionMembers,
      pmiData: selectionPMIData,
      criteria: selectionCriteria,
      matrixScores: selectionMatrixScores
    }));
  }
  
  // 모둠원 관리
  function addMember() {
    const input = document.getElementById('newMember');
    if(!input) return;
    const name = input.value.trim();
    if(!name || selectionMembers.includes(name)) return;
    
    selectionMembers.push(name);
    saveSelectionData();
    updateMemberList();
    updateMemberSelect();
    input.value = '';
  }
  
  function removeMember(name) {
    selectionMembers = selectionMembers.filter(m => m !== name);
    saveSelectionData();
    updateMemberList();
    updateMemberSelect();
  }
  
  function updateMemberList() {
    const list = document.getElementById('memberList');
    if(!list) return;
    list.innerHTML = selectionMembers.length === 0 
      ? '<span style="color:#94a3b8; font-size:13px;">모둠원을 추가해주세요</span>'
      : selectionMembers.map(m => `
        <div class="member-tag">
          ${m}
          <button onclick="removeMember('${m}')">&times;</button>
        </div>
      `).join('');
  }
  
  function updateMemberSelect() {
    const select = document.getElementById('ideaProposer');
    if(!select) return;
    select.innerHTML = '<option value="">선택하세요</option>' + 
      selectionMembers.map(m => `<option value="${m}">${m}</option>`).join('');
  }
  
  // 탭 전환
  function showSelectionTab(tabName) {
    document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    const tab = document.getElementById(tabName + '-tab');
    const btn = Array.from(document.querySelectorAll('.tab-btn'))[selectionTabs.indexOf(tabName)];
    if(tab) tab.classList.add('active');
    if(btn) btn.classList.add('active');
    selectionCurrentTab = selectionTabs.indexOf(tabName);
    
    // 최종 선정 탭일 때 다음 탭 버튼 숨기기
    const nextTabBtn = document.querySelector('.selection-next-btn');
    if(nextTabBtn) {
      if(tabName === 'final') {
        nextTabBtn.style.display = 'none';
      } else {
        nextTabBtn.style.display = 'block';
      }
    }
    
    // 이전 탭 버튼 표시/숨기기
    const prevTabBtn = document.querySelector('.selection-prev-btn');
    if(prevTabBtn) {
      if(selectionCurrentTab === 0) {
        prevTabBtn.style.display = 'none';
      } else {
        prevTabBtn.style.display = 'block';
      }
    }
    
    if(tabName === 'matrix') updateMatrixTable();
    if(tabName === 'final') updateFinalResult();
  }
  
  function nextSelectionTab() {
    if(selectionCurrentTab < 2) {
      showSelectionTab(selectionTabs[selectionCurrentTab + 1]);
    }
  }
  
  // PMI 분석
  function savePMI() {
    const nameInput = document.getElementById('ideaName');
    const proposerSelect = document.getElementById('ideaProposer');
    const plusText = document.getElementById('pmiPlus');
    const minusText = document.getElementById('pmiMinus');
    const interestingText = document.getElementById('pmiInteresting');
    
    if(!nameInput) return;
    const name = nameInput.value.trim();
    if(!name) {
      alert('아이디어 이름을 입력해주세요!');
      return;
    }
    
    const proposer = proposerSelect ? proposerSelect.value : '';
    const plus = plusText ? plusText.value.trim() : '';
    const minus = minusText ? minusText.value.trim() : '';
    const interesting = interestingText ? interestingText.value.trim() : '';
    
    selectionPMIData.push({
      id: Date.now(),
      name,
      proposer,
      plus,
      minus,
      interesting
    });
    saveSelectionData();
    updatePMITable();
    
    // 폼 초기화
    if(nameInput) nameInput.value = '';
    if(proposerSelect) proposerSelect.value = '';
    if(plusText) plusText.value = '';
    if(minusText) minusText.value = '';
    if(interestingText) interestingText.value = '';
    
    const alert = document.getElementById('pmiAlert');
    if(alert) {
      alert.classList.add('show');
      setTimeout(() => alert.classList.remove('show'), 2000);
    }
  }
  
  function updatePMITable() {
    const tbody = document.getElementById('pmiTableBody');
    if(!tbody) return;
    
    if(selectionPMIData.length === 0) {
      tbody.innerHTML = `<tr><td colspan="5" class="empty-state">
        <div class="icon">📝</div><p>아직 분석된 아이디어가 없습니다.</p>
      </td></tr>`;
      return;
    }
    
    tbody.innerHTML = selectionPMIData.map((item, i) => `
      <tr>
        <td>${i + 1}</td>
        <td><strong>${item.name}</strong></td>
        <td>${item.proposer ? `<span class="proposer-badge">${item.proposer}</span>` : '-'}</td>
        <td class="pmi-cell">
          <div class="pmi-tags">
            ${item.plus ? `<span class="pmi-tag plus">+ ${item.plus}</span>` : ''}
            ${item.minus ? `<span class="pmi-tag minus">− ${item.minus}</span>` : ''}
            ${item.interesting ? `<span class="pmi-tag interesting">? ${item.interesting}</span>` : ''}
          </div>
        </td>
        <td><button class="delete-btn" onclick="deletePMI(${item.id})">삭제</button></td>
      </tr>
    `).join('');
  }
  
  function deletePMI(id) {
    if(confirm('삭제하시겠습니까?')) {
      selectionPMIData = selectionPMIData.filter(item => item.id !== id);
      delete selectionMatrixScores[id];
      saveSelectionData();
      updatePMITable();
      updateMatrixTable();
    }
  }
  
  // 평가 기준
  function addCriteria() {
    const input = document.getElementById('newCriteria');
    if(!input) return;
    const name = input.value.trim();
    if(!name || selectionCriteria.includes(name)) return;
    selectionCriteria.push(name);
    saveSelectionData();
    updateCriteriaDisplay();
    updateMatrixTable();
    input.value = '';
  }
  
  function addSuggestedCriteria(name) {
    if(!selectionCriteria.includes(name)) {
      selectionCriteria.push(name);
      saveSelectionData();
      updateCriteriaDisplay();
      updateMatrixTable();
    }
  }
  
  function removeCriteria(name) {
    selectionCriteria = selectionCriteria.filter(c => c !== name);
    saveSelectionData();
    updateCriteriaDisplay();
    updateMatrixTable();
  }
  
  function updateCriteriaDisplay() {
    const list = document.getElementById('criteriaList');
    if(!list) return;
    list.innerHTML = selectionCriteria.map(c => `
      <div class="criteria-tag">${c}<button onclick="removeCriteria('${c}')">&times;</button></div>
    `).join('');
  }
  
  // 평가행렬
  function updateMatrixTable() {
    const thead = document.getElementById('matrixHead');
    const tbody = document.getElementById('matrixBody');
    
    if(!thead || !tbody) return;
    
    if(selectionPMIData.length === 0) {
      thead.innerHTML = '<tr><th>아이디어</th><th>총점</th><th>순위</th></tr>';
      tbody.innerHTML = `<tr><td colspan="3" class="empty-state">
        <div class="icon">📊</div><p>PMI 분석에서 아이디어를 먼저 추가해주세요.</p>
      </td></tr>`;
      return;
    }
    
    thead.innerHTML = '<tr><th>아이디어</th>' + 
      selectionCriteria.map(c => `<th>${c}</th>`).join('') + 
      '<th>총점</th><th>순위</th></tr>';
    
    tbody.innerHTML = selectionPMIData.map(item => {
      const scores = selectionMatrixScores[item.id] || {};
      return `<tr>
        <td style="text-align:left;"><strong>${item.name}</strong><br><small style="color:#94a3b8;">${item.proposer || ''}</small></td>
        ${selectionCriteria.map(c => `<td><input type="number" min="0" max="5" value="${scores[c] || ''}" 
          onchange="updateScore(${item.id}, '${c}', this.value)" oninput="this.value = Math.min(5, Math.max(0, parseInt(this.value) || 0))" placeholder="0-5"></td>`).join('')}
        <td class="total-cell">${scores.total || '-'}</td>
        <td class="rank-cell">${getRankEmoji(scores.rank)}</td>
      </tr>`;
    }).join('');
  }
  
  function updateScore(id, c, val) {
    if(!selectionMatrixScores[id]) selectionMatrixScores[id] = {};
    // 최대 5점 제한
    const score = Math.min(5, Math.max(0, parseInt(val) || 0));
    selectionMatrixScores[id][c] = score;
    // 입력 필드 값도 업데이트 (5점 초과 시)
    const input = event?.target;
    if(input && parseInt(val) > 5) {
      input.value = 5;
    }
    saveSelectionData();
  }
  
  function calculateMatrix() {
    if(selectionPMIData.length === 0) {
      alert('아이디어를 먼저 추가해주세요!');
      return;
    }
    if(selectionCriteria.length === 0) {
      alert('평가 기준을 추가해주세요!');
      return;
    }
    
    const totals = selectionPMIData.map(item => {
      let total = 0;
      selectionCriteria.forEach(c => total += selectionMatrixScores[item.id]?.[c] || 0);
      if(!selectionMatrixScores[item.id]) selectionMatrixScores[item.id] = {};
      selectionMatrixScores[item.id].total = total;
      return { id: item.id, total };
    });
    
    totals.sort((a, b) => b.total - a.total);
    totals.forEach((item, i) => selectionMatrixScores[item.id].rank = i + 1);
    
    saveSelectionData();
    updateMatrixTable();
    alert('점수 계산 완료! "최종 선정" 탭에서 확인하세요.');
  }
  
  function getRankEmoji(rank) {
    if(rank === 1) return '🥇';
    if(rank === 2) return '🥈';
    if(rank === 3) return '🥉';
    return rank || '-';
  }
  
  // 최종 결과
  function updateFinalResult() {
    const container = document.getElementById('finalResult');
    if(!container) return;
    
    const rankings = selectionPMIData
      .map(item => ({
        name: item.name,
        proposer: item.proposer,
        total: selectionMatrixScores[item.id]?.total || 0,
        rank: selectionMatrixScores[item.id]?.rank || 999
      }))
      .filter(item => item.total > 0)
      .sort((a, b) => a.rank - b.rank);
    
    if(rankings.length === 0) {
      container.innerHTML = `<div class="empty-state">
        <div class="icon">🏆</div>
        <p>평가행렬법에서 점수를 계산하면<br>최종 결과가 표시됩니다.</p>
      </div>`;
      return;
    }
    
    const winner = rankings[0];
    container.innerHTML = `
      <div class="winner-card">
        <div class="trophy">🏆</div>
        <div class="winner-name">${winner.name}</div>
        ${winner.proposer ? `<div class="winner-proposer">제안자: ${winner.proposer}</div>` : ''}
        <div class="winner-score">총점: ${winner.total}점</div>
      </div>
      <div class="ranking-list">
        <h3 style="margin-bottom:15px; color:#475569; font-size:16px; font-weight:700;">📊 전체 순위</h3>
        ${rankings.map((item, i) => `
          <div class="ranking-item">
            <div class="rank">${getRankEmoji(i + 1)}</div>
            <div class="info">
              <div class="name">${item.name}</div>
              ${item.proposer ? `<div class="proposer">제안: ${item.proposer}</div>` : ''}
            </div>
            <div class="score">${item.total}점</div>
          </div>
        `).join('')}
      </div>
    `;
  }
  
  // AI 피드백 요청 함수
  async function requestAIFeedback(data) {
    const apiKey = getApiKey();
    if(!apiKey) {
      throw new Error('API 키가 설정되지 않았습니다.');
    }
    
    const sdgText = document.getElementById('inp-sdg')?.options[document.getElementById('inp-sdg').selectedIndex]?.text || data.sdg;
    const actionsOnText = data.actionsOn.map(a => `${a.device}: ${a.action}`).join(', ');
    const actionsOffText = data.actionsOff.map(a => `${a.device}: ${a.action}`).join(', ');
    
    const prompt = `당신은 SDGs 교육 전문가이자 창의적 문제해결 코치입니다. 학생의 설계를 다음 기준으로 평가하고 친절하게 피드백해주세요.

[학생 설계 내용]
- 문제 정의: ${data.problem}
- SDGs 목표: ${sdgText}
- 기준 거리: ${data.distance}cm
- 가까울 때 조건: ${data.conditionOn}
- 가까울 때 동작: ${actionsOnText}
- 멀 때 조건: ${data.conditionOff}
- 멀 때 동작: ${actionsOffText}
- 전체 시나리오: ${data.scenario}

[피드백 작성 가이드]
1. 학생의 작성 수준에 맞춰 피드백하세요. 대충 적으면 대충이라고, 구체적으로 적으면 구체적으로 피드백합니다.
2. "고치면 더 좋아질 부분"과 "한 번 더 생각해 보면 좋은 질문"을 구분해서 제시하세요.
3. 초음파 센서의 기술적 한계와 실제 구현 가능성을 고려하세요.
4. SDGs 목표와의 연관성을 확인하세요.

[피드백 형식]
다음 JSON 형식으로만 응답하세요 (다른 텍스트 없이):
{
  "generalFeedback": "전체적인 피드백 한 문장 (없으면 null)",
  "improvements": ["개선 사항 1", "개선 사항 2", ...],
  "questions": ["질문 1", "질문 2", ...]
}`;
    
    try {
      const response = await fetch('https://api.openai.com/v1/chat/completions', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${apiKey}`
        },
        body: JSON.stringify({
          model: 'gpt-4o-mini',
          messages: [
            {
              role: 'system',
              content: 'You are a helpful assistant that provides feedback in JSON format only, without any additional text.'
            },
            {
              role: 'user',
              content: prompt
            }
          ],
          temperature: 0.7,
          max_tokens: 1000
        })
      });
      
      if(!response.ok) {
        throw new Error(`API 오류: ${response.status}`);
      }
      
      const result = await response.json();
      const content = result.choices[0].message.content.trim();
      
      // JSON 파싱
      let feedback;
      try {
        // 코드 블록 제거
        const jsonMatch = content.match(/\{[\s\S]*\}/);
        if(jsonMatch) {
          feedback = JSON.parse(jsonMatch[0]);
        } else {
          feedback = JSON.parse(content);
        }
      } catch(e) {
        // JSON 파싱 실패 시 기본 구조로 변환
        feedback = {
          generalFeedback: content.split('\n')[0] || null,
          improvements: [],
          questions: []
        };
        const lines = content.split('\n').filter(l => l.trim());
        lines.forEach(line => {
          if(line.includes('개선') || line.includes('고치면')) {
            feedback.improvements.push(line.replace(/^[-\*\d\.\s]+/, '').trim());
          } else if(line.includes('질문') || line.includes('생각')) {
            feedback.questions.push(line.replace(/^[-\*\d\.\s]+/, '').trim());
          }
        });
      }
      
      return feedback;
    } catch(error) {
      console.error('AI 피드백 요청 오류:', error);
      throw error;
    }
  }
  
  // AI 피드백 표시 함수 (이전 형식으로 복원)
  function displayAIFeedback(feedback, hasWarnings) {
    const box = document.getElementById('chat-box');
    box.innerHTML = '';
    
    const container = document.createElement('div');
    container.className = 'ai-coach-container';
    
    let html = `
      <div class="ai-coach-header">
        <h3>AI 설계 코치</h3>
      </div>
      <div class="ai-coach-description">
        대충 적으면 대충이라고, 구체적으로 적으면 구체적으로 피드백합니다.
      </div>
    `;
    
    // 일반 피드백
    if(feedback.generalFeedback || feedback.summary) {
      const generalFeedback = feedback.generalFeedback || feedback.summary;
      html += `
        <div class="general-feedback">
          ${generalFeedback}
        </div>
      `;
    }
    
    // 개선 사항
    if(feedback.improvements && feedback.improvements.length > 0) {
      html += `
        <div class="feedback-section">
          <div class="feedback-section-title improvements">
            🔧 고치면 더 좋아질 부분:
          </div>
      `;
      feedback.improvements.forEach(improvement => {
        html += `
          <div class="feedback-item improvement">
            ${improvement}
          </div>
        `;
      });
      html += `</div>`;
    }
    
    // 질문들
    if(feedback.questions && feedback.questions.length > 0) {
      html += `
        <div class="feedback-section">
          <div class="feedback-section-title questions">
            ❓ 한 번 더 생각해 보면 좋은 질문:
          </div>
      `;
      feedback.questions.forEach(question => {
        html += `
          <div class="feedback-item question">
            ${question}
          </div>
        `;
      });
      html += `</div>`;
    }
    
    container.innerHTML = html;
    box.appendChild(container);
    box.scrollTop = box.scrollHeight;
  }
  
  // 기본 피드백 표시 함수 (API 키가 없을 때)
  function displayBasicFeedback(suggestions, sdg) {
    const box = document.getElementById('chat-box');
    box.innerHTML = '';
    
    addChat("✅ <strong>[기본 검증 통과]</strong> 필수 항목이 모두 충족되었습니다!", "success");
    
    if(suggestions.length > 0) {
      displayAIFeedback({
        generalFeedback: "기본 검증을 통과했습니다. 아래 개선 사항을 참고하세요.",
        improvements: suggestions,
        questions: []
      }, false);
    }
    
    if(sdg) {
      const sdgText = document.getElementById('inp-sdg').options[document.getElementById('inp-sdg').selectedIndex].text;
      addChat("<br>🎯 <strong>SDGs 관련성:</strong> " + sdgText + " 달성에 기여하는 좋은 설계입니다!", "success");
    }
    
    addChat("<br>💡 <em>더 상세한 피드백을 받으려면 교사에게 API 키 설정을 요청하세요.</em>", "ai");
    addChat("<br>이제 '제출' 버튼을 눌러 선생님께 제출할 수 있습니다.", "success");
  }
  
  // 제출 후 선정 페이지로 이동 버튼 표시
  const originalSubmitAssignment = typeof submitAssignment !== 'undefined' ? submitAssignment : null;
  if(originalSubmitAssignment) {
    window.submitAssignment = function() {
      originalSubmitAssignment();
      const btn = document.getElementById('btn-go-selection');
      if(btn) {
        btn.style.display = 'block';
      }
      // 네비게이션 버튼 상태 업데이트
      setTimeout(() => {
        updateNavigationButtons();
      }, 200);
    };
  }
  
  // 페이지 완료 여부 확인 함수
  function checkPageCompleted(page) {
    if(!currentUser || !currentUser.id || !currentUser.name) return false;
    
    switch(page) {
      case 'learning':
        return checkLearningCompleted(currentUser.id, currentUser.name);
      case 'design':
        const allSubmissions = JSON.parse(localStorage.getItem('student_submissions') || '[]');
        const mySub = allSubmissions.find(s => s.id === currentUser.id && s.name === currentUser.name);
        return !!mySub; // 제출 기록이 있으면 완료
      case 'selection':
        if(!currentUser || !currentUser.id || !currentUser.name) return false;
        const selectionDataKey = `pblData_${currentUser.id}_${currentUser.name}`;
        const pblData = JSON.parse(localStorage.getItem(selectionDataKey) || '{}');
        return !!(pblData.pmiData && pblData.pmiData.length > 0);
      default:
        return false;
    }
  }
  
  // 이전 페이지로 이동
  function goToPreviousPage(currentPage) {
    switch(currentPage) {
      case 'learning':
        // 첫 페이지이므로 이전 없음
        return;
      case 'design':
        // 학습 페이지로 이동
        if(checkPageCompleted('learning')) {
          showView('view-student-learning');
          initSimulation();
        }
        break;
      case 'selection':
        // 설계 페이지로 이동
        if(checkPageCompleted('design')) {
          showView('view-student-main');
        }
        break;
      case 'doctor':
        // 아이디어 선정 페이지로 이동
        showView('view-idea-selection');
        setTimeout(() => {
          initIdeaSelection();
        }, 100);
        break;
    }
  }
  
  // 다음 페이지로 이동
  function goToNextPage(currentPage) {
    if(!currentUser || !currentUser.id || !currentUser.name) {
      alert('로그인이 필요합니다.');
      return;
    }
    
    switch(currentPage) {
      case 'learning':
        // 학습 완료했으면 설계 페이지로
        if(checkPageCompleted('learning')) {
          showView('view-student-main');
        } else {
          alert('먼저 학습을 완료해주세요!');
        }
        break;
      case 'design':
        // 설계 완료(제출)했으면 선정 페이지로
        if(checkPageCompleted('design')) {
          goToIdeaSelection();
        } else {
          alert('먼저 아이디어를 제출해주세요!');
        }
        break;
      case 'selection':
        // 마이크로비트 닥터 페이지로 이동
        console.log('마이크로비트 닥터 페이지로 이동 시도');
        try {
          showView('view-microbit-doctor');
          console.log('showView 호출 완료');
          setTimeout(() => {
            if(typeof initMicrobitDoctor === 'function') {
              initMicrobitDoctor();
              console.log('initMicrobitDoctor 호출 완료');
            } else {
              console.error('initMicrobitDoctor 함수를 찾을 수 없습니다');
            }
          }, 100);
        } catch(e) {
          console.error('페이지 이동 오류:', e);
          alert('페이지 이동 중 오류가 발생했습니다: ' + e.message);
        }
        break;
      case 'doctor':
        // 마지막 페이지이므로 다음 없음
        return;
    }
  }
  
  // 네비게이션 버튼 상태 업데이트
  function updateNavigationButtons() {
    if(!currentUser || !currentUser.id || !currentUser.name) return;
    
    // 학습 페이지 네비게이션
    const learningPrevBtn = document.getElementById('learning-prev-btn');
    const learningNextBtn = document.getElementById('learning-next-btn');
    if(learningPrevBtn) {
      learningPrevBtn.disabled = true; // 첫 페이지이므로 이전 없음
    }
    if(learningNextBtn) {
      const learningCompleted = checkPageCompleted('learning');
      learningNextBtn.disabled = !learningCompleted;
      if(learningCompleted) {
        learningNextBtn.style.opacity = '1';
        learningNextBtn.style.cursor = 'pointer';
      } else {
        learningNextBtn.style.opacity = '0.5';
        learningNextBtn.style.cursor = 'not-allowed';
      }
    }
    
    // 설계 페이지 네비게이션
    const designPrevBtn = document.getElementById('design-prev-btn');
    const designNextBtn = document.getElementById('design-next-btn');
    if(designPrevBtn) {
      const learningCompleted = checkPageCompleted('learning');
      designPrevBtn.disabled = !learningCompleted;
      if(!learningCompleted) {
        designPrevBtn.style.opacity = '0.5';
        designPrevBtn.style.cursor = 'not-allowed';
      } else {
        designPrevBtn.style.opacity = '1';
        designPrevBtn.style.cursor = 'pointer';
      }
    }
    if(designNextBtn) {
      const designCompleted = checkPageCompleted('design');
      designNextBtn.disabled = !designCompleted;
      if(designCompleted) {
        designNextBtn.style.opacity = '1';
        designNextBtn.style.cursor = 'pointer';
      } else {
        designNextBtn.style.opacity = '0.5';
        designNextBtn.style.cursor = 'not-allowed';
      }
    }
    
    // 선정 페이지 네비게이션
    const selectionPrevBtn = document.getElementById('selection-prev-btn');
    const selectionNextBtn = document.getElementById('selection-next-btn');
    if(selectionPrevBtn) {
      // 아이디어 선정 페이지는 항상 이전 페이지로 이동 가능
      selectionPrevBtn.disabled = false;
      selectionPrevBtn.style.opacity = '1';
      selectionPrevBtn.style.cursor = 'pointer';
    }
    if(selectionNextBtn) {
      // 아이디어 선정 페이지는 항상 다음 페이지로 이동 가능
      selectionNextBtn.disabled = false;
      selectionNextBtn.style.opacity = '1';
      selectionNextBtn.style.cursor = 'pointer';
      selectionNextBtn.onclick = () => goToNextPage('selection');
    }
  }
  
  // === 마이크로비트 닥터 관련 함수 ===
  
  // STEP 1 사용 가능 여부 확인
  function checkStep1Availability() {
    const step1Section = document.getElementById('step1-section');
    const step1Overlay = document.getElementById('step1-overlay');
    if(!step1Section || !step1Overlay) return;
    
    // Trig와 Echo가 같은 핀인지 확인
    const isSamePin = (pinInfo.trig !== null && pinInfo.trig !== undefined && 
                       pinInfo.echo !== null && pinInfo.echo !== undefined && 
                       pinInfo.trig === pinInfo.echo);
    
    if(isSamePin) {
      step1Overlay.style.display = 'flex';
      step1Section.style.opacity = '0.6';
      step1Section.style.pointerEvents = 'none';
    } else {
      step1Overlay.style.display = 'none';
      step1Section.style.opacity = '1';
      step1Section.style.pointerEvents = 'auto';
    }
  }
  
  // 전역 변수
  let pinInfo = { trig: null, echo: null };
  let port, reader, keepReading = false;
  let simCanvas = null;
  let simCtx = null;
  let feedbackEl = null;
  let isDragging = false;
  let startPin = null;
  let currentMousePos = { x: 0, y: 0 };
  let connections = [];
  let chart = null;
  
  // 마이크로비트 닥터 초기화
  function initMicrobitDoctor() {
    // 사용자 정보 표시
    if(currentUser && currentUser.name) {
      const userDisplay = document.getElementById('doctor-user-display');
      if(userDisplay) {
        userDisplay.textContent = currentUser.name;
      }
    }
    
    // 차트 초기화
    const ctx = document.getElementById('sensorChart');
    if(ctx && !chart) {
      chart = new Chart(ctx.getContext('2d'), {
        type: 'line',
        data: {
          labels: Array(20).fill(''),
          datasets: [{
            data: Array(20).fill(null),
            borderColor: '#8b5cf6',
            borderWidth: 2,
            pointRadius: 0,
            tension: 0.4
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { display: false } },
          scales: {
            x: {
              display: true,
              grid: { color: 'rgba(139, 92, 246, 0.1)' },
              ticks: { color: '#64748b', font: { size: 10 } }
            },
            y: {
              display: true,
              min: 0,
              max: 200,
              grid: { color: 'rgba(139, 92, 246, 0.1)' },
              ticks: { color: '#64748b', font: { size: 10 } },
              title: {
                display: true,
                text: '거리 (cm)',
                color: '#64748b',
                font: { size: 12 }
              }
            }
          }
        }
      });
    }
    
    // 시뮬레이터 초기화
    setTimeout(() => {
      simCanvas = document.getElementById('simCanvas');
      if(simCanvas) {
        if(!simCtx) {
          simCtx = simCanvas.getContext('2d');
          feedbackEl = document.getElementById('simulator-feedback-msg');
          
          // 이벤트 리스너 등록
          simCanvas.addEventListener('mousedown', handleStart);
          simCanvas.addEventListener('mousemove', handleMove);
          simCanvas.addEventListener('mouseup', handleEnd);
          simCanvas.addEventListener('touchstart', (e) => handleStart(e.touches[0]));
          simCanvas.addEventListener('touchmove', (e) => { e.preventDefault(); handleMove(e.touches[0]); });
          simCanvas.addEventListener('touchend', handleEnd);
        }
        
        // STEP 0에서 추출한 핀 정보 확인 및 안내 메시지 표시
        // 핀 번호가 0일 수 있으므로 명시적으로 null/undefined 체크
        if((pinInfo.trig !== null && pinInfo.trig !== undefined) && (pinInfo.echo !== null && pinInfo.echo !== undefined)) {
          // 같은 핀인지 확인
          const isSamePin = pinInfo.trig === pinInfo.echo;
          if(feedbackEl) {
            if(isSamePin) {
              feedbackEl.innerHTML = `❌ 오류: Trig와 Echo가 같은 핀(P${pinInfo.trig})입니다. STEP 0에서 코드를 수정해주세요!`;
              feedbackEl.style.color = "#ef4444";
            } else {
              feedbackEl.innerHTML = `✅ STEP 0에서 핀 번호를 찾았어요! Trig: P${pinInfo.trig}, Echo: P${pinInfo.echo}에 연결해주세요.`;
              feedbackEl.style.color = "#8b5cf6";
            }
          }
        } else {
          if(feedbackEl) {
            feedbackEl.innerHTML = `⚠️ STEP 0에서 코드를 먼저 분석하여 핀 번호를 추출해주세요!`;
            feedbackEl.style.color = "#f59e0b";
          }
        }
        
        // STEP 1 사용 가능 여부 확인
        checkStep1Availability();
        
        // 초기 그리기
        drawSimulator();
      }
    }, 100);
    
    // 드래그 앤 드롭 지원
    const uploadArea = document.getElementById('blockCodeUploadArea');
    if(uploadArea) {
      uploadArea.addEventListener('dragover', function(e) {
        e.preventDefault();
        uploadArea.classList.add('dragover');
      });
      uploadArea.addEventListener('dragleave', function() {
        uploadArea.classList.remove('dragover');
      });
      uploadArea.addEventListener('drop', function(e) {
        e.preventDefault();
        uploadArea.classList.remove('dragover');
        const file = e.dataTransfer.files[0];
        if(file && file.type.startsWith('image/')) {
          const input = document.getElementById('blockCodeInput');
          const dataTransfer = new DataTransfer();
          dataTransfer.items.add(file);
          input.files = dataTransfer.files;
          handleBlockCodeImage({ target: input });
        }
      });
    }
  }
  
  // STEP 0: 블록 코드 OCR 분석
  function handleBlockCodeImage(event) {
    const file = event.target.files[0];
    if(!file) return;
    const reader = new FileReader();
    reader.onload = function(e) {
      const preview = document.getElementById('blockCodePreview');
      if(preview) {
        preview.src = e.target.result;
        preview.style.display = 'block';
      }
      runOCR(file);
    };
    reader.readAsDataURL(file);
  }
  
  async function runOCR(file) {
    const statusDiv = document.getElementById('ocrStatus');
    const resultArea = document.getElementById('ocrResults');
    if(!statusDiv || !resultArea) return;
    
    resultArea.innerHTML = '';
    statusDiv.innerHTML = '<div class="loader"></div> 🔍 코드를 읽고 있어요... (잠시만 기다려주세요)';
    
    const apiKey = getApiKey();
    if(!apiKey) {
      statusDiv.innerHTML = '⚠️ OpenAI API 키가 설정되지 않았습니다. GPT Vision API를 사용하려면 API 키가 필요합니다.';
      resultArea.innerHTML = '<div class="ocr-result-box ocr-warning">API 키를 설정하면 더 정확한 코드 분석이 가능합니다.</div>';
      return;
    }
    
    try {
      // 이미지를 base64로 변환
      const base64Image = await new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => {
          const base64 = reader.result.split(',')[1];
          resolve(base64);
        };
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });
      
      // GPT Vision API 호출
      const response = await fetch('https://api.openai.com/v1/chat/completions', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${apiKey}`
        },
        body: JSON.stringify({
          model: 'gpt-4o-mini',
          messages: [
            {
              role: 'system',
              content: 'You are an expert at analyzing block-based programming code. Extract pin numbers (Trig and Echo) from the code image and return only JSON format.'
            },
            {
              role: 'user',
              content: [
                {
                  type: 'text',
                  text: `이 블록 코드 이미지를 분석해서 초음파 센서의 Trig와 Echo 핀 번호를 찾아주세요.

중요: OCR 오류로 "P0"가 "80"으로 인식될 수 있습니다. "ping trig 80"은 실제로 "ping trig P0"를 의미합니다.
"80", "81", "82" 등은 각각 "P0", "P1", "P2"로 해석해주세요.

다음 JSON 형식으로만 응답하세요:
{
  "trigPin": 핀번호(숫자만, 예: 0, 1, 2) 또는 null,
  "echoPin": 핀번호(숫자만, 예: 0, 1, 2) 또는 null,
  "foundPins": [발견된 모든 핀 번호 배열(숫자만)],
  "codeText": "코드에서 읽은 모든 텍스트"
}

핀 번호 찾기 규칙:
- "ping trig P0" 또는 "ping trig 80" → trigPin: 0
- "trig P1" 또는 "trig 81" → trigPin: 1
- "echo P2" 또는 "echo 82" → echoPin: 2
- "80", "81", "82" 등은 각각 0, 1, 2로 변환

코드 텍스트를 모두 추출해서 정확히 분석해주세요.`
                },
                {
                  type: 'image_url',
                  image_url: {
                    url: `data:image/jpeg;base64,${base64Image}`
                  }
                }
              ]
            }
          ],
          max_tokens: 500
        })
      });
      
      if(!response.ok) {
        throw new Error(`API 오류: ${response.status}`);
      }
      
      const result = await response.json();
      const content = result.choices[0].message.content.trim();
      
      // JSON 파싱
      let analysisResult;
      try {
        const jsonMatch = content.match(/\{[\s\S]*\}/);
        if(jsonMatch) {
          analysisResult = JSON.parse(jsonMatch[0]);
        } else {
          analysisResult = JSON.parse(content);
        }
      } catch(e) {
        console.error('JSON 파싱 오류:', e, content);
        throw new Error('GPT 응답을 파싱할 수 없습니다.');
      }
      
      console.log("GPT 분석 결과:", analysisResult);
      statusDiv.innerHTML = '✅ 분석 완료!';
      
      // OCR 결과 영역 숨기기 (AI 피드백만 표시)
      resultArea.innerHTML = '';
      resultArea.style.display = 'none';
      
      // 분석 결과 처리
      let trigPinFound = false;
      let echoPinFound = false;
      
      // trigPin과 echoPin 추출 (다양한 형식 지원)
      if(analysisResult.trigPin !== null && analysisResult.trigPin !== undefined) {
        let trigPin = analysisResult.trigPin;
        // 문자열에서 숫자만 추출 (예: "P0" -> 0, "0" -> 0, "80" -> 0)
        if(typeof trigPin === 'string') {
          trigPin = trigPin.replace(/[^0-9]/g, '');
          if(trigPin.length >= 2 && trigPin.startsWith('8')) {
            trigPin = trigPin.slice(-1); // "80" -> "0"
          }
        }
        const pinNum = parseInt(trigPin);
        if(!isNaN(pinNum) && pinNum >= 0 && pinNum <= 19) {
          pinInfo.trig = pinNum;
          trigPinFound = true;
        }
      }
      
      if(analysisResult.echoPin !== null && analysisResult.echoPin !== undefined) {
        let echoPin = analysisResult.echoPin;
        // 문자열에서 숫자만 추출
        if(typeof echoPin === 'string') {
          echoPin = echoPin.replace(/[^0-9]/g, '');
          if(echoPin.length >= 2 && echoPin.startsWith('8')) {
            echoPin = echoPin.slice(-1); // "80" -> "0"
          }
        }
        const pinNum = parseInt(echoPin);
        if(!isNaN(pinNum) && pinNum >= 0 && pinNum <= 19) {
          pinInfo.echo = pinNum;
          echoPinFound = true;
        }
      }
      
      // foundPins에서도 추출 시도
      if(!trigPinFound || !echoPinFound) {
        const foundPins = analysisResult.foundPins || [];
        if(foundPins.length > 0) {
          for(let pin of foundPins) {
            let pinNum = pin;
            if(typeof pin === 'string') {
              pinNum = pin.replace(/[^0-9]/g, '');
              if(pinNum.length >= 2 && pinNum.startsWith('8')) {
                pinNum = parseInt(pinNum.slice(-1));
              } else {
                pinNum = parseInt(pinNum);
              }
            }
            if(!isNaN(pinNum) && pinNum >= 0 && pinNum <= 19) {
              if(!trigPinFound) {
                pinInfo.trig = pinNum;
                trigPinFound = true;
              } else if(!echoPinFound && pinNum !== pinInfo.trig) {
                pinInfo.echo = pinNum;
                echoPinFound = true;
              }
            }
          }
        }
      }
      
      // codeText에서 직접 추출 시도 ("ping trig 80" -> P0)
      if(!trigPinFound || !echoPinFound) {
        const codeText = analysisResult.codeText || '';
        // "ping trig 80" 또는 "trig 80" 패턴 찾기
        const trigMatch = codeText.match(/(?:ping\s*)?trig\s*(?:P\s*)?(\d{1,2})/i);
        if(trigMatch && !trigPinFound) {
          let pinNum = parseInt(trigMatch[1]);
          if(pinNum >= 80 && pinNum <= 89) pinNum = pinNum % 10;
          if(pinNum >= 0 && pinNum <= 19) {
            pinInfo.trig = pinNum;
            trigPinFound = true;
          }
        }
        // "echo 80" 또는 "echo P0" 패턴 찾기
        const echoMatch = codeText.match(/echo\s*(?:P\s*)?(\d{1,2})/i);
        if(echoMatch && !echoPinFound) {
          let pinNum = parseInt(echoMatch[1]);
          if(pinNum >= 80 && pinNum <= 89) pinNum = pinNum % 10;
          if(pinNum >= 0 && pinNum <= 19) {
            pinInfo.echo = pinNum;
            echoPinFound = true;
          }
        }
      }
      
      // 핀 번호를 찾았으면 시뮬레이터 업데이트
      if(trigPinFound && echoPinFound) {
        // STEP 1 피드백 메시지 업데이트
        const feedbackEl = document.getElementById('simulator-feedback-msg');
        if(feedbackEl) {
          feedbackEl.innerHTML = `✅ STEP 0에서 핀 번호를 찾았어요! Trig: P${pinInfo.trig}, Echo: P${pinInfo.echo}에 연결해주세요.`;
          feedbackEl.style.color = "#8b5cf6";
        }
        
        if(typeof drawSimulator === 'function') {
          drawSimulator();
        }
      }
      
      // AI 피드백 요청 (OCR 결과 경고 메시지 없이 바로 피드백 표시)
      const codeText = analysisResult.codeText || '';
      const foundPins = analysisResult.foundPins || [];
      requestAICodeFeedback(codeText, pinInfo.trig, pinInfo.echo, foundPins);
      
    } catch(error) {
      console.error(error);
      statusDiv.innerHTML = '❌ 코드 분석 중 오류가 발생했습니다.';
      resultArea.innerHTML = `<div class="ocr-result-box ocr-error">
        ❌ 오류: ${error.message}<br>
        API 키가 올바르게 설정되어 있는지 확인해주세요.
      </div>`;
    }
  }
  
  function analyzeBlockCodeLogic(ocrText) {
    const text = ocrText;
    const resultArea = document.getElementById('ocrResults');
    if(!resultArea) return;
    
    let errors = [];
    let warnings = [];
    
    // OCR 오류 보정: "80"을 "P0"로, "81"을 "P1"로 등 변환
    let correctedText = text;
    
    // "ping trig 80" -> "ping trig P0" 같은 패턴 보정
    // "80", "81", "82" 등을 "P0", "P1", "P2"로 변환 (OCR이 P를 8로 잘못 인식하는 경우)
    correctedText = correctedText.replace(/(ping\s*trig|trig)\s*([8][0-9]|[0-9]{1,2})/gi, (match, prefix, num) => {
      let pinNum = parseInt(num);
      // 80-89는 P0-P9로 변환 (OCR 오류 보정)
      if(pinNum >= 80 && pinNum <= 89) {
        return prefix + ' P' + (pinNum % 10);
      }
      // 0-19는 P0-P19로 변환
      if(pinNum >= 0 && pinNum <= 19) {
        return prefix + ' P' + pinNum;
      }
      return match;
    });
    
    // "echo 80" -> "echo P0" 같은 패턴 보정
    correctedText = correctedText.replace(/echo\s*([8][0-9]|[0-9]{1,2})/gi, (match, num) => {
      let pinNum = parseInt(num);
      // 80-89는 P0-P9로 변환
      if(pinNum >= 80 && pinNum <= 89) {
        return match.replace(num, 'P' + (pinNum % 10));
      }
      // 0-19는 P0-P19로 변환
      if(pinNum >= 0 && pinNum <= 19) {
        return match.replace(num, 'P' + pinNum);
      }
      return match;
    });
    
    // 단독으로 나타나는 "80", "81" 등을 "P0", "P1"로 변환 (컨텍스트가 없는 경우)
    correctedText = correctedText.replace(/\b([8][0-9])\b/g, (match, num) => {
      let pinNum = parseInt(num);
      if(pinNum >= 80 && pinNum <= 89) {
        return 'P' + (pinNum % 10);
      }
      return match;
    });
    
    // 핀 번호 패턴 매칭 (P + 숫자)
    const pinPattern = /P\s*(\d+)/gi;
    const allPins = [];
    let match;
    while((match = pinPattern.exec(correctedText)) !== null) {
      const pinNum = match[1];
      allPins.push(parseInt(pinNum));
    }
    
    // 컨텍스트 기반 핀 번호 추출: "ping trig" 또는 "trig" 다음의 숫자
    const trigContextPatterns = [
      /ping\s*trig\s*(\d{1,2})/gi,
      /trig\s*(\d{1,2})/gi,
      /ping\s*trig\s*P\s*(\d+)/gi,
      /trig\s*P\s*(\d+)/gi
    ];
    trigContextPatterns.forEach(pattern => {
      const matches = [...correctedText.matchAll(pattern)];
      matches.forEach(m => {
        if(m[1]) allPins.push(parseInt(m[1]));
      });
    });
    
    // "echo" 다음의 숫자
    const echoContextPatterns = [
      /echo\s*(\d{1,2})/gi,
      /echo\s*P\s*(\d+)/gi
    ];
    echoContextPatterns.forEach(pattern => {
      const matches = [...correctedText.matchAll(pattern)];
      matches.forEach(m => {
        if(m[1]) allPins.push(parseInt(m[1]));
      });
    });
    
    const uniquePins = [...new Set(allPins)].sort((a, b) => a - b);
    
    console.log("원본 OCR 텍스트:", text);
    console.log("보정된 텍스트:", correctedText);
    console.log("추출된 핀 번호:", uniquePins);
    
    if(uniquePins.length >= 1) {
      const trigPatterns = [
        /ping\s*trig\s*P\s*(\d+)/i,
        /ping\s*trig\s*(\d{1,2})/i, // P 없이 숫자만
        /trig\s*P\s*(\d+)/i,
        /trig\s*(\d{1,2})/i, // P 없이 숫자만
        /P\s*(\d+)[\s\S]{0,30}?trig/i,
        /trig[\s\S]{0,30}?P\s*(\d+)/i
      ];
      const echoPatterns = [
        /echo\s*P\s*(\d+)/i,
        /echo\s*(\d{1,2})/i, // P 없이 숫자만
        /P\s*(\d+)[\s\S]{0,30}?echo/i,
        /echo[\s\S]{0,30}?P\s*(\d+)/i
      ];
      
      let trigPin = null;
      let echoPin = null;
      
      // 보정된 텍스트와 원본 텍스트 모두 검색
      const searchTexts = [correctedText, text];
      
      for(const searchText of searchTexts) {
        for(const pattern of trigPatterns) {
          const match = searchText.match(pattern);
          if(match && match[1]) {
            let pinNum = parseInt(match[1]);
            // "80" -> "0"으로 변환 (OCR 오류 보정: P를 8로 잘못 인식)
            if(pinNum >= 80 && pinNum <= 89) {
              pinNum = pinNum % 10;
            }
            // 0-19 범위만 유효한 핀 번호
            if(pinNum >= 0 && pinNum <= 19) {
              trigPin = pinNum;
              break;
            }
          }
        }
        if(trigPin !== null) break;
      }
      
      for(const searchText of searchTexts) {
        for(const pattern of echoPatterns) {
          const match = searchText.match(pattern);
          if(match && match[1]) {
            let pinNum = parseInt(match[1]);
            // "80" -> "0"으로 변환 (OCR 오류 보정: P를 8로 잘못 인식)
            if(pinNum >= 80 && pinNum <= 89) {
              pinNum = pinNum % 10;
            }
            // 0-19 범위만 유효한 핀 번호
            if(pinNum >= 0 && pinNum <= 19) {
              echoPin = pinNum;
              break;
            }
          }
        }
        if(echoPin !== null) break;
      }
      
      // 컨텍스트 기반 직접 추출 (더 정확한 방법)
      // "ping trig" 다음에 오는 숫자 찾기
      const trigDirectMatch = correctedText.match(/(?:ping\s*)?trig\s*(?:P\s*)?(\d{1,2})/i) || text.match(/(?:ping\s*)?trig\s*(?:P\s*)?(\d{1,2})/i);
      if(trigDirectMatch && trigDirectMatch[1]) {
        let pinNum = parseInt(trigDirectMatch[1]);
        if(pinNum >= 80 && pinNum <= 89) pinNum = pinNum % 10;
        if(pinNum >= 0 && pinNum <= 19) trigPin = pinNum;
      }
      
      // "echo" 다음에 오는 숫자 찾기
      const echoDirectMatch = correctedText.match(/echo\s*(?:P\s*)?(\d{1,2})/i) || text.match(/echo\s*(?:P\s*)?(\d{1,2})/i);
      if(echoDirectMatch && echoDirectMatch[1]) {
        let pinNum = parseInt(echoDirectMatch[1]);
        if(pinNum >= 80 && pinNum <= 89) pinNum = pinNum % 10;
        if(pinNum >= 0 && pinNum <= 19) echoPin = pinNum;
      }
      
      // 여전히 찾지 못했으면 발견된 핀 번호 사용
      if(!trigPin && uniquePins.length >= 1) {
        trigPin = uniquePins[0];
      }
      if(!echoPin && uniquePins.length >= 2) {
        echoPin = uniquePins[1];
      } else if(!echoPin && uniquePins.length >= 1) {
        echoPin = uniquePins[0];
      }
      
      if(trigPin !== null && echoPin !== null) {
        pinInfo.trig = trigPin;
        pinInfo.echo = echoPin;
        
        if(typeof drawSimulator === 'function') {
          drawSimulator();
        }
      } else {
        warnings.push(`⚠️ <strong>핀 번호를 찾았지만 Trig/Echo를 구분하지 못했어요.</strong><br>찾은 핀 번호: ${uniquePins.join(', ')}`);
      }
    } else {
      warnings.push(`⚠️ <strong>핀 번호를 찾지 못했어요.</strong><br>코드에서 P0, P1, P2 같은 핀 번호가 보이지 않습니다.<br>OCR 텍스트: ${text.substring(0, 200)}...`);
    }
    
    // OCR 결과 경고 메시지 표시하지 않음 (AI 피드백만 표시)
    resultArea.innerHTML = '';
    resultArea.style.display = 'none';
    
    // AI 피드백 요청
    requestAICodeFeedback(ocrText, pinInfo.trig, pinInfo.echo, uniquePins);
  }
  
  // AI 코드 피드백 요청 함수
  async function requestAICodeFeedback(ocrText, trigPin, echoPin, foundPins) {
    const apiKey = getApiKey();
    if(!apiKey) {
      // API 키가 없으면 피드백 영역 숨기기
      const feedbackArea = document.getElementById('aiFeedbackArea');
      if(feedbackArea) feedbackArea.style.display = 'none';
      return;
    }
    
    const feedbackArea = document.getElementById('aiFeedbackArea');
    const feedbackContent = document.getElementById('aiFeedbackContent');
    if(!feedbackArea || !feedbackContent) return;
    
    // 로딩 표시
    feedbackArea.style.display = 'block';
    feedbackContent.innerHTML = '<div class="loader"></div> AI가 코드를 분석하고 있어요...';
    
    try {
      const prompt = `마이크로비트 초음파 센서 블록 코드를 분석해주세요.

**코드 텍스트:**
${ocrText.substring(0, 500)}

**추출된 핀 정보:**
- Trig 핀: ${trigPin !== null && trigPin !== undefined ? `P${trigPin}` : '찾지 못함'}
- Echo 핀: ${echoPin !== null && echoPin !== undefined ? `P${echoPin}` : '찾지 못함'}

다음 JSON 형식으로만 응답하세요:
{
  "trigPin": ${trigPin !== null && trigPin !== undefined ? trigPin : 'null'},
  "echoPin": ${echoPin !== null && echoPin !== undefined ? echoPin : 'null'},
  "feedback": "코드가 올바르면 '잘했습니다!' 한 단어만. 문제가 있으면 핵심만 한 문장으로 (예: 'Trig와 Echo가 같은 핀입니다' 또는 '핀 번호를 확인해주세요')"
}

핀 번호를 확실하게 확인해서 trigPin과 echoPin에 숫자로만 입력해주세요.
피드백은 매우 간결하게 작성해주세요. 긴 설명은 필요 없습니다.`;

      const response = await fetch('https://api.openai.com/v1/chat/completions', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${apiKey}`
        },
        body: JSON.stringify({
          model: 'gpt-4o-mini',
          messages: [
            {
              role: 'system',
              content: 'You are a helpful coding mentor that provides feedback in JSON format only, without any additional text.'
            },
            {
              role: 'user',
              content: prompt
            }
          ],
          temperature: 0.3,
          max_tokens: 300
        })
      });
      
      if(!response.ok) {
        throw new Error(`API 오류: ${response.status}`);
      }
      
      const result = await response.json();
      const content = result.choices[0].message.content.trim();
      
      // JSON 파싱
      let feedback;
      try {
        const jsonMatch = content.match(/\{[\s\S]*\}/);
        if(jsonMatch) {
          feedback = JSON.parse(jsonMatch[0]);
        } else {
          feedback = JSON.parse(content);
        }
      } catch(e) {
        console.error('JSON 파싱 오류:', e, content);
        feedback = {
          trigPin: trigPin,
          echoPin: echoPin,
          feedback: '코드 분석이 완료되었습니다.'
        };
      }
      
      // 핀 번호 업데이트 (GPT가 더 정확하게 찾았을 수 있음)
      if(feedback.trigPin !== null && feedback.trigPin !== undefined && !isNaN(feedback.trigPin)) {
        pinInfo.trig = parseInt(feedback.trigPin);
      }
      if(feedback.echoPin !== null && feedback.echoPin !== undefined && !isNaN(feedback.echoPin)) {
        pinInfo.echo = parseInt(feedback.echoPin);
      }
      
      if(typeof drawSimulator === 'function') {
        drawSimulator();
      }
      
      // 간단한 피드백 표시
      const finalTrigPin = pinInfo.trig !== null ? pinInfo.trig : (feedback.trigPin !== null ? feedback.trigPin : '?');
      const finalEchoPin = pinInfo.echo !== null ? pinInfo.echo : (feedback.echoPin !== null ? feedback.echoPin : '?');
      
      // Trig와 Echo가 같은 핀인지 확인
      const isSamePin = (finalTrigPin !== '?' && finalEchoPin !== '?' && finalTrigPin === finalEchoPin);
      
      // 피드백 메시지에 오류 표시 추가
      let feedbackMessage = feedback.feedback || '';
      if(isSamePin && !feedbackMessage.includes('오류') && !feedbackMessage.includes('문제') && !feedbackMessage.includes('❌') && !feedbackMessage.includes('⚠️')) {
        feedbackMessage = `❌ 오류: ${feedbackMessage}`;
      }
      
      // 피드백 영역 스타일 결정 (오류가 있으면 빨간색 테두리)
      const borderColor = isSamePin ? '#ef4444' : '#8b5cf6';
      const bgColor = isSamePin ? 'rgba(239, 68, 68, 0.1)' : 'rgba(139, 92, 246, 0.1)';
      const textColor = isSamePin ? '#dc2626' : '#475569';
      
      let feedbackHTML = `<div style="padding: 15px; background: ${bgColor}; border-radius: 8px; border-left: 4px solid ${borderColor};">
        <div style="font-weight: bold; color: #7c3aed; margin-bottom: 10px; font-size: 16px;">
          🔌 핀 연결 정보
        </div>
        <div style="color: #475569; margin-bottom: 12px; font-size: 15px;">
          <strong>Trig 핀:</strong> P${finalTrigPin}<br>
          <strong>Echo 핀:</strong> P${finalEchoPin}
          ${isSamePin ? ' <span style="color: #ef4444; font-weight: bold;">⚠️ 같은 핀!</span>' : ''}
        </div>
        ${feedbackMessage && feedbackMessage.trim() ? `
        <div style="color: ${textColor}; padding-top: 10px; border-top: 1px solid rgba(139, 92, 246, 0.2); font-size: 14px; font-weight: ${isSamePin ? 'bold' : 'normal'};">
          ${feedbackMessage}
        </div>
        ` : ''}
      </div>`;
      
      feedbackContent.innerHTML = feedbackHTML;
      
      // STEP 0에서 오류가 발생하면 STEP 1 비활성화
      checkStep1Availability();
      
    } catch(error) {
      console.error('AI 피드백 오류:', error);
      feedbackContent.innerHTML = `<div style="color: #ef4444;">
        ⚠️ AI 피드백을 불러오는 중 오류가 발생했습니다.<br>
        ${error.message}
      </div>`;
    }
  }
  
  // STEP 1: 연결 시뮬레이터 관련 코드
  const CANVAS_WIDTH = 950;
  const CANVAS_HEIGHT = 550;
  const sensorWidth = 360;
  const sensorHeight = 160;
  const sensorX = (CANVAS_WIDTH - sensorWidth) / 2;
  const sensorY = 50;
  const sensorPinY = sensorY + sensorHeight + 20;
  const centerX = CANVAS_WIDTH / 2;
  const sensorPinGap = 34;
  
  const sensorPins = [
    { name: "VCC", label: "VCC", color: "#e74c3c", x: centerX - sensorPinGap * 1.5, y: sensorPinY, type: "VCC" },
    { name: "Trig", label: "Trig", color: "#f1c40f", x: centerX - sensorPinGap * 0.5, y: sensorPinY, type: "Signal" },
    { name: "Echo", label: "Echo", color: "#f1c40f", x: centerX + sensorPinGap * 0.5, y: sensorPinY, type: "Signal" },
    { name: "GND", label: "GND", color: "#2c3e50", x: centerX + sensorPinGap * 1.5, y: sensorPinY, type: "GND" }
  ];
  
  const boardPins = [];
  const PIN_RADIUS = 7;
  const PIN_GAP = 28;
  const ROW_GAP = 28;
  const startY_Main = sensorPinY + 150;
  const LEFT_HEAD_WIDTH = 0;
  const BLOCK1_WIDTH = 9 * PIN_GAP;
  const BLOCK2_WIDTH = 8 * PIN_GAP;
  const RIGHT_HEAD_WIDTH = 0;
  const GAP_BETWEEN = 60;
  const totalWidth = LEFT_HEAD_WIDTH + GAP_BETWEEN + BLOCK1_WIDTH + GAP_BETWEEN + BLOCK2_WIDTH + GAP_BETWEEN + RIGHT_HEAD_WIDTH;
  const startX = (CANVAS_WIDTH - totalWidth) / 2;
  const startX_LeftHead = startX;
  const labelX_Main = startX_LeftHead + GAP_BETWEEN - 10;
  const startX_Block1 = startX_LeftHead + GAP_BETWEEN;
  const startX_Block2 = startX_Block1 + BLOCK1_WIDTH + GAP_BETWEEN;
  const startX_RightHead = startX_Block2 + BLOCK2_WIDTH + GAP_BETWEEN;
  
  const leftHeadLabels = ["G", "VC", "TX", "RX"];
  const leftHeadTypes = ["GND", "VCC", "Comm", "Comm"];
  const leftHeadColors = ["#2c3e50", "#2c3e50", "#2c3e50", "#2c3e50"];
  const leftHeaderStartY = startY_Main + ROW_GAP - (ROW_GAP * 1.5);
  for(let i=0; i<4; i++) {
    boardPins.push({
      x: startX_LeftHead,
      y: leftHeaderStartY + (i * ROW_GAP),
      type: leftHeadTypes[i],
      label: leftHeadLabels[i],
      color: leftHeadColors[i],
      group: "left_header"
    });
  }
  
  const leftBlockPinNumbers = [0, 1, 2, 3, 4, 5, 6, 7, 10];
  for(let col = 0; col < 9; col++) {
    const pinNum = leftBlockPinNumbers[col];
    boardPins.push({ x: startX_Block1 + col * PIN_GAP, y: startY_Main, type: "Signal", color: "#f1c40f", group: "main_yellow", pinNumber: pinNum });
    boardPins.push({ x: startX_Block1 + col * PIN_GAP, y: startY_Main + ROW_GAP, type: "VCC", color: "#e74c3c", group: "main_yellow" });
    boardPins.push({ x: startX_Block1 + col * PIN_GAP, y: startY_Main + ROW_GAP * 2, type: "GND", color: "#2c3e50", group: "main_yellow" });
  }
  
  const rightBlockPinNumbers = [8, 9, 11, 12, 13, 14, 15, 16];
  for(let col = 0; col < 8; col++) {
    const pinNum = rightBlockPinNumbers[col];
    boardPins.push({ x: startX_Block2 + col * PIN_GAP, y: startY_Main, type: "Signal", color: "#3498db", group: "main_blue", pinNumber: pinNum });
    boardPins.push({ x: startX_Block2 + col * PIN_GAP, y: startY_Main + ROW_GAP, type: "VCC", color: "#e74c3c", group: "main_blue" });
    boardPins.push({ x: startX_Block2 + col * PIN_GAP, y: startY_Main + ROW_GAP * 2, type: "GND", color: "#2c3e50", group: "main_blue" });
  }
  
  const rightHeadLabels = ["G", "VC", "TX", "NC"];
  const rightHeadTypes = ["GND", "VCC", "Comm", "Comm"];
  const rightHeadColors = ["#2c3e50", "#2c3e50", "#2c3e50", "#2c3e50"];
  const rightHeaderStartY = startY_Main + ROW_GAP - (ROW_GAP * 1.5);
  for(let i=0; i<4; i++) {
    boardPins.push({
      x: startX_RightHead,
      y: rightHeaderStartY + (i * ROW_GAP),
      type: rightHeadTypes[i],
      label: rightHeadLabels[i],
      color: rightHeadColors[i],
      group: "right_header"
    });
  }
  
  function getMousePos(evt) {
    if(!simCanvas) return { x: 0, y: 0 };
    const rect = simCanvas.getBoundingClientRect();
    const scaleX = simCanvas.width / rect.width;
    const scaleY = simCanvas.height / rect.height;
    return {
      x: (evt.clientX - rect.left) * scaleX,
      y: (evt.clientY - rect.top) * scaleY
    };
  }
  
  function handleStart(evt) {
    const pos = getMousePos(evt);
    for(let pin of sensorPins) {
      const dist = Math.hypot(pos.x - pin.x, pos.y - pin.y);
      if(dist < 20) {
        isDragging = true;
        startPin = pin;
        currentMousePos = pos;
        connections = connections.filter(c => c.startPin.name !== pin.name);
        if(feedbackEl) {
          feedbackEl.textContent = `${pin.name} 핀을 알맞은 곳에 연결하세요.`;
          feedbackEl.style.color = "#1e293b";
        }
        drawSimulator();
        return;
      }
    }
  }
  
  function handleMove(evt) {
    if(!isDragging) return;
    currentMousePos = getMousePos(evt);
    drawSimulator();
  }
  
  function handleEnd(evt) {
    if(!isDragging) return;
    let closestPin = null;
    let minDist = 30;
    for(let bPin of boardPins) {
      const dist = Math.hypot(currentMousePos.x - bPin.x, currentMousePos.y - bPin.y);
      if(dist < minDist) {
        minDist = dist;
        closestPin = bPin;
      }
    }
    if(closestPin) {
      const result = checkWiring(startPin, closestPin);
      connections.push({
        startPin: startPin,
        endPin: closestPin,
        status: result.isCorrect ? 'correct' : 'wrong'
      });
      if(result.isCorrect) {
        if(feedbackEl) {
          feedbackEl.innerHTML = `⭕ <b>정답!</b> ${startPin.name} 연결 성공!`;
          feedbackEl.style.color = "#10b981";
        }
      } else {
        if(feedbackEl) {
          feedbackEl.innerHTML = `❌ <b>주의!</b> ${result.msg}`;
          feedbackEl.style.color = "#ef4444";
        }
      }
      validateAllConnections();
    } else {
      if(feedbackEl) {
        feedbackEl.textContent = "연결이 취소되었습니다. 핀 가까이 놓아보세요.";
        feedbackEl.style.color = "#64748b";
      }
    }
    isDragging = false;
    startPin = null;
    drawSimulator();
  }
  
  function validateAllConnections() {
    const trigConn = connections.find(c => c.startPin.name === "Trig");
    const echoConn = connections.find(c => c.startPin.name === "Echo");
    const vccConn = connections.find(c => c.startPin.name === "VCC");
    const gndConn = connections.find(c => c.startPin.name === "GND");
    const vccCorrect = vccConn && vccConn.status === 'correct' && vccConn.endPin.group === "right_header" && vccConn.endPin.label === "VC";
    const gndCorrect = gndConn && gndConn.status === 'correct' && gndConn.endPin.group === "right_header" && gndConn.endPin.label === "G";
    let trigCorrect = true;
    let echoCorrect = true;
    // 핀 번호가 0일 수 있으므로 명시적으로 null/undefined 체크
    if((pinInfo.trig !== null && pinInfo.trig !== undefined) && (pinInfo.echo !== null && pinInfo.echo !== undefined)) {
      trigCorrect = trigConn && trigConn.status === 'correct' && trigConn.endPin.pinNumber === parseInt(pinInfo.trig);
      echoCorrect = echoConn && echoConn.status === 'correct' && echoConn.endPin.pinNumber === parseInt(pinInfo.echo);
    } else {
      trigCorrect = trigConn && trigConn.status === 'correct';
      echoCorrect = echoConn && echoConn.status === 'correct';
    }
    if(trigConn && echoConn && vccConn && gndConn) {
      if(trigCorrect && echoCorrect && vccCorrect && gndCorrect) {
        setTimeout(() => {
          if(feedbackEl) {
            // 핀 번호가 0일 수 있으므로 명시적으로 체크
            const pinInfoText = ((pinInfo.trig !== null && pinInfo.trig !== undefined) && (pinInfo.echo !== null && pinInfo.echo !== undefined)) ? `<br>Trig: P${pinInfo.trig}, Echo: P${pinInfo.echo}` : '';
            feedbackEl.innerHTML = `🎉 <b>완벽해요!</b> 모든 핀이 올바르게 연결되었습니다!${pinInfoText}`;
            feedbackEl.style.color = "#10b981";
          }
        }, 500);
      } else {
        const errors = [];
        // 핀 번호가 0일 수 있으므로 명시적으로 null/undefined 체크
        if((pinInfo.trig !== null && pinInfo.trig !== undefined) && (pinInfo.echo !== null && pinInfo.echo !== undefined)) {
          if(!trigCorrect) {
            const currentPin = trigConn && trigConn.endPin.pinNumber !== undefined ? trigConn.endPin.pinNumber : '연결 안됨';
            errors.push(`Trig는 노란색(S) 핀 P${pinInfo.trig}에 연결해야 해요 (현재: ${currentPin !== '연결 안됨' ? 'P' + currentPin : currentPin})`);
          }
          if(!echoCorrect) {
            const currentPin = echoConn && echoConn.endPin.pinNumber !== undefined ? echoConn.endPin.pinNumber : '연결 안됨';
            errors.push(`Echo는 노란색(S) 핀 P${pinInfo.echo}에 연결해야 해요 (현재: ${currentPin !== '연결 안됨' ? 'P' + currentPin : currentPin})`);
          }
        } else {
          if(!trigCorrect) errors.push(`Trig는 노란색(S) 핀에 연결해야 해요`);
          if(!echoCorrect) errors.push(`Echo는 노란색(S) 핀에 연결해야 해요`);
        }
        if(!vccCorrect) errors.push(`VCC는 확장보드 우측 VC에 연결해야 해요`);
        if(!gndCorrect) errors.push(`GND는 확장보드 우측 G에 연결해야 해요`);
        setTimeout(() => {
          if(feedbackEl) {
            feedbackEl.innerHTML = `⚠️ <b>연결 확인 필요:</b><br>${errors.join('<br>')}`;
            feedbackEl.style.color = "#ef4444";
          }
        }, 500);
      }
    }
  }
  
  function checkWiring(source, target) {
    if(source.type === "GND") {
      if(target.type === "GND" && target.group === "right_header" && target.label === "G") {
        return { isCorrect: true };
      }
      if(target.type === "GND" && target.group === "left_header") {
        return { isCorrect: false, msg: "❌ GND는 확장보드 우측 G에 연결해야 해요! (좌측이 아닙니다)" };
      }
      return { isCorrect: false, msg: "GND는 확장보드 우측 G 핀에 연결해야 해요." };
    }
    if(source.type === "VCC") {
      if(target.type === "VCC" && target.group === "right_header" && target.label === "VC") {
        return { isCorrect: true };
      }
      if(target.type === "VCC" && target.group === "left_header") {
        return { isCorrect: false, msg: "❌ VCC는 확장보드 우측 VC에 연결해야 해요! (좌측이 아닙니다)" };
      }
      return { isCorrect: false, msg: "VCC는 확장보드 우측 VC 핀에 연결해야 해요." };
    }
    if(source.type === "Signal") {
      // 노란색 핀(S 핀)에만 연결 가능
      if(target.type !== "Signal") {
        if(target.type === "Comm") return { isCorrect: false, msg: "이 핀은 통신용(TX/RX)입니다. 번호가 있는 노란색(S) 핀을 쓰세요." };
        return { isCorrect: false, msg: "신호선은 노란색(S) 핀에 연결하세요." };
      }
      
      // 핀 번호가 없는 Signal 핀은 허용하지 않음
      if(target.pinNumber === undefined || target.pinNumber === null) {
        return { isCorrect: false, msg: "번호가 있는 노란색(S) 핀에 연결하세요." };
      }
      
      // STEP 0에서 추출한 핀 정보 확인 (핀 번호가 0일 수 있으므로 명시적으로 체크)
      if((pinInfo.trig === null || pinInfo.trig === undefined) || (pinInfo.echo === null || pinInfo.echo === undefined)) {
        return { isCorrect: false, msg: "⚠️ STEP 0에서 코드를 분석하여 Trig와 Echo 핀 번호를 먼저 추출해주세요!" };
      }
      
      const targetPinNum = target.pinNumber;
      
      // Trig 핀 검증
      if(source.name === "Trig") {
        if(targetPinNum === parseInt(pinInfo.trig)) {
          return { isCorrect: true };
        } else {
          return { isCorrect: false, msg: `❌ Trig는 노란색(S) 핀 P${pinInfo.trig}에 연결해야 해요! (현재: P${targetPinNum})` };
        }
      }
      
      // Echo 핀 검증
      if(source.name === "Echo") {
        if(targetPinNum === parseInt(pinInfo.echo)) {
          return { isCorrect: true };
        } else {
          return { isCorrect: false, msg: `❌ Echo는 노란색(S) 핀 P${pinInfo.echo}에 연결해야 해요! (현재: P${targetPinNum})` };
        }
      }
      
      // 다른 Signal 핀은 허용하지 않음
      return { isCorrect: false, msg: "Trig 또는 Echo 핀만 연결할 수 있습니다." };
    }
    return { isCorrect: false, msg: "잘못된 연결입니다." };
  }
  
  function drawSimulator() {
    if(!simCanvas || !simCtx) return;
    simCtx.clearRect(0, 0, simCanvas.width, simCanvas.height);
    drawSensor();
    drawBoardPins();
    drawConnections();
    if(isDragging && startPin) {
      drawWire(startPin.x, startPin.y, currentMousePos.x, currentMousePos.y, startPin.color, true);
    }
  }
  
  function drawSensor() {
    const x = sensorX;
    const y = sensorY;
    const w = sensorWidth;
    const h = sensorHeight;
    if(!simCtx.roundRect) {
      simCtx.roundRect = function(x, y, w, h, r) {
        this.moveTo(x + r, y);
        this.lineTo(x + w - r, y);
        this.quadraticCurveTo(x + w, y, x + w, y + r);
        this.lineTo(x + w, y + h - r);
        this.quadraticCurveTo(x + w, y + h, x + w - r, y + h);
        this.lineTo(x + r, y + h);
        this.quadraticCurveTo(x, y + h, x, y + h - r);
        this.lineTo(x, y + r);
        this.quadraticCurveTo(x, y, x + r, y);
      };
    }
    simCtx.fillStyle = "#3e60a0";
    simCtx.beginPath();
    simCtx.roundRect(x, y, w, h, 20);
    simCtx.fill();
    simCtx.strokeStyle = "#2c4070";
    simCtx.lineWidth = 3;
    simCtx.stroke();
    const eyeR = h * 0.35;
    const eyeY = y + h/2;
    const leftEyeX = x + w * 0.28;
    const rightEyeX = x + w * 0.72;
    drawEye(leftEyeX, eyeY, eyeR);
    drawEye(rightEyeX, eyeY, eyeR);
    simCtx.fillStyle = "#bdc3c7";
    simCtx.beginPath();
    simCtx.ellipse(x + w/2, y + h - 30, 8, 4, 0, 0, Math.PI*2);
    simCtx.fill();
    simCtx.fillStyle = "white";
    simCtx.font = "bold 20px Arial";
    simCtx.textAlign = "center";
    simCtx.fillText("HC-SR04", x + w/2, y + 35);
    sensorPins.forEach(p => {
      simCtx.beginPath();
      simCtx.moveTo(p.x, y + h);
      simCtx.lineTo(p.x, p.y);
      simCtx.strokeStyle = "#95a5a6";
      simCtx.lineWidth = 5;
      simCtx.stroke();
      simCtx.beginPath();
      simCtx.arc(p.x, p.y, 9, 0, Math.PI*2);
      simCtx.fillStyle = "#bdc3c7";
      simCtx.fill();
      simCtx.strokeStyle = "#7f8c8d";
      simCtx.lineWidth = 2;
      simCtx.stroke();
      simCtx.beginPath();
      simCtx.arc(p.x, p.y, 4, 0, Math.PI*2);
      simCtx.fillStyle = "#fff";
      simCtx.fill();
      simCtx.fillStyle = "black";
      simCtx.font = "bold 14px Arial";
      simCtx.lineWidth = 3;
      simCtx.strokeStyle = "white";
      simCtx.strokeText(p.label, p.x, p.y - 15);
      simCtx.fillStyle = "#2c3e50";
      simCtx.fillText(p.label, p.x, p.y - 15);
    });
  }
  
  function drawEye(cx, cy, r) {
    simCtx.beginPath();
    simCtx.arc(cx, cy, r, 0, Math.PI*2);
    simCtx.fillStyle = "#dcdcdc";
    simCtx.fill();
    simCtx.strokeStyle = "#999";
    simCtx.lineWidth = 2;
    simCtx.stroke();
    simCtx.beginPath();
    simCtx.arc(cx, cy, r * 0.75, 0, Math.PI*2);
    simCtx.fillStyle = "#2c3e50";
    simCtx.fill();
    simCtx.fillStyle = "#7f8c8d";
    for(let i=0; i<3; i++){
      for(let j=0; j<3; j++){
        simCtx.beginPath();
        simCtx.arc(cx - 10 + i*10, cy - 10 + j*10, 2, 0, Math.PI*2);
        simCtx.fill();
      }
    }
  }
  
  function drawBoardPins() {
    simCtx.font = "bold 16px Arial";
    simCtx.textAlign = "right";
    simCtx.fillStyle = "#333";
    simCtx.fillText("S", labelX_Main, startY_Main + 5);
    simCtx.fillText("V", labelX_Main, startY_Main + ROW_GAP + 5);
    simCtx.fillText("G", labelX_Main, startY_Main + ROW_GAP * 2 + 5);
    boardPins.forEach(p => {
      simCtx.beginPath();
      simCtx.arc(p.x, p.y, PIN_RADIUS, 0, Math.PI*2);
      simCtx.fillStyle = p.color;
      simCtx.fill();
      simCtx.strokeStyle = p.type === "GND" ? "#fff" : "rgba(0,0,0,0.2)";
      simCtx.lineWidth = 1;
      simCtx.stroke();
      simCtx.beginPath();
      simCtx.arc(p.x - 2, p.y - 2, 2, 0, Math.PI*2);
      simCtx.fillStyle = "rgba(255,255,255,0.4)";
      simCtx.fill();
      if(p.group === "left_header") {
        simCtx.font = "12px Arial";
        simCtx.fillStyle = "#333";
        simCtx.textAlign = "right";
        simCtx.fillText(p.label, p.x - 12, p.y + 4);
      } else if(p.group === "right_header") {
        simCtx.font = "12px Arial";
        simCtx.fillStyle = "#333";
        simCtx.textAlign = "left";
        simCtx.fillText(p.label, p.x + 12, p.y + 4);
      }
      if(p.type === "Signal" && p.pinNumber !== undefined) {
        simCtx.font = "bold 11px Arial";
        simCtx.fillStyle = "#333";
        simCtx.textAlign = "center";
        simCtx.fillText(p.pinNumber.toString(), p.x, p.y - 15);
      }
    });
  }
  
  function drawConnections() {
    connections.forEach(conn => {
      const color = conn.status === 'correct' ? '#10b981' : '#ef4444';
      drawWire(conn.startPin.x, conn.startPin.y, conn.endPin.x, conn.endPin.y, color, false);
      if(conn.status === 'wrong') {
        simCtx.font = "20px Arial";
        simCtx.fillStyle = "red";
        simCtx.textAlign = "center";
        simCtx.fillText("❌", conn.endPin.x, conn.endPin.y - 10);
      }
    });
  }
  
  function drawWire(x1, y1, x2, y2, color, isDashing) {
    simCtx.beginPath();
    simCtx.moveTo(x1, y1);
    const cp1x = x1 + (x2 - x1) * 0.5;
    const cp1y = y1;
    const cp2x = x2 - (x2 - x1) * 0.5;
    const cp2y = y2;
    simCtx.bezierCurveTo(cp1x, cp1y, cp2x, cp2y, x2, y2);
    simCtx.strokeStyle = color;
    simCtx.lineWidth = 5;
    simCtx.lineCap = 'round';
    if(isDashing) simCtx.setLineDash([8, 6]);
    else simCtx.setLineDash([]);
    simCtx.stroke();
    simCtx.setLineDash([]);
    simCtx.beginPath();
    simCtx.arc(x2, y2, 5, 0, Math.PI*2);
    simCtx.fillStyle = color;
    simCtx.fill();
  }
  
  function resetWiring() {
    connections = [];
    if(feedbackEl) {
      feedbackEl.textContent = "다시 시작합니다!";
      feedbackEl.style.color = "#1e293b";
    }
    drawSimulator();
  }
  
  // STEP 2: USB 연결
  async function connectUSB() {
    if(!navigator.serial) return alert("이 브라우저는 지원하지 않습니다 (PC 크롬 사용)");
    try {
      port = await navigator.serial.requestPort();
      await port.open({ baudRate: 115200 });
      keepReading = true;
      readLoop();
      const iconStatus = document.getElementById('icon-status');
      const textStatus = document.getElementById('text-status');
      if(iconStatus) iconStatus.innerText = "🟢";
      if(textStatus) {
        textStatus.innerText = "연결됨";
        textStatus.style.color = "#10b981";
      }
    } catch(e) {
      console.log(e);
      alert("연결 실패: " + e.message);
    }
  }
  
  async function readLoop() {
    const decoder = new TextDecoderStream();
    port.readable.pipeTo(decoder.writable);
    const reader = decoder.readable.getReader();
    let buffer = "";
    while(keepReading) {
      try {
        const { value, done } = await reader.read();
        if(done) break;
        buffer += value;
        let lines = buffer.split('\n');
        buffer = lines.pop() || "";
        for(let line of lines) {
          if(line.trim()) {
            const num = parseInt(line.match(/-?\d+/)?.[0]);
            if(!isNaN(num) && num >= 0 && num < 10000) {
              updateStatus(num);
            }
          }
        }
      } catch(e) { break; }
    }
  }
  
  function updateStatus(val) {
    const textDist = document.getElementById('text-dist');
    const icon = document.getElementById('icon-status');
    const text = document.getElementById('text-status');
    if(textDist) textDist.innerText = val + " cm";
    if(chart) {
      const data = chart.data.datasets[0].data;
      data.shift();
      data.push(val);
      chart.update();
    }
    if(val > 0 && val < 3000) {
      if(icon) icon.innerText = "✅";
      if(text) {
        text.innerText = "정상 작동";
        text.style.color = "#10b981";
      }
      if(chart) chart.data.datasets[0].borderColor = "#10b981";
    } else {
      if(icon) icon.innerText = "⚠️";
      if(text) {
        text.innerText = "점검 필요";
        text.style.color = "#fbbf24";
      }
      if(chart) chart.data.datasets[0].borderColor = "#fbbf24";
    }
  }
  
  showIntro();
</script>
</body>
</html>